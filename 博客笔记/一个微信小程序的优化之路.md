![Image](https://mmbiz.qpic.cn/mmbiz_jpg/qMicvibdvl7p0KEd3bHYcm99nBiclZbia548oyvliaq8PrrmrcyuT3QS3urMcfaXDPEumnHP9KYcMV3Fad5Pepzic81Q/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

 ![Image](https://mmbiz.qpic.cn/mmbiz_gif/qMicvibdvl7p0shmw7MKGyutc63KZyibndlEzXkYJiaS1fUicrkRRKdOhPHMOic2dB36fnECUbaN0h6EJNcYU0HuY49g/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1) 

本文字数：**24677**字

预计阅读时间：**60**分钟

## 一个微信小程序的渐进式优化之路

> ❝
> 
> 来个大的！

## 前言

入职搜狐后我开展的第一个项目就是微信小程序。谈起小程序开发，生态封闭、坑多路滑、开发工具难用等槽点是一定不能被忽视的，因此市面上也涌现了一大批诸如 mpvue、taro 这样的抽象程度更高的小程序开发框架。我负责的这个小程序项目并没有采用这些第三方框架，而是选择在原生技术栈的基础上进行了一系列的优化和定制。

去年 8 月份 (2021.08)，小程序的版本已经来到了 4.0.0。经历了长达一年的渐进式优化，这个小程序项目的开发体验也勉强达到了“好用”的水平，于是我写下了本文并在组内做了技术分享。技术分享后我就想找时间把文章脱敏并公开，结果拖延症发作一直鸽🕊️到了 2022 年。。。今天终于狠下心来重新梳理了这篇万字长文，希望能帮助到需要开发小程序的你。

(加 ⭐️ 表示个人认为收益比较大的优化)

## 我信奉的几条代码哲学

> ❝
> 
> -   谨记代码是给人看的，它们只是恰好能跑而已
>     
> -   健壮的结构远比精巧的设计来得重要。换句话说，结构是第一位的，功能是第二位的。——《大教堂与集市》
>     
> -   保持项目的简单性。设计达到完美的时候，不是无法再增加东西了，而是无法再减少东西了。——《大教堂与集市》
>     

## 开发之前

我已经不接触小程序很久了，但既然要从头做一个还算复杂的小程序，那就要先给自己约法三章。

### 使用原生技术栈，拒绝第三方框架

小程序更新节奏很快，而且不乏各种 Breaking Changes，很多第三方框架不能完美 Follow 这些更新，以至于一些早年间大火的框架到现在都不再维护。而且小程序技术经历几年的更新，已经比刚推出的时候强大很多了，如果没有强烈的跨平台需求，使用原生技术栈或许是更好的选择。

### 全面拥抱 ES6+ 语法；Promisify 所有的 wx API

> ❝
> 
> 注意：从基础库 2.10.2 开始，大部分 API 就已经原生支持返回 Promise，不再需要 wxp 库。详见文档：异步 API 返回 Promise<sup data-darkreader-inline-color="">[1]</sup>。

小程序开发者工具已经支持绝大部分我们日常能使用到的 ES6+ 语法了，并且也支持了目前处理回调最常用的 async await 语法。但官方的 `wx.showLoading` 等 API 都还是只能使用回调，因此开发业务前的第一件事就是让所有的微信 API 支持 Promise 形式调用。

最后我的解决方案是使用了微信官方提供的 wxp 库：API Promise 化<sup data-darkreader-inline-color="">[2]</sup>。

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;utils/wxp.js</span><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;promisifyAll,&nbsp;promisify&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'miniprogram-api-promise'</span>;<br><br><span data-darkreader-inline-color="">const</span>&nbsp;wxp&nbsp;=&nbsp;{};<br>promisifyAll(wx,&nbsp;wxp);<br>promisify(wx.getUserProfile);<br><br><span data-darkreader-inline-color="">export</span>&nbsp;{&nbsp;wxp&nbsp;};<br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;wxp;<br><br><span data-darkreader-inline-color="">//&nbsp;page.js</span><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;wxp&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../../utils/wxp'</span>;<br><br><span data-darkreader-inline-color="">await</span>&nbsp;wxp.showModal({&nbsp;<span data-darkreader-inline-color="">showCancel</span>:&nbsp;<span data-darkreader-inline-color="">false</span>,&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;<span data-darkreader-inline-color="">'提示'</span>,&nbsp;<span data-darkreader-inline-color="">content</span>:&nbsp;errMsg&nbsp;});<br></code>
```

### 拥抱模块化

项目中的公共内容，比如配置、工具函数等，全部按照模块拆分，并借由 ES6 中的模块系统实现复用，而不是一股脑塞进 app.js 中。总之，还是高内聚低耦合，保证全局模块是“薄”的。

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;utils&nbsp;目录收录了各种辅助工具</span><br>├──&nbsp;utils<br>│&nbsp;&nbsp;&nbsp;├──&nbsp;Auth.js<br>│&nbsp;&nbsp;&nbsp;├──&nbsp;event-bus.js<br>│&nbsp;&nbsp;&nbsp;├──&nbsp;helpers.js<br>│&nbsp;&nbsp;&nbsp;├──&nbsp;http.js<br>│&nbsp;&nbsp;&nbsp;├──&nbsp;logger.js<br>│&nbsp;&nbsp;&nbsp;├──&nbsp;md5.js<br>│&nbsp;&nbsp;&nbsp;└──&nbsp;wxp.js<br><br><span data-darkreader-inline-color="">//&nbsp;page.js</span><br><span data-darkreader-inline-color="">//&nbsp;✅</span><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;logger&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../../utils/logger'</span>;<br>logger.log(<span data-darkreader-inline-color="">'...'</span>);<br><br><span data-darkreader-inline-color="">//&nbsp;❌</span><br><span data-darkreader-inline-color="">const</span>&nbsp;app&nbsp;=&nbsp;getApp();<br>app.logger.log(<span data-darkreader-inline-color="">'...'</span>);<br></code>
```

### 确定小程序版本格式

严格遵守 SemVer 规范<sup data-darkreader-inline-color="">[3]</sup>。

-   简介
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">主版本号：当你做了不兼容的 API 修改，<br>次版本号：当你做了向下兼容的功能性新增，<br>修订号：当你做了向下兼容的问题修正。<br></code>
```

### 编写 CHANGELOG

在项目中添加 `CHANGELOG.md`，记录每个版本的更新内容。

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">##&nbsp;3.3.0&nbsp;(2021.08.16)</span><br><span data-darkreader-inline-color=""><br>-&nbsp;</span>A&nbsp;新增&nbsp;积分商城模块<br><span data-darkreader-inline-color="">-&nbsp;</span>I&nbsp;优化&nbsp;分享到朋友圈功能<br><span data-darkreader-inline-color="">-&nbsp;</span>I&nbsp;优化&nbsp;小程序体积，提升小程序打开速度，主包体积缩小&nbsp;42%&nbsp;(950KB&nbsp;减小到&nbsp;549KB)<br><span data-darkreader-inline-color="">-&nbsp;</span>I&nbsp;升级&nbsp;富文本解析器版本<br><span data-darkreader-inline-color="">-&nbsp;</span>F&nbsp;修复&nbsp;首页弹窗的异常样式<br></code>
```

## 使用 Prettier + .editorconfig 进行代码格式化

代码格式化是团队协作开发的基石之一，Editorconfig<sup data-darkreader-inline-color="">[4]</sup> 可以消除不同开发成员因为代码编辑器带来的风格差异；而 Prettier<sup data-darkreader-inline-color="">[5]</sup> 是目前最流行的前端代码格式化工具，我们可以通过添加一些规则使其适用于我们的微信小程序项目。

-   `.editorconfig`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">root&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span><br><br>[*]<br>charset&nbsp;=&nbsp;utf-8<br>end_of_line&nbsp;=&nbsp;lf<br>indent_style&nbsp;=&nbsp;space<br>indent_size&nbsp;=&nbsp;2<br>tab_width&nbsp;=&nbsp;2<br>trim_trailing_whitespace&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span><br>insert_final_newline&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span><br><br>[*.md]<br>trim_trailing_whitespace&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span><br></code>
```

-   `.prettierrc.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">module</span>.exports&nbsp;=&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">singleQuote</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">printWidth</span>:&nbsp;<span data-darkreader-inline-color="">100</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">trailingComma</span>:&nbsp;<span data-darkreader-inline-color="">'none'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">arrowParens</span>:&nbsp;<span data-darkreader-inline-color="">'avoid'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">overrides</span>:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">files</span>:&nbsp;<span data-darkreader-inline-color="">'*.wxml'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">options</span>:&nbsp;{&nbsp;<span data-darkreader-inline-color="">parser</span>:&nbsp;<span data-darkreader-inline-color="">'html'</span>&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">files</span>:&nbsp;<span data-darkreader-inline-color="">'*.wxss'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">options</span>:&nbsp;{&nbsp;<span data-darkreader-inline-color="">parser</span>:&nbsp;<span data-darkreader-inline-color="">'css'</span>&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">files</span>:&nbsp;<span data-darkreader-inline-color="">'*.wxs'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">options</span>:&nbsp;{&nbsp;<span data-darkreader-inline-color="">parser</span>:&nbsp;<span data-darkreader-inline-color="">'babel'</span>,&nbsp;<span data-darkreader-inline-color="">quoteProps</span>:&nbsp;<span data-darkreader-inline-color="">'preserve'</span>&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;]<br>};<br></code>
```

-   `package.json`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">"scripts"</span>:&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">"lint:prettier"</span>:&nbsp;<span data-darkreader-inline-color="">"prettier&nbsp;--loglevel&nbsp;warn&nbsp;--write&nbsp;\"src/**/*.{wxml,wxss,scss,wxs,json,md}\""</span>,<br>},<br></code>
```

## ⭐️ 拆分请求层和接口层，实现接口管理和复用

对 `wx.request` 进行封装，支持：

1.  是否自动开启页面 Loading
    
2.  是否自动显示错误提示
    
3.  自定义错误提示内容
    
4.  是否自动携带 Token
    
5.  添加自定义拦截器
    

-   `utils/http.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;Auth&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'./Auth'</span>;<br><br><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;@param&nbsp;{Boolean}&nbsp;withToken&nbsp;是否在发送请求时附带&nbsp;auth&nbsp;token<br>&nbsp;*&nbsp;@param&nbsp;{Boolean}&nbsp;showLoading&nbsp;是否在发送请求时显示&nbsp;loading<br>&nbsp;*&nbsp;@param&nbsp;{Boolean}&nbsp;showError&nbsp;是否在请求失败时显示异常提示(仅针对&nbsp;success&nbsp;方法)<br>&nbsp;*&nbsp;@param&nbsp;{String}&nbsp;errorMsg&nbsp;默认的错误提示(仅针对&nbsp;success&nbsp;方法)<br>&nbsp;*&nbsp;@param&nbsp;{Function}&nbsp;successInterceptor&nbsp;请求成功时的拦截器，可以自定义后续逻辑<br>&nbsp;*&nbsp;@param&nbsp;{Function}&nbsp;failInterceptor&nbsp;请求失败时的拦截器，可以自定义后续逻辑<br>&nbsp;*<br>&nbsp;*&nbsp;@NOTICE:&nbsp;微信小程序的&nbsp;fail&nbsp;只在请求发送失败时触发，因此对于状态码的判断需要放在&nbsp;success&nbsp;方法里处理<br>&nbsp;*/</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;({<br>&nbsp;&nbsp;withToken&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span>,<br>&nbsp;&nbsp;showLoading&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;loadingMsg&nbsp;=&nbsp;<span data-darkreader-inline-color="">'加载中...'</span>,<br>&nbsp;&nbsp;showError&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;errorMsg&nbsp;=&nbsp;<span data-darkreader-inline-color="">'请求错误，请稍候再试'</span>,<br>&nbsp;&nbsp;...options<br>})&nbsp;=&gt;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;<span data-darkreader-inline-color="">Promise</span>(<span data-darkreader-inline-color="">async</span>&nbsp;(resolve,&nbsp;reject)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(showLoading)&nbsp;wx.showLoading({&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;loadingMsg,&nbsp;<span data-darkreader-inline-color="">mask</span>:&nbsp;<span data-darkreader-inline-color="">true</span>&nbsp;});<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;header&nbsp;=&nbsp;options.header&nbsp;||&nbsp;{&nbsp;<span data-darkreader-inline-color="">'Content-Type'</span>:&nbsp;<span data-darkreader-inline-color="">'application/json'</span>&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(withToken&nbsp;&amp;&amp;&nbsp;Auth.isLogged())&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(Auth.shouldRefreshToken())&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;Auth.refreshToken();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header[<span data-darkreader-inline-color="">'X-SA-AUTH'</span>]&nbsp;=&nbsp;Auth.getToken();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;wx.request({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...options,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">header</span>:&nbsp;<span data-darkreader-inline-color="">Object</span>.assign(header,&nbsp;options[<span data-darkreader-inline-color="">'header'</span>]&nbsp;||&nbsp;{}),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">success</span>:&nbsp;<span><span>res</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(showLoading)&nbsp;wx.hideLoading();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(options.successInterceptor)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.successInterceptor(res,&nbsp;resolve,&nbsp;reject);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;statusCode&nbsp;=&nbsp;+res.statusCode;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(statusCode&nbsp;===&nbsp;<span data-darkreader-inline-color="">200</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resolve(res);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(showError)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;finalMsg;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;404</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(statusCode&nbsp;===&nbsp;<span data-darkreader-inline-color="">404</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finalMsg&nbsp;=&nbsp;<span data-darkreader-inline-color="">'资源不存在'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;500</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(statusCode&nbsp;===&nbsp;<span data-darkreader-inline-color="">500</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finalMsg&nbsp;=&nbsp;<span data-darkreader-inline-color="">'服务器开小差了，请稍候重试'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;429</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(statusCode&nbsp;===&nbsp;<span data-darkreader-inline-color="">429</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finalMsg&nbsp;=&nbsp;<span data-darkreader-inline-color="">'您请求的太频繁了，请稍候重试'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;权限相关</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.data&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.data.code&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'invalid_auth_token'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'auth_token_expired'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'missing_auth_token'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'user_login_status_error'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].includes(res.data.code)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Auth.clearToken();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;msgRelation&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">invalid_auth_token</span>:&nbsp;<span data-darkreader-inline-color="">'登录状态已失效，请重试'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">auth_token_expired</span>:&nbsp;<span data-darkreader-inline-color="">'登录已过期，请重试'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">missing_auth_token</span>:&nbsp;<span data-darkreader-inline-color="">'未能获取到您的登录凭证，请重试'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">user_login_status_error</span>:&nbsp;<span data-darkreader-inline-color="">'登录状态异常，请重试'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finalMsg&nbsp;=&nbsp;res.data.code&nbsp;?&nbsp;msgRelation[res.data.code]&nbsp;:&nbsp;<span data-darkreader-inline-color="">'登录状态异常，请重试'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;其他情况</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finalMsg&nbsp;=&nbsp;errorMsg;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wx.showToast({&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;finalMsg,&nbsp;<span data-darkreader-inline-color="">icon</span>:&nbsp;<span data-darkreader-inline-color="">'none'</span>,&nbsp;<span data-darkreader-inline-color="">duration</span>:&nbsp;<span data-darkreader-inline-color="">1500</span>&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reject(res);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">fail</span>:&nbsp;<span><span>err</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(showLoading)&nbsp;wx.hideLoading();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(options.failInterceptor)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.failInterceptor(err,&nbsp;resolve,&nbsp;reject);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wx.showToast({&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;<span data-darkreader-inline-color="">'请求发送失败，请稍候重试'</span>,&nbsp;<span data-darkreader-inline-color="">icon</span>:&nbsp;<span data-darkreader-inline-color="">'none'</span>,&nbsp;<span data-darkreader-inline-color="">duration</span>:&nbsp;<span data-darkreader-inline-color="">1500</span>&nbsp;});<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reject(err);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;});<br></code>
```

而所有的接口请求都封装成异步方法放置在 api 文件夹下进行统一管理。

-   `api/goods.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;http&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../utils/http'</span>;<br><span data-darkreader-inline-color="">//&nbsp;buildUrl&nbsp;是一个自行实现的，可以根据小程序运行环境自动计算测试环境&nbsp;or&nbsp;正式环境的方法</span><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;buildUrl&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../utils/helpers'</span>;<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;reqFetchGoods&nbsp;=&nbsp;<span>(<span>data,&nbsp;showLoading&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span></span>)&nbsp;=&gt;</span><br>&nbsp;&nbsp;http({<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">url</span>:&nbsp;buildUrl(<span data-darkreader-inline-color="">`/goods`</span>),<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">method</span>:&nbsp;<span data-darkreader-inline-color="">'GET'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;data,<br>&nbsp;&nbsp;&nbsp;&nbsp;showLoading<br>&nbsp;&nbsp;});<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;reqShowGoods&nbsp;=&nbsp;<span>(<span>goodsId,&nbsp;showLoading&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span></span>)&nbsp;=&gt;</span><br>&nbsp;&nbsp;http({<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">url</span>:&nbsp;buildUrl(<span data-darkreader-inline-color="">`/goods/<span data-darkreader-inline-color="">${goodsId}</span>`</span>),<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">method</span>:&nbsp;<span data-darkreader-inline-color="">'GET'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;showLoading<br>&nbsp;&nbsp;});<br></code>
```

## ⭐️ app.js 和 page.js 间的数据交互

进入小程序后，app.js 和 page.js 会同时执行，这就导致假如 page.js 中需要拿到一些 app.js 中的数据时，必须给全局的 `app` 对象添加一个回调，并且在 app.js 中判断是否存在这个回调。小程序开发者工具给出的 Demo 项目中就可以看到使用这种逻辑来在页面中获取用户信息。**但是这种方式非常繁琐，会导致 page.js 和 app.js 中回调满天飞，难以维护。**

而我的解决思路是，在 app.js 中定义统一的回调函数，比如专门用于获取用户信息的 `getUserInfo(cb)` 函数，参数 cb 是页面传入的回调函数。在 app.js 中判断用户信息是否已初始化完毕，如果已完毕则直接执行页面回调；反之则先将 cb 暂存，等待用户信息初始化完毕后统一执行回调。如此一来，我们对于任何需要获取用户信息的需求都可以通过 `app.getUserInfo` 这一个入口解决。

-   `app.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">App({<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">globalData</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">isUserInfoInited</span>:&nbsp;<span data-darkreader-inline-color="">false</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">userInfoListeners</span>:&nbsp;[],<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">isLogged</span>:&nbsp;<span data-darkreader-inline-color="">false</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">userInfo</span>:&nbsp;<span data-darkreader-inline-color="">null</span><br>&nbsp;&nbsp;},<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;onLaunch(options)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.initAppInfo(options);<br>&nbsp;&nbsp;},<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;initUserInfo(reLogin&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;从未走过登录逻辑，或强制要求重新登录</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!Auth.isLoginActionCompleted()&nbsp;||&nbsp;reLogin)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;Auth.login&nbsp;用于获取用户信息并保存在本地</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;Auth.login();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.isLogged&nbsp;=&nbsp;Auth.isLogged();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.userInfo&nbsp;=&nbsp;Auth.getUserInfo();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;执行&nbsp;getUserInfo&nbsp;方法中暂存的回调函数</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.isUserInfoInited&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.userInfoListeners.forEach(<span><span>listener</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listener(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;IAppUserInfo({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">isLogged</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.isLogged,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">userInfo</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.userInfo<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.userInfoListeners&nbsp;=&nbsp;[];<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;getUserInfo(cb)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">this</span>.globalData.isUserInfoInited)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;IAppUserInfo({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">isLogged</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.isLogged,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">userInfo</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.userInfo<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.globalData.userInfoListeners.push(cb);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;getUserInfoAsync()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;<span data-darkreader-inline-color="">Promise</span>(<span><span>resolve</span>&nbsp;=&gt;</span>&nbsp;<span data-darkreader-inline-color="">this</span>.getUserInfo(resolve));<br>&nbsp;&nbsp;}<br>});<br></code>
```

-   `page.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">async</span>&nbsp;onLoad(options)&nbsp;{<br>&nbsp;&nbsp;app.getUserInfo(<span>(<span>{&nbsp;userInfo&nbsp;}</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;此时&nbsp;userInfo&nbsp;一定有值</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.setData({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">userNickname</span>:&nbsp;userInfo.nickname,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">avatar</span>:&nbsp;userInfo.avatar<br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;});<br>},<br></code>
```

> ❝
> 
> 除了在页面内异步获取用户信息这种需求，你还可以用类似的思路把一些变动不频繁的计算放到 app.js 里，比如自定义导航栏的高度、一些用户手机相关的系统信息等，可以显著提高性能。

## 选用 Vant Weapp 替换 WeUI，并编写脚本进行维护

在项目开发初期，我们使用了官方扩展 WeUI 组件库 (主要是使用了 Icon 图标组件)。其优点是微信内置，小程序引入时不会额外增加小程序体积。但后来发现 WeUI 组件库仍不能满足开发需求，调研后决定引入 Vant Weapp<sup data-darkreader-inline-color="">[6]</sup> 组件库替代 WeUI。

我们的项目只需要用到其中一部分组件，比如图标组件 Icon，评分组件 Rate 等，因此我们最好进行按需引入。实现方式也很简单，把 Vant Weapp 编译好的 dist 目录中需要用到的各个组件文件夹直接复制到项目中即可。因此在项目中新建了 `vendor/vant` 文件夹存放需要用到的 Vant 组件。

虽然听起来简单，但实际存在两个问题：

-   如果要按照按需加载的方式，那么我们就不能使用 npm 安装 Vant Weapp，否则编译后小程序会有全量组件，体积过大
    
-   使用的 Vant Weapp 必须版本统一，不能几个月后添加新的组件，和之前添加的组件版本不一致
    

我的解决方案是将 Vant Weapp 的构建产物 dist 目录纳入版本管理，并且编写脚本实现一键更新和发布。我并不擅长 Shell 脚本，因此引入了 shelljs<sup data-darkreader-inline-color="">[7]</sup>, chalk<sup data-darkreader-inline-color="">[8]</sup>, commander.js<sup data-darkreader-inline-color="">[9]</sup> 这三个库辅助我使用 JS 代码编写脚本。

-   `cli/vant-upgrade.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;shell&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'shelljs'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;chalk&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'chalk'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;path&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'path'</span>);<br><br>shell.cd(path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'../'</span>));<br><br><span data-darkreader-inline-color="">//&nbsp;克隆最新版本的&nbsp;vant&nbsp;项目源码</span><br><span data-darkreader-inline-color="">console</span>.log(chalk.blue(<span data-darkreader-inline-color="">`Downloading...`</span>));<br>shell.exec(<span data-darkreader-inline-color="">`git&nbsp;clone&nbsp;https://github.com/youzan/vant-weapp.git&nbsp;vant-source&nbsp;--depth=1`</span>);<br><span data-darkreader-inline-color="">console</span>.log(chalk.green(<span data-darkreader-inline-color="">`Downloaded!`</span>));<br><br><span data-darkreader-inline-color="">//&nbsp;生成新的&nbsp;vant&nbsp;项目文件夹</span><br><span data-darkreader-inline-color="">console</span>.log(chalk.blue(<span data-darkreader-inline-color="">`Migrating...`</span>));<br>shell.rm(<span data-darkreader-inline-color="">'-rf'</span>,&nbsp;<span data-darkreader-inline-color="">'vant'</span>);<br>shell.mv(<span data-darkreader-inline-color="">'vant-source/dist'</span>,&nbsp;<span data-darkreader-inline-color="">'vant'</span>);<br>shell.mv(<span data-darkreader-inline-color="">'vant-source/package.json'</span>,&nbsp;<span data-darkreader-inline-color="">'vant/package.json'</span>);<br>shell.rm(<span data-darkreader-inline-color="">'-rf'</span>,&nbsp;<span data-darkreader-inline-color="">'vant-source'</span>);<br><span data-darkreader-inline-color="">console</span>.log(chalk.green(<span data-darkreader-inline-color="">`Migrated!`</span>));<br><br><span data-darkreader-inline-color="">console</span>.log(chalk.green(<span data-darkreader-inline-color="">`Upgrade&nbsp;Success!&nbsp;Please&nbsp;republish&nbsp;the&nbsp;components&nbsp;you&nbsp;need.`</span>));<br></code>
```

-   `cli/vant-publish.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;shell&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'shelljs'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;chalk&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'chalk'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;Command&nbsp;}&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'commander'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;path&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'path'</span>);<br><br><span data-darkreader-inline-color="">const</span>&nbsp;program&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;Command();<br>program<br>&nbsp;&nbsp;.requiredOption(<span data-darkreader-inline-color="">'-n&nbsp;--folder-names&nbsp;&lt;names...&gt;'</span>,&nbsp;<span data-darkreader-inline-color="">'Component&nbsp;folders&nbsp;you&nbsp;need.'</span>)<br>&nbsp;&nbsp;.parse(process.argv);<br><span data-darkreader-inline-color="">const</span>&nbsp;options&nbsp;=&nbsp;program.opts();<br><span data-darkreader-inline-color="">const</span>&nbsp;folderNames&nbsp;=&nbsp;options.folderNames;<br><br>folderNames.forEach(<span><span>name</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;shell.rm(<span data-darkreader-inline-color="">'-rf'</span>,&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">`../src/vendor/vant/<span data-darkreader-inline-color="">${name}</span>`</span>));<br>&nbsp;&nbsp;shell.cp(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'-R'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">`../vant/<span data-darkreader-inline-color="">${name}</span>`</span>),<br>&nbsp;&nbsp;&nbsp;&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">`../src/vendor/vant/<span data-darkreader-inline-color="">${name}</span>`</span>)<br>&nbsp;&nbsp;);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(chalk.blue(<span data-darkreader-inline-color="">`Component&nbsp;<span data-darkreader-inline-color="">${name}</span>&nbsp;has&nbsp;been&nbsp;published.`</span>));<br>});<br><br><span data-darkreader-inline-color="">console</span>.log(chalk.green(<span data-darkreader-inline-color="">`All&nbsp;components&nbsp;have&nbsp;been&nbsp;published!`</span>));<br></code>
```

-   `package.json`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">"scripts"</span>:&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">"vant:upgrade"</span>:&nbsp;<span data-darkreader-inline-color="">"node&nbsp;cli/vant-upgrade.js"</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">"vant:publish"</span>:&nbsp;<span data-darkreader-inline-color="">"node&nbsp;cli/vant-publish.js"</span>,<br>},<br></code>
```

## ⭐️ 引入 ESLint 实现 JS 代码检查

小程序在完成一期需求后工程就已经很大了，为了继续提高项目稳定性，我决定引入 ESLint 实现代码检查。有几个重点：

-   要把不需要检查的第三方库等添加至 `.eslintignore` 进行忽略，比如 Vant 组件库
    
-   可以通过添加 `eslint-config-prettier` 和 `eslint-plugin-prettier` 插件，将 Prettier 和 ESLint 结合起来使用
    
-   `.eslintrc.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">module</span>.exports&nbsp;=&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">env</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">browser</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">node</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">es6</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">commonjs</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">extends</span>:&nbsp;[<span data-darkreader-inline-color="">'eslint:recommended'</span>,&nbsp;<span data-darkreader-inline-color="">'plugin:prettier/recommended'</span>],<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">parser</span>:&nbsp;<span data-darkreader-inline-color="">'@babel/eslint-parser'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">parserOptions</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">ecmaVersion</span>:&nbsp;<span data-darkreader-inline-color="">6</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">sourceType</span>:&nbsp;<span data-darkreader-inline-color="">'module'</span>,<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">globals</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">App</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Page</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Component</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Behavior</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">wx</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">getApp</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">getCurrentPages</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">rules</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'no-unused-vars'</span>:&nbsp;<span data-darkreader-inline-color="">'warn'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'prettier/prettier'</span>:&nbsp;<span data-darkreader-inline-color="">'warn'</span>,<br>&nbsp;&nbsp;},<br>};<br></code>
```

## 引入单元测试

单元测试也是提高代码质量的重要手段之一，因此我也尝试在项目中引入官方的单元测试功能。详情文档：单元测试<sup data-darkreader-inline-color="">[10]</sup>。

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;simulate&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'miniprogram-simulate'</span>;<br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;randomStr&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../utils'</span>;<br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;CompSpec&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../CompSpec'</span>;<br><br><span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;compId,&nbsp;specDesc&nbsp;}&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;CompSpec(<span data-darkreader-inline-color="">'components/no-data/no-data'</span>);<br><br>describe(specDesc,&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;test(<span data-darkreader-inline-color="">'Has&nbsp;default&nbsp;text'</span>,&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;comp&nbsp;=&nbsp;simulate.render(compId);<br>&nbsp;&nbsp;&nbsp;&nbsp;expect(comp.querySelector(<span data-darkreader-inline-color="">'.text'</span>).dom.innerHTML).toBe(<span data-darkreader-inline-color="">'目前还没有数据'</span>);<br>&nbsp;&nbsp;});<br><br>&nbsp;&nbsp;test(<span data-darkreader-inline-color="">'Show&nbsp;correct&nbsp;text'</span>,&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;putText&nbsp;=&nbsp;randomStr();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;comp&nbsp;=&nbsp;simulate.render(compId,&nbsp;{&nbsp;<span data-darkreader-inline-color="">text</span>:&nbsp;putText&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;expect(comp.querySelector(<span data-darkreader-inline-color="">'.text'</span>).dom.innerHTML).toEqual(putText);<br>&nbsp;&nbsp;});<br>});<br></code>
```

## ⭐️ 设置独立的跳转中间页

小程序中有很多可以进行分享的页面，如助力页、活动页等；以及一大批消息推送后用户可以点击消息卡片打开的页面，这些页面需要后端代码配置对应的页面路径，而每当小程序端文件夹结构变化时，后端代码也需要跟着改变，非常麻烦。

随着这些入口越来越多，跳转的维护愈发复杂，因此我决定引入一个专门的中间页面 (`/pages/portal/portal`) 处理全部跳转行为。

不管是前端生产的分享链接，还是后端代码配置的目标路径，永远都指向 Portal 页。小程序进入 Portal页后，页面再根据参数 pk (意为 PageKey) 在小程序端进行一次重定向。

-   `/pages/portal/portal.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;urlParamsToObj&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'../../utils/helpers'</span>;<br><br>Component({<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">methods</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;onLoad(pageOptions)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;optionsObj&nbsp;=&nbsp;<span data-darkreader-inline-color="">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;adapters&nbsp;=&nbsp;<span data-darkreader-inline-color="">null</span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;launchOptions&nbsp;=&nbsp;wx.getLaunchOptionsSync();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;小程序是扫码进入</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(launchOptions.scene&nbsp;===&nbsp;<span data-darkreader-inline-color="">1047</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;optionsObj&nbsp;=&nbsp;urlParamsToObj(<span data-darkreader-inline-color="">decodeURIComponent</span>(pageOptions.scene));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adapters&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">// 1001 =&gt;&nbsp;小程序扫码打开活动详情页。例：scene=encodeURIComponent('?pk=1001&amp;goodsId=${number}')</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">1001</span>:&nbsp;<span data-darkreader-inline-color="">this</span>._adaptToActivityDetailByQrcode<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;非扫码进入</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;optionsObj&nbsp;=&nbsp;pageOptions;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adapters&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">// 1002 =&gt;&nbsp;前往页面 A。例：?pk=1002&amp;goodsId=${number}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">1002</span>:&nbsp;<span data-darkreader-inline-color="">this</span>._adaptToPageA,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">// 1003 =&gt;&nbsp;前往页面 B。例：?pk=1003&amp;userId=${number}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">1003</span>:&nbsp;<span data-darkreader-inline-color="">this</span>._adaptToPageB,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;pk,&nbsp;...options&nbsp;}&nbsp;=&nbsp;optionsObj;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adapters[pk]&nbsp;?&nbsp;adapters[pk](options&nbsp;<span data-darkreader-inline-color="">"pk]&nbsp;?&nbsp;adapters[pk"</span>)&nbsp;:&nbsp;reLaunch(<span data-darkreader-inline-color="">'Index'</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;_adaptToActivityDetailByQrcode(options)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reLaunch(<span data-darkreader-inline-color="">'ActivityDetail'</span>,&nbsp;<span data-darkreader-inline-color="">`?goodsId=<span data-darkreader-inline-color="">${options.goodsId}</span>&amp;pageFrom=PORTAL`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;_adaptToPageA(options)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reLaunch(<span data-darkreader-inline-color="">'A'</span>,&nbsp;<span data-darkreader-inline-color="">`?goodsId=<span data-darkreader-inline-color="">${options.goodsId}</span>&amp;pageFrom=PORTAL`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;_adaptToPageB(options)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reLaunch(<span data-darkreader-inline-color="">'B'</span>,&nbsp;<span data-darkreader-inline-color="">`?userId=<span data-darkreader-inline-color="">${options.userId}</span>&amp;pageFrom=PORTAL`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>});<br></code>
```

## ⭐️⭐️ 小程序一键上传 & 版本管理

在小程序稳步迭代半年之际，我实在是受够了每次都要从开发者工具中点击上传按钮、填写版本号、发布的操作。好在微信提供了官方的 CI 工具<sup data-darkreader-inline-color="">[11]</sup>，因此我决定编写一个脚本实现小程序的一键上传功能，并且这个脚本最好能够一键维护小程序版本。

思路就是小程序项目内放置一个 env.js 文件，它专门向外抛出项目的运行环境和版本号信息这两个变量，所有的接口、配置等需要区分环境的时候，都导入 env.js 中的变量进行区分。而 env.js 则由上传脚本自动生成并维护。

脚本并不复杂，也只需要接收两个参数：`-e` 和 `-s`。-e 表示将要上传的小程序的环境，支持 dev, staging 和 prod 三种，分别对应开发、预发布和正式；-s 则可以给三位的正式版本号后面添加一个子版本号，主要用于在团队内部沟通、测试时使用，比如测试同事可以记录 V4.3.0.1 发现的问题，而开发人员修复后则可以发布一个 V4.3.0.2 的新版本以供回测。正式上线时则使用 V4.3.0 这个三位版本号。

-   `cli/upload.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;shell&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'shelljs'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;chalk&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'chalk'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;Command&nbsp;}&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'commander'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;ci&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'miniprogram-ci'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;appid&nbsp;}&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'../project.config.json'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;<span data-darkreader-inline-color="">version</span>:&nbsp;mainVersion&nbsp;}&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'../package.json'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;path&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'path'</span>);<br><br><span data-darkreader-inline-color="">const</span>&nbsp;program&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;Command();<br>program<br>&nbsp;&nbsp;.option(<span data-darkreader-inline-color="">'-e,&nbsp;--env&nbsp;&lt;type&gt;'</span>,&nbsp;<span data-darkreader-inline-color="">'The&nbsp;environment&nbsp;you&nbsp;want&nbsp;run'</span>,&nbsp;<span data-darkreader-inline-color="">'dev'</span>)<br>&nbsp;&nbsp;.option(<span data-darkreader-inline-color="">'-s,&nbsp;--sub-version&nbsp;&lt;number&gt;'</span>,&nbsp;<span data-darkreader-inline-color="">'Sub&nbsp;version'</span>,&nbsp;<span data-darkreader-inline-color="">'1'</span>)<br>&nbsp;&nbsp;.parse(process.argv);<br><span data-darkreader-inline-color="">const</span>&nbsp;options&nbsp;=&nbsp;program.opts();<br><span data-darkreader-inline-color="">const</span>&nbsp;env&nbsp;=&nbsp;options.env.toUpperCase();<br><span data-darkreader-inline-color="">const</span>&nbsp;subVersion&nbsp;=&nbsp;options.subVersion;<br><br><span data-darkreader-inline-color="">if</span>&nbsp;(![<span data-darkreader-inline-color="">'DEV'</span>,&nbsp;<span data-darkreader-inline-color="">'STAGING'</span>,&nbsp;<span data-darkreader-inline-color="">'PROD'</span>].includes(env))&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.error(<br>&nbsp;&nbsp;&nbsp;&nbsp;chalk.red(<span data-darkreader-inline-color="">`Required&nbsp;option&nbsp;'-e,&nbsp;--env'&nbsp;must&nbsp;be&nbsp;one&nbsp;of&nbsp;'dev',&nbsp;'staging'&nbsp;or&nbsp;'prod'.`</span>)<br>&nbsp;&nbsp;);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>}<br><span data-darkreader-inline-color="">const</span>&nbsp;fullVersion&nbsp;=<br>&nbsp;&nbsp;env&nbsp;===&nbsp;<span data-darkreader-inline-color="">'PROD'</span>&nbsp;?&nbsp;<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${env}</span>-<span data-darkreader-inline-color="">${mainVersion}</span>`</span>&nbsp;:&nbsp;<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${env}</span>-<span data-darkreader-inline-color="">${mainVersion}</span>-<span data-darkreader-inline-color="">${subVersion}</span>`</span>;<br><span data-darkreader-inline-color="">const</span>&nbsp;envFileCtx&nbsp;=&nbsp;<span data-darkreader-inline-color="">`export&nbsp;const&nbsp;ENV&nbsp;=&nbsp;'<span data-darkreader-inline-color="">${env}</span>';<br>export&nbsp;const&nbsp;VERSION&nbsp;=&nbsp;'<span data-darkreader-inline-color="">${fullVersion}</span>';<br>`</span>;<br><br><span data-darkreader-inline-color="">//&nbsp;重新编译小程序</span><br>shell.exec(<span data-darkreader-inline-color="">'cross-env&nbsp;NODE_ENV=production&nbsp;npx&nbsp;gulp&nbsp;build'</span>);<br><span data-darkreader-inline-color="">//&nbsp;需要同时写入&nbsp;src&nbsp;和&nbsp;dist&nbsp;两个目录</span><br>shell.ShellString(envFileCtx).to(path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'../src/config/env.js'</span>));<br>shell.ShellString(envFileCtx).to(path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'../dist/config/env.js'</span>));<br><br><span data-darkreader-inline-color="">console</span>.log(chalk.blue(<span data-darkreader-inline-color="">`Ready&nbsp;to&nbsp;upload...`</span>));<br><br><span data-darkreader-inline-color="">const</span>&nbsp;project&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;ci.Project({<br>&nbsp;&nbsp;appid,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;<span data-darkreader-inline-color="">'miniProgram'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">projectPath</span>:&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'../dist'</span>),<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">privateKeyPath</span>:&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'../upload.private.key'</span>),<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">ignores</span>:&nbsp;[<span data-darkreader-inline-color="">'**/*.d.ts'</span>,&nbsp;<span data-darkreader-inline-color="">'**/*.md'</span>],<br>});<br><br><span>(<span><span data-darkreader-inline-color="">async</span>&nbsp;(</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;ci.upload({<br>&nbsp;&nbsp;&nbsp;&nbsp;project,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">version</span>:&nbsp;fullVersion,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">desc</span>:&nbsp;<span data-darkreader-inline-color="">`Uploaded&nbsp;at&nbsp;<span data-darkreader-inline-color="">${<span data-darkreader-inline-color="">new</span>&nbsp;<span data-darkreader-inline-color="">Date</span>().toLocaleString()}</span>`</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">setting</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">es6</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">es7</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">minify</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">autoPrefixWXSS</span>:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;onProgressUpdate()&nbsp;{},<br>&nbsp;&nbsp;});<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(chalk.green(<span data-darkreader-inline-color="">`Upload&nbsp;Success!&nbsp;New&nbsp;Version:&nbsp;"<span data-darkreader-inline-color="">${fullVersion}</span>".`</span>));<br><br>&nbsp;&nbsp;process.exit();<br>})();<br></code>
```

-   代码中使用
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;config/env.js</span><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;ENV&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'./env'</span>;<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;BASE_URL_API&nbsp;=&nbsp;ENV&nbsp;===&nbsp;<span data-darkreader-inline-color="">'DEV'</span>&nbsp;?&nbsp;<span data-darkreader-inline-color="">'http://prod.com'</span>&nbsp;:&nbsp;<span data-darkreader-inline-color="">'https://dev.com'</span>;<br></code>
```

> ❝
> 
> 关于脚本中的 `npx gulp build` 等命令请结合下文的 _**引入 Gulp 工作流**_ 一节。

## 设置开发人员和测试人员专用的辅助页面

在小程序开发过程中，有一些功能可能是开发人员和测试人员常用的，比如查看当前用户信息、一键清空缓存、获取新的 login code 等，因此我们可以开发一个专用的页面存放这些功能，而入口则依据小程序运行环境决定是否隐藏。

我在小程序首页的左下角添加了一个小角标，用于标记当前小程序的版本号和环境。角标具有鲜明的背景色，开发环境是绿色，预发布环境是红色，生产环境则进行隐藏。点击角标则可以进入开发和测试人员专用的 Helper 页面。

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

## ⭐️ 实现小程序中的路由系统

小程序的路由高度依赖文件夹结构，每当项目文件更换路径，就需要全局查找并替换页面路径；并且 `wx.navigateTo` 等 API 本身只能接受字符串形式的路由参数，因此常常需要我们手动拼接路由参数。为了解决这些痛点，我从 Vue Router 中得到灵感，封装了一套简易的路由系统。

思路也很简单，就是给所有的页面取个名字，放进一个路由对象中，格式为 `{ routeName: 'routePath' }`。进行路由跳转时，只需要调用 `Routes[routeName]` 即可获取真实路径。这样我们就可以随意组织小程序文件夹结构，而不会影响逻辑代码了。

至于拼接参数的问题，我们则可以编写一个简单的函数，接受对象类型的参数，并组装成字符串即可。而小程序提供的多个路由函数，我们也只需要使用一个高阶函数即可生成，不需要每个都单独封装一遍。

-   `router/routes.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;Routes&nbsp;=&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Index</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/index/index'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Activities</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/tabs/activities/activities'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Mine</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/tabs/mine/mine'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Portal</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/portal/portal'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Login</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/login/login'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Helper</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/helper/helper'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Address</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/profiles/address/address'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">Setting</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/profiles/setting/setting'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;尤其适用于这种长路径！</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">ArticleDetail</span>:&nbsp;<span data-darkreader-inline-color="">'/subpackages/rickTextRender/pages/articleDetail/articleDetail'</span>,<br>};<br></code>
```

-   `router/router.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;Routes&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'./routes'</span>;<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;getRouteUrl&nbsp;=&nbsp;<span>(<span>routeName</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;targetRoute&nbsp;=&nbsp;Routes[routeName];<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!targetRoute)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.error(<span data-darkreader-inline-color="">`The&nbsp;RouteName&nbsp;must&nbsp;be&nbsp;one&nbsp;of:&nbsp;<span data-darkreader-inline-color="">${<span data-darkreader-inline-color="">Object</span>.keys(Routes).join(<span data-darkreader-inline-color="">',&nbsp;'</span>)}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;targetRoute;<br>};<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;buildParams&nbsp;=&nbsp;<span>(<span>params</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;fullParamStr;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!params)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;fullParamStr&nbsp;=&nbsp;<span data-darkreader-inline-color="">''</span>;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">typeof</span>&nbsp;params&nbsp;===&nbsp;<span data-darkreader-inline-color="">'string'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;fullParamStr&nbsp;=&nbsp;params;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;fullParamStr&nbsp;=&nbsp;<span data-darkreader-inline-color="">Object</span>.keys(params)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.map(<span>(<span>key,&nbsp;index</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;prefix&nbsp;=&nbsp;index&nbsp;===&nbsp;<span data-darkreader-inline-color="">0</span>&nbsp;?&nbsp;<span data-darkreader-inline-color="">`?`</span>&nbsp;:&nbsp;<span data-darkreader-inline-color="">`&amp;`</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${prefix}</span><span data-darkreader-inline-color="">${key}</span>=<span data-darkreader-inline-color="">${params[key]}</span>`</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.join(<span data-darkreader-inline-color="">''</span>);<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;fullParamStr;<br>};<br><br><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;高阶函数构建路由跳转模块<br>&nbsp;&nbsp;*&nbsp;@param&nbsp;{Function}&nbsp;method<br>&nbsp;&nbsp;*/</span><br><span data-darkreader-inline-color="">const</span>&nbsp;generateRoute&nbsp;=&nbsp;<span>(<span>method</span>)&nbsp;=&gt;</span>&nbsp;<span>(<span>routeName,&nbsp;params,&nbsp;events</span>)&nbsp;=&gt;</span><br>&nbsp;&nbsp;method({<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">url</span>:&nbsp;getRouteUrl(routeName)&nbsp;+&nbsp;buildParams(params),<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">events</span>:&nbsp;events&nbsp;??&nbsp;<span data-darkreader-inline-color="">null</span>,<br>&nbsp;&nbsp;});<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;switchTab&nbsp;=&nbsp;generateRoute(wx.switchTab);<br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;reLaunch&nbsp;=&nbsp;generateRoute(wx.reLaunch);<br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;navigateTo&nbsp;=&nbsp;generateRoute(wx.navigateTo);<br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;redirectTo&nbsp;=&nbsp;generateRoute(wx.redirectTo);<br></code>
```

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;手动添加字符串参数</span><br>navigateTo(<span data-darkreader-inline-color="">'ActivityDetail'</span>,&nbsp;<span data-darkreader-inline-color="">`?goodsId=<span data-darkreader-inline-color="">${goodsId}</span>`</span>);<br><br><span data-darkreader-inline-color="">//&nbsp;对象形式传参</span><br>navigateTo(<span data-darkreader-inline-color="">'CommentDetail'</span>,&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">client</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.commentClient,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">topicId</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.data.reportId,<br>&nbsp;&nbsp;commentId<br>});<br><br><span data-darkreader-inline-color="">//&nbsp;支持&nbsp;EventChannel</span><br>navigateTo(<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">'Address'</span>,<br>&nbsp;&nbsp;{&nbsp;<span data-darkreader-inline-color="">pageFrom</span>:&nbsp;<span data-darkreader-inline-color="">'POINT_MALL_SUBMIT'</span>&nbsp;},<br>&nbsp;&nbsp;{&nbsp;<span data-darkreader-inline-color="">addressSubmitted</span>:&nbsp;<span data-darkreader-inline-color="">this</span>.initAddressForm.bind(<span data-darkreader-inline-color="">this</span>)&nbsp;}<br>);<br></code>
```

## 按照就近原则组织项目

在项目初期，我是几乎对照 Vue CLI 项目组织代码，比如把组件都放在 components 文件夹下，把图片和图标放在 assets 文件夹下，但随着项目中的组件和文件越来越多，components 和 assets 目录下出现了大量只用到一次的组件和图片。

由于小程序严格限制每个包最大只有 2M，我们需要更加注重项目体积。我们可以根据是否复用把组件和静态资源进行重新组织，只在页面中使用一次的组件或资源放置在页面同级下，而真正被多次复用的组件和资源才放置在 compoents 和 assets 中。如此一来，当某个页面废弃时，我们只需要移除这个页面文件夹，当前页面独享的组件和资源将被一起移除。

## 权限模块

我把小程序项目中所有授权和权限相关逻辑全部放置在 `utils/Auth.js` 中。

### 微信授权统一管理

在小程序开发过程中，一定会和微信授权打交道。用户授权是一个很麻烦的事情，毕竟在整个小程序周期中，有些权限只要用户拒绝过一次就无法再次发起。因此我们需要在用户拒绝授权后尽量给出提示，尝试引导用户主动打开授权。

-   `utils/Auth.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;判断微信的某个权限是否授权通过，会自动调起授权弹窗以及显示拒绝引导<br>&nbsp;&nbsp;*&nbsp;<span data-darkreader-inline-color="">@param&nbsp;<span data-darkreader-inline-color="">{String}</span>&nbsp;</span>scope&nbsp;&lt;https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/AuthSetting.html&gt;<br>&nbsp;&nbsp;*&nbsp;<span data-darkreader-inline-color="">@param&nbsp;<span data-darkreader-inline-color="">{Boolean}</span>&nbsp;</span>withRejectGuide&nbsp;是否显示拒绝后的再次授权引导<br>&nbsp;&nbsp;*&nbsp;<span data-darkreader-inline-color="">@returns&nbsp;<span data-darkreader-inline-color="">{Boolean}</span>&nbsp;</span>是否授权通过<br>&nbsp;&nbsp;*/</span><br><span data-darkreader-inline-color="">static</span>&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;isWxAuthed(scope,&nbsp;withRejectGuide&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>)&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;authSetting&nbsp;}&nbsp;=&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;wxp.getSetting();<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;authResult;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;从未授权</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!<span data-darkreader-inline-color="">Object</span>.keys(authSetting).includes(scope))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;对于 scope.userInfo，如果还没有授权，则直接返回授权失败。</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(scope&nbsp;===&nbsp;<span data-darkreader-inline-color="">'scope.userInfo'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authResult&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;wxp.authorize({&nbsp;scope&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authResult&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">catch</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authResult&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;授权通过</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(authSetting[scope])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;authResult&nbsp;=&nbsp;<span data-darkreader-inline-color="">true</span>;<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;授权拒绝</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;authResult&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span>;<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(scope&nbsp;!==&nbsp;<span data-darkreader-inline-color="">'scope.userInfo'</span>&nbsp;&amp;&amp;&nbsp;!authResult&nbsp;&amp;&amp;&nbsp;withRejectGuide)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;wxp.showModal({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;<span data-darkreader-inline-color="">'无此权限'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">content</span>:&nbsp;<span data-darkreader-inline-color="">'请点击右上角的菜单，点击设置按钮，即可重新开启此权限'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;authResult;<br>}<br></code>
```

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">async</span>&nbsp;onSaveQrcode()&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;isAuthed&nbsp;=&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;Auth.isWxAuthed(<span data-darkreader-inline-color="">'scope.writePhotosAlbum'</span>);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(isAuthed)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;wx.saveImageToPhotosAlbum({&nbsp;<span data-darkreader-inline-color="">filePath</span>:&nbsp;<span data-darkreader-inline-color="">'/pages/static/pickGroup/qrcode.jpg'</span>&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wx.showToast({&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;<span data-darkreader-inline-color="">'保存成功'</span>&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">catch</span>&nbsp;(e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wx.showToast({&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;<span data-darkreader-inline-color="">'保存失败'</span>,&nbsp;<span data-darkreader-inline-color="">icon</span>:&nbsp;<span data-darkreader-inline-color="">'none'</span>&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>}<br></code>
```

### ⭐️⭐️ 用户登录拦截

随着小程序项目越来越大，我们不得不考虑用户登录操作的各种时机。项目早期，用户登录操作分布在各种地方，比如活动页的某个按钮可能会触发登录、“我的” 页面的头像也会触发登录，而点击任意一个菜单也有可能触发登录。这种分散的操作给项目维护带来了很大的负担。

后续我们决定将用户的登录操作收敛到一个统一的登录页面，只要需要用户进行登录，就全部重定向到登录页进行登录。并且由于我们会在用户登录后记录用户的 openid，因此用户重新进入小程序后（包括删除小程序再进去）也可以直接通过 openid 获取用户信息实现小程序端的登录。**也就是说，用户在整个使用小程序的生命周期中，只需要登录一次，所以此处的登录其实更像是“注册”操作。**

> ❝
> 
> 从 2021 年 2 月 23 日起，小程序可以通过 wx.login 接口直接获取用户的 unionId，因此在数据库中应当使用 unionId 作为用户唯一标识而非 openid。

_**具体实现思路：**_

1.  在 app.js 中初始化用户登录状态和用户信息，并将这些信息保存到 localStorage 中。比如未登录就保存 `is_logged` 值为 false
    
2.  **封装 `requireLogged` 方法，传入一个回调函数，如果用户已登录则直接执行回调，没有则跳转到登录页。**也就是用 `requireLogged` 方法包裹登录后执行的逻辑。这个方法需要结合 `wx.navigateTo` 和 EventChannel<sup data-darkreader-inline-color="">[12]</sup> 共同实现，注意 navigateTo 的第三个参数即是监听登录完毕事件
    

> ❝
> 
> 这种方案有一个优点是对于开发人员来说几乎无感，只需要把原来的逻辑用函数包裹一下复制到 requireLogged 中间即可。

-   `utils/Auth.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;要求用户注册后执行。结合 eventChannel 实现注册后立即执行<br>&nbsp;&nbsp;*&nbsp;<span data-darkreader-inline-color="">@param&nbsp;<span data-darkreader-inline-color="">{Function}</span>&nbsp;</span>cb&nbsp;需要注册后执行的回调函数<br>&nbsp;&nbsp;*&nbsp;<span data-darkreader-inline-color="">@param&nbsp;<span data-darkreader-inline-color="">{boolean}</span>&nbsp;</span>immediateDoCb&nbsp;注册后是否立即执行回调函数<br>&nbsp;&nbsp;*&nbsp;<span data-darkreader-inline-color="">@param&nbsp;<span data-darkreader-inline-color="">{boolean}</span>&nbsp;</span>forceDoLogin&nbsp;无视是否已注册，强制进入注册页面<br>&nbsp;&nbsp;*/</span><br><span data-darkreader-inline-color="">static</span>&nbsp;requireLogged(cb,&nbsp;immediateDoCb&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span>,&nbsp;forceDoLogin&nbsp;=&nbsp;<span data-darkreader-inline-color="">false</span>)&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(Auth.isLogged()&nbsp;&amp;&amp;&nbsp;!forceDoLogin)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;cb&nbsp;&amp;&amp;&nbsp;cb();<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;navigateTo(<span data-darkreader-inline-color="">'Login'</span>,&nbsp;<span data-darkreader-inline-color="">null</span>,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">logged</span>:&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;immediateDoCb&nbsp;&amp;&amp;&nbsp;cb&nbsp;&amp;&amp;&nbsp;cb();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;}<br>}<br></code>
```

3.  在 Login 页面实现登录逻辑，当登录成功后：
    
    **注意：此处的 await 不能省略！这是由于假如 callback 里面的操作是一个页面跳转，不添加 await 则可能引起页面栈混乱而报错**
    

1.  请求后台接口，保存用户信息
    
2.  重新执行 app.js 中的用户信息初始化方法
    
3.  执行 `await wx.navigateBack()` 返回上一级页面。
    

-   `login.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;点击登录页的登录按钮触发</span><br><span data-darkreader-inline-color="">async</span>&nbsp;onLogin()&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;eventChannel&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.getOpenerEventChannel();<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;res&nbsp;=&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;Auth.getUserProfileCtx();<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;Auth.updateUserProfile&nbsp;主要用来请求后端的更新用户信息接口</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;Auth.updateUserProfile({<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">userInfo</span>:&nbsp;res.userInfo,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">loadingMsg</span>:&nbsp;<span data-darkreader-inline-color="">'登录中...'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">retryMsgContent</span>:&nbsp;<span data-darkreader-inline-color="">'登录失败，请重试'</span>,<br>&nbsp;&nbsp;});<br>&nbsp;&nbsp;app.initUserInfo();<br><br>&nbsp;&nbsp;wx.showToast({&nbsp;<span data-darkreader-inline-color="">title</span>:&nbsp;<span data-darkreader-inline-color="">'登录成功'</span>,&nbsp;<span data-darkreader-inline-color="">duration</span>:&nbsp;<span data-darkreader-inline-color="">500</span>&nbsp;});<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;asyncTimeout(<span data-darkreader-inline-color="">500</span>);<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;注意，此处&nbsp;await&nbsp;不能去掉，否则可能会导致回调事件因为页面栈错乱而异常</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;wx.navigateBack();<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;登录后重新提交已登录事件</span><br>&nbsp;&nbsp;eventChannel.emit(<span data-darkreader-inline-color="">'logged'</span>);<br>},<br></code>
```

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;一个用户点赞操作。未登录时会自动跳转到登录页，已登录则直接触发点赞</span><br>Auth.requireLogged(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.triggerEvent(<span data-darkreader-inline-color="">'click-like'</span>);<br>},<br><span data-darkreader-inline-color="">//&nbsp;完成登录后直接再次触发点赞操作</span><br><span data-darkreader-inline-color="">true</span>);<br></code>
```

## ⭐️⭐️ 引入 Gulp 工作流

在小程序开发过程中，样式编写大概是永远的痛点之一。在面对越发复杂的样式需求时，小程序的 wxss 很难满足我的要求。因此我尝试在小程序中使用 Scss 语法编写样式，在一系列对比后，我还是选择了流畅简单的 Gulp。当然，既然引入了 Gulp，我们就可以做更多花哨的操作了，比如，生产环境下对 js 和 wxss 进行代码压缩、把部分高阶 ES 语法转译为低阶语法、使用 yaml 代替 json 编写配置等。

我们的小程序中没有使用太复杂的 Gulp 配置，只是着重支持了 Scss 代码编写、样式和 JS 代码压缩两个功能，而构建后的产物则输出到 dist 目录下。引入 Gulp 后，小程序的改动并不大，主要是：

-   在 project.config.json 中把小程序的根目录改为 dist：`"miniprogramRoot": "dist/",`
    
-   由于 Scss 是 CSS 的超集，我们可以很安全的直接对老的样式文件进行重命名，所以直接跑一个脚本把项目中的 .wxss 批量重命名为 .scss 就完事了
    
-   把外部样式表，如 vant 中的 `common/index.wxss` 重命名为 `common/index.scss`
    

最终的示例代码：

-   `gulpfile.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;path&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'path'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;del&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'del'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;gulp&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp'</span>);<br><span data-darkreader-inline-color="">// Windows 平台下 gulp.watch 不生效，需要用此插件替代。并且此插件性能更佳</span><br><span data-darkreader-inline-color="">const</span>&nbsp;gulpWatch&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp-watch'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;sass&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp-dart-sass'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;rename&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp-rename'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;terser&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp-terser'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;uglifycss&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp-uglifycss'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;gulpIf&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'gulp-if'</span>);<br><br><span data-darkreader-inline-color="">const</span>&nbsp;isProd&nbsp;=&nbsp;process.env.NODE_ENV&nbsp;===&nbsp;<span data-darkreader-inline-color="">'production'</span>;<br><span data-darkreader-inline-color="">const</span>&nbsp;SRC&nbsp;=&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'./src'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;DIST&nbsp;=&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'./dist'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;PANTONE&nbsp;=&nbsp;path.resolve(__dirname,&nbsp;<span data-darkreader-inline-color="">'./pantone'</span>);<br><br><span data-darkreader-inline-color="">const</span>&nbsp;_clean&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;del(DIST);<br><span data-darkreader-inline-color="">const</span>&nbsp;_copy&nbsp;=&nbsp;<span>(<span>ext</span>)&nbsp;=&gt;</span>&nbsp;gulp.src(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.<span data-darkreader-inline-color="">${ext}</span>`</span>).pipe(gulp.dest(DIST));<br><span data-darkreader-inline-color="">const</span>&nbsp;staticExts&nbsp;=&nbsp;[<span data-darkreader-inline-color="">'png'</span>,&nbsp;<span data-darkreader-inline-color="">'jpg'</span>];<br><span data-darkreader-inline-color="">const</span>&nbsp;_static&nbsp;=&nbsp;gulp.parallel(staticExts.map(<span><span>ext</span>&nbsp;=&gt;</span>&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;_copy(ext)));<br><span data-darkreader-inline-color="">const</span>&nbsp;_wxml&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;_copy(<span data-darkreader-inline-color="">'wxml'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;_wxs&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;_copy(<span data-darkreader-inline-color="">'wxs'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;_json&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;_copy(<span data-darkreader-inline-color="">'json'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;_wxss&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;_copy(<span data-darkreader-inline-color="">'wxss'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;_sass&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span><br>&nbsp;&nbsp;gulp<br>&nbsp;&nbsp;&nbsp;&nbsp;.src(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.scss`</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(sass())<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(gulpIf(isProd,&nbsp;uglifycss()))<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(rename({&nbsp;<span data-darkreader-inline-color="">extname</span>:&nbsp;<span data-darkreader-inline-color="">'.wxss'</span>&nbsp;}))<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(gulp.dest(DIST));<br><span data-darkreader-inline-color="">const</span>&nbsp;_js&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;gulp.src(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.js`</span>).pipe(gulpIf(isProd,&nbsp;terser())).pipe(gulp.dest(DIST));<br><span data-darkreader-inline-color="">const</span>&nbsp;_pantone&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span><br>&nbsp;&nbsp;gulp<br>&nbsp;&nbsp;&nbsp;&nbsp;.src(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${PANTONE}</span>/pantone.scss`</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(sass())<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(rename(<span data-darkreader-inline-color="">'variables.css'</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;.pipe(gulp.dest(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${PANTONE}</span>/assets`</span>));<br><br><span data-darkreader-inline-color="">const</span>&nbsp;build&nbsp;=&nbsp;gulp.series(_clean,&nbsp;gulp.parallel(_wxml,&nbsp;_wxs,&nbsp;_json,&nbsp;_wxss,&nbsp;_static,&nbsp;_sass,&nbsp;_js));<br><span data-darkreader-inline-color="">const</span>&nbsp;watch&nbsp;=&nbsp;gulp.series(build,&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.wxml`</span>,&nbsp;_wxml);<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.wxss`</span>,&nbsp;_wxss);<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.wxs`</span>,&nbsp;_wxs);<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.json`</span>,&nbsp;_json);<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.{<span data-darkreader-inline-color="">${staticExts.join(<span data-darkreader-inline-color="">','</span>)}</span>}`</span>,&nbsp;_static);<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.js`</span>,&nbsp;_js);<br>&nbsp;&nbsp;gulpWatch(<span data-darkreader-inline-color="">`<span data-darkreader-inline-color="">${SRC}</span>/**/*.scss`</span>,&nbsp;_sass);<br>});<br><span data-darkreader-inline-color="">const</span>&nbsp;pantone&nbsp;=&nbsp;gulp.series(_pantone);<br><br><span data-darkreader-inline-color="">module</span>.exports&nbsp;=&nbsp;{&nbsp;build,&nbsp;watch,&nbsp;pantone&nbsp;};<br></code>
```

-   `package.json`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">"scripts"</span>:&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">"dev"</span>:&nbsp;<span data-darkreader-inline-color="">"NODE_ENV=development&nbsp;npx&nbsp;gulp&nbsp;watch"</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">"build"</span>:&nbsp;<span data-darkreader-inline-color="">"NODE_ENV=production&nbsp;npx&nbsp;gulp&nbsp;build"</span><br>},<br></code>
```

## ⭐️ 使用 CSS 变量

为了让项目中的各种颜色、字号更加统一，我们有必要提前定义好一些可用的色值字号。比起 Scss 变量，我更推荐在项目中使用原生的 CSS 变量。

-   Example
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">// styles/_reset.scss<br>page {<br>  // 定义 CSS 变量<br>  --color-primary: #fbd45f;<br>  --size-base: 28rpx;<br><br>  // ...<br>}<br><br>view {<br>  box-sizing: border-box;<br>}<br></code>
```

然而，当项目中使用的 CSS 变量较多时，我们可以尝试使用 Scss 自动生成 CSS 变量。下面的代码大幅参考了 Bootstrap<sup data-darkreader-inline-color="">[13]</sup>。另外，如果你想更深入的了解 Scss，我也强烈建议你阅读 Bootstrap 的源码，真的是集优雅与花哨于一身。

-   `styles/_functions.scss`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">// Tint a color: mix a color with white<br>@function tint-color($color, $weight) {<br>  @return mix(white, $color, $weight);<br>}<br><br>// Shade a color: mix a color with black<br>@function shade-color($color, $weight) {<br>  @return mix(black, $color, $weight);<br>}<br></code>
```

-   `styles/_variables.scss`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">@import 'functions';<br><br>@mixin use-css-variables() {<br>  // ===============================================<br>  // Size<br>  // ===============================================<br>  $css-variable-prefix-size: size-;<br><br>  $size-base: 28rpx; // 默认<br>  $size-master: 36rpx; // 最高级标题、用户名、tab 选中等<br>  $size-title: 32rpx; // 标题、tab 未选中等<br>  $size-secondary: 24rpx; // 提示、次级文字、次级按钮等<br>  $size-label: 22rpx; // 标签、日期、点赞数量、提示等<br><br>  $special-sizes: (<br>    'base': $size-base,<br>    'master': $size-master,<br>    'title': $size-title,<br>    'secondary': $size-secondary,<br>    'label': $size-label,<br>  );<br><br>  @each $size, $value in $special-sizes {<br>    --#{$css-variable-prefix-size}#{$size}: #{$value};<br>  }<br><br>  // ===============================================<br>  // Color<br>  // ===============================================<br>  $css-variable-prefix-color: color-;<br><br>  // ========== Themes ==========<br>  $color-primary: #fbd45f;<br>  $color-gray: #888;<br>  $color-yellow: #f7dc00;<br>  $color-blue: #5a94e3;<br>  $color-red: #ee0a24;<br><br>  $theme-colors: (<br>    'primary': $color-primary,<br>    'gray': $color-gray,<br>    'blue': $color-blue,<br>    'red': $color-red,<br>    'yellow': $color-yellow,<br>  );<br><br>  @each $color, $value in $theme-colors {<br>    --#{$css-variable-prefix-color}#{$color}: #{$value};<br><br>    @for $i from 1 through 9 {<br>      @if $i&lt;5 {<br>        --#{$css-variable-prefix-color}#{$color}-#{$i*100}: #{tint-color($value, 100% - $i * 20%)};<br>      } @else if $i == 5 {<br>        --#{$css-variable-prefix-color}#{$color}-#{$i*100}: #{$value};<br>      } @else {<br>        --#{$css-variable-prefix-color}#{$color}-#{$i*100}: #{shade-color($value, ($i - 5) * 20%)};<br>      }<br>    }<br>  }<br>}<br></code>
```

-   `styles/_reset.scss`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">@import 'variables';<br><br>page {<br>  // 引入项目中需要使用的 css 变量<br>  @include use-css-variables();<br><br>  height: 100%;<br>  ...<br>}<br></code>
```

-   页面中使用
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&amp;-placeholder {<br>  font-size: 28rpx;<br>  color: var(--color-gray-300);<br>}<br></code>
```

## 引入 Stylelint 实现样式代码检查

小程序引入 Gulp 工作流后就可以愉快的使用 Scss 编写样式了。而当我重新整理样式代码时才发现项目中的样式代码量已经非常可观，我们最好进一步对样式代码进行规范，因此我也在小程序项目中引入了 Stylelint。

与 ESLint 类似，我们同样需要在项目根目录创建 `.stylelintrc.js` 和 `.stylelintignore` 进行一点点配置。

-   `.stylelintrc.js`
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">module</span>.exports&nbsp;=&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">extends</span>:&nbsp;[<span data-darkreader-inline-color="">'stylelint-config-standard'</span>,&nbsp;<span data-darkreader-inline-color="">'stylelint-config-recess-order'</span>],<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">plugins</span>:&nbsp;[<span data-darkreader-inline-color="">'stylelint-order'</span>],<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">rules</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'selector-type-no-unknown'</span>:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">ignoreTypes</span>:&nbsp;[<span data-darkreader-inline-color="">'page'</span>,&nbsp;<span data-darkreader-inline-color="">'scroll-view'</span>,&nbsp;<span data-darkreader-inline-color="">'block'</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;],<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'unit-no-unknown'</span>:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">ignoreUnits</span>:&nbsp;[<span data-darkreader-inline-color="">'rpx'</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;],<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'at-rule-no-unknown'</span>:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">ignoreAtRules</span>:&nbsp;[<span data-darkreader-inline-color="">'function'</span>,&nbsp;<span data-darkreader-inline-color="">'if'</span>,&nbsp;<span data-darkreader-inline-color="">'else'</span>,&nbsp;<span data-darkreader-inline-color="">'for'</span>,&nbsp;<span data-darkreader-inline-color="">'each'</span>,&nbsp;<span data-darkreader-inline-color="">'include'</span>,&nbsp;<span data-darkreader-inline-color="">'mixin'</span>,&nbsp;<span data-darkreader-inline-color="">'return'</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;],<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">'no-empty-source'</span>:&nbsp;[<span data-darkreader-inline-color="">true</span>,&nbsp;{&nbsp;<span data-darkreader-inline-color="">severity</span>:&nbsp;<span data-darkreader-inline-color="">'warning'</span>&nbsp;}],<br>&nbsp;&nbsp;},<br>};<br></code>
```

## 引入分包机制

在项目迭代两个大版本后，小程序体积已经达到了 985KB 左右，对于体积的优化迫在眉睫。仔细分析发现，光是用于解析富文本的 towxml 依赖就占了 337KB，而这个功能的使用频率实际上非常低。

因此近期小程序将使用到富文本的模块和积分商城模块进行拆分，使用了小程序分包机制<sup data-darkreader-inline-color="">[14]</sup>。使用分包后，小程序主包体积下降至 631KB。未来的项目开发中，也应该积极考虑使用小程序分包技术，优化用户首次打开体验。

## 引用链接

\[1\]

异步 API 返回 Promise: https://developers.weixin.qq.com/miniprogram/dev/framework/app-service/api.html#API

\[2\]

API Promise 化: https://developers.weixin.qq.com/miniprogram/dev/extended/utils/api-promise.html

\[3\]

SemVer 规范: https://semver.org/lang/zh-CN/

\[4\]

Editorconfig: https://editorconfig.org/

\[5\]

Prettier: https://prettier.io/

\[6\]

Vant Weapp: https://youzan.github.io/vant-weapp/#/home

\[7\]

shelljs: https://www.npmjs.com/package/shelljs

\[8\]

chalk: https://www.npmjs.com/package/chalk

\[9\]

commander.js: https://www.npmjs.com/package/commander

\[10\]

单元测试: https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/unit-test.html

\[11\]

CI 工具: https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html

\[12\]

EventChannel: https://developers.weixin.qq.com/miniprogram/dev/api/route/EventChannel.html

\[13\]

Bootstrap: https://getbootstrap.com/

\[14\]

小程序分包机制: https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/basic.html

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**也许你还想看**  

**（▼点击文章标题或封面查看）**

[

小程序项目框架迁移实践

2022-02-17

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

](https://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==&mid=2247528323&idx=1&sn=ba847bc6e073f21d851fc8c88ab9c81a&chksm=fd1db264ca6a3b7235fd9cb34d3b6715a0f8be79b56ad03df7cd71155337c1fd38fb732043a5&scene=21#wechat_redirect)

[

前端工程化-打造企业通用脚手架

2022-01-13

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

](https://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==&mid=2247526408&idx=1&sn=80cd1ff8a007b17249f77e94ae0a257b&chksm=fd1db5efca6a3cf9454539d85a474655d672d31f7eb0d1ff610b87620e611af87e0cd9b5df62&scene=21#wechat_redirect)

[

前端通用SEO技术优化指南

2021-10-07

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

](https://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==&mid=2247513066&idx=1&sn=15ab76d27f0fd885583d724de6a97195&chksm=fd1d6e0dca6ae71bbb40405c0c6b4bdfd9f120287fc22fdddc2b56c876c1685c828bb7385e43&scene=21#wechat_redirect)

[

Android自定义ViewGroup的那些事儿

2021-10-14

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

](https://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==&mid=2247513585&idx=1&sn=d142068c2a7ee9b2af19653656a3d2d7&chksm=fd1d6816ca6ae1008cdf60aa4924c402ba37b1fbcd8fecb4174879fa61b3d80215012e346fe9&scene=21#wechat_redirect)

[

Android与HEIF格式图片适配方法

2021-12-02

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

](https://mp.weixin.qq.com/s?__biz=MzU3NTY3MTQzMg==&mid=2247520993&idx=1&sn=adbe1452ae3ba0c7212427cc7f1bbddf&chksm=fd1d4f06ca6ac6105ee3f966105ee6ef775d42702c85b8e892f2bc79200f9c2cd6abd5dba6fe&scene=21#wechat_redirect)