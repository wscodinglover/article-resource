æœ€è¿‘ä¹Ÿæ˜¯åœ¨å­¦ä¹ nestjsè¿™ä¸€å—çš„å†…å®¹ï¼Œä¹Ÿæ˜¯çœ‹åˆ°nestjså®‰å…¨è¿™ä¸€å—å†…å®¹ï¼Œé¡ºä¾¿å°±ä½¿ç”¨jwtå»å®ç°äº†ä¸€ä¸‹æ³¨å†Œã€ç™»å½•ã€ç”¨æˆ·å¯†ç åŠ å¯†å’Œå¯¹åç«¯æ¥å£åšä¸€ä¸ªç»Ÿä¸€çš„æƒé™å¤„ç†ï¼Œæ³¨å†Œç™»å½•åŠŸèƒ½å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰ï¼Œè€Œæ¥å£æƒé™ç»Ÿä¸€å¤„ç†ï¼Œä¹Ÿå°±æ˜¯å’±ä»¬å¹³æ—¶å¼€å‘æ—¶ï¼Œé™¤äº†ç™»å½•æ³¨å†Œç­‰ä¸€äº›å…¬å…±æ¥å£ä»¥å¤–çš„æ¥å£ï¼Œéœ€è¦å¯¹tokenè¿›è¡Œä¸€ä¸ªéªŒè¯ï¼ŒéªŒè¯ä¸é€šè¿‡åˆ™è¿”å›401ï¼Œé€šè¿‡æ‰å»è¿”å›æ­£ç¡®çš„çŠ¶æ€ç å’Œæ•°æ®ã€‚ä¸‹é¢æ˜¯æ•´ä½“çš„ä¸€ä¸ªæµç¨‹ï¼Œå¯èƒ½æœ‰ç‚¹é•¿ï¼Œæˆ‘ä¼šä¸€æ­¥ä¸€æ­¥å¸¦å¤§å®¶å»å®Œæˆè¿™äº›åŠŸèƒ½ï¼Œå¹¶é™„ä¸Šæºç ï¼Œå¸Œæœ›å¤§å®¶è€å¿ƒçœ‹å®Œã€‚

é¦–å…ˆï¼Œå’±ä»¬å»åˆ›å»ºä¸€ä¸ªnestjsé¡¹ç›®,ä½¿ç”¨`nest new xxx`,æˆ‘è¿™é‡Œç®€å•å–åä¸ºauthï¼ŒåŒ…ç®¡ç†å·¥å…·æˆ‘è¿™é‡Œå°±ç”¨pnpmäº†ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±ç”µè„‘ä¸Šå®‰è£…çš„åŒ…ç®¡ç†å·¥å…·å»é€‰æ‹©,é€‰æ‹©å¥½å›è½¦ä¸€ä¸‹å»å®‰è£…,å®‰è£…æ—¶é—´å¯èƒ½æœ‰ç‚¹é•¿ï¼Œå¤§å®¶è€å¿ƒç­‰å¾…ä¸€ä¸‹

![Image](https://mmbiz.qpic.cn/mmbiz_png/1W6by1JJ9TJe5LW0IOCG97EpoNsIq8HfwBEJpvedZPdia38yVUACCe3Xffcic0oqRAjRzqibG2uUYO2WqELPia2gSw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

1692408270852.jpg

å®‰è£…å®Œæˆåï¼Œä½¿ç”¨`nest g res auth`å»ç”Ÿæˆrestfulé£æ ¼çš„authæ¨¡å—ï¼Œä¸‹é¢æ˜¯å…·ä½“æ“ä½œ

![Image](https://mmbiz.qpic.cn/mmbiz_png/1W6by1JJ9TJe5LW0IOCG97EpoNsIq8HfXsE3rapClNTXdeicHwTbB3iahswnIz9AxibZk6pPiaGKge6vdTF6NLZETA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

image.png

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

ç„¶åæˆ‘ä»¬æ‰¾åˆ°`auth.controllert.ts`å’Œ`auth.service.ts`æ–‡ä»¶ï¼ŒæŠŠè¿™äº›æ–¹æ³•å…ˆå»é™¤æ‰ï¼Œç§»é™¤å®Œæˆåé•¿ä¸‹é¢è¿™æ ·

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

ç”±äºå’±ä»¬è¦å»æ³¨å†Œç”¨æˆ·ï¼Œè‚¯å®šæ˜¯éœ€è¦ä¸€å¼ ç”¨æˆ·çš„è¡¨ï¼Œæ¥ç€å’±ä»¬å…ˆå»è¿æ¥æ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨mysqlæ•°æ®åº“ï¼ŒNestæä¾›äº†ä¸ç°æˆçš„ TypeORMä¸ @nestjs/typeormçš„ç´§å¯†é›†æˆï¼Œæˆ‘è¿™é‡Œä¹Ÿæ˜¯ä½¿ç”¨TypeORMï¼Œå¯¹äºæ•°æ®åº“çš„å®‰è£…ï¼Œç½‘ä¸Šä¹Ÿæ˜¯æœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæˆ‘è¿™é‡Œå°±ä¸å…·ä½“å»è®²äº†ã€‚å’±ä»¬å…ˆå»å®‰è£…è¿™ä¸‰ä¸ªåŒ…

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">pnpm&nbsp;install&nbsp;--save&nbsp;@nestjs/typeorm&nbsp;typeorm&nbsp;mysql2<br></code>
```

ç„¶ååœ¨`app.module.ts`æ–‡ä»¶å»é…ç½®è¿æ¥mysql

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Module&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AppController&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./app.controller'</span>;<br>import&nbsp;{&nbsp;AppService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./app.service'</span>;<br>import&nbsp;{&nbsp;AuthModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth/auth.module'</span>;<br>import&nbsp;{&nbsp;TypeOrmModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br><br>@Module({<br>&nbsp;&nbsp;imports:&nbsp;[AuthModule,&nbsp;TypeOrmModule.forRoot({<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;<span data-darkreader-inline-color="">'mysql'</span>,&nbsp;//&nbsp;æ•°æ®åº“ç±»å‹<br>&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;<span data-darkreader-inline-color="">'localhost'</span>,&nbsp;//&nbsp;ä¸»æœºå<br>&nbsp;&nbsp;&nbsp;&nbsp;port:&nbsp;3306,&nbsp;//&nbsp;ç«¯å£<br>&nbsp;&nbsp;&nbsp;&nbsp;username:&nbsp;<span data-darkreader-inline-color="">'root'</span>,&nbsp;//&nbsp;ç”¨æˆ·å<br>&nbsp;&nbsp;&nbsp;&nbsp;password:&nbsp;<span data-darkreader-inline-color="">'123456'</span>,&nbsp;//&nbsp;å¯†ç <br>&nbsp;&nbsp;&nbsp;&nbsp;database:&nbsp;<span data-darkreader-inline-color="">'nestjs'</span>,&nbsp;//&nbsp;æ•°æ®åº“åç§°<br>&nbsp;&nbsp;&nbsp;&nbsp;synchronize:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;retryDelay:&nbsp;500,&nbsp;//é‡è¯•è¿æ¥æ•°æ®åº“é—´éš”<br>&nbsp;&nbsp;&nbsp;&nbsp;retryAttempts:&nbsp;10,//é‡è¯•è¿æ¥æ•°æ®åº“çš„æ¬¡æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;autoLoadEntities:&nbsp;<span data-darkreader-inline-color="">true</span>,&nbsp;//å¦‚æœä¸º<span data-darkreader-inline-color="">true</span>,å°†è‡ªåŠ¨åŠ è½½å®ä½“&nbsp;forFeature()æ–¹æ³•æ³¨å†Œçš„æ¯ä¸ªå®ä½“éƒ½å°†è‡ªåŠ¨æ·»åŠ åˆ°é…ç½®å¯¹è±¡çš„å®ä½“æ•°ç»„ä¸­<br>&nbsp;&nbsp;}),],<br>&nbsp;&nbsp;controllers:&nbsp;[AppController],<br>&nbsp;&nbsp;providers:&nbsp;[AppService],<br>})<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AppModule&nbsp;{&nbsp;}<br></code>
```

æ¥ç€åœ¨`auth.entity.ts`æ–‡ä»¶ä¸­å»å†™å…³äºç”¨æˆ·è¡¨çš„é…ç½®ï¼Œæˆ‘è¿™é‡Œå°±åšä¸‰ä¸ªå­—æ®µid,username,password

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Column,&nbsp;PrimaryGeneratedColumn&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"typeorm"</span>;<br><br>@Entity()<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;NV_Users&nbsp;{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;idä¸ºä¸»é”®å¹¶ä¸”è‡ªåŠ¨é€’å¢<br>&nbsp;&nbsp;&nbsp;&nbsp;@PrimaryGeneratedColumn()<br>&nbsp;&nbsp;&nbsp;&nbsp;id:number<br><br>&nbsp;&nbsp;&nbsp;&nbsp;@Column()<br>&nbsp;&nbsp;&nbsp;&nbsp;username:string<br><br>&nbsp;&nbsp;&nbsp;&nbsp;@Column()<br>&nbsp;&nbsp;&nbsp;&nbsp;password:string<br>}<br><br></code>
```

ç„¶åä½¿ç”¨`TypeOrmModule.forFeature()`æ–¹æ³•æ³¨å†Œè¯¥è¡¨ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`@InjectRepository()`è£…é¥°å™¨å°†`NV_UsersRepository`æ³¨å…¥åˆ°`auth.service.ts`ä¸­ã€‚

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Module&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AuthService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.service'</span>;<br>import&nbsp;{&nbsp;AuthController&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.controller'</span>;<br>import&nbsp;{&nbsp;TypeOrmModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br>import&nbsp;{&nbsp;NV_Users&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./entities/auth.entity'</span>;<br><br><br>@Module({<br>&nbsp;&nbsp;imports:&nbsp;[TypeOrmModule.forFeature([NV_Users])],<br>&nbsp;&nbsp;controllers:&nbsp;[AuthController],<br>&nbsp;&nbsp;providers:&nbsp;[AuthService]<br>})<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthModule&nbsp;{&nbsp;}<br><br></code>
```

æ³¨å…¥`NV_UsersRepository`åˆ°`auth.service.ts`ä¸­ã€‚

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Injectable&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;CreateAuthDto&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./dto/create-auth.dto'</span>;<br>import&nbsp;{&nbsp;UpdateAuthDto&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./dto/update-auth.dto'</span>;<br>import&nbsp;{&nbsp;NV_Users&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./entities/auth.entity'</span>;<br>import&nbsp;{&nbsp;Repository&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'typeorm'</span>;<br>import&nbsp;{&nbsp;InjectRepository&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br><br><br>@Injectable()<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthService&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;constructor(@InjectRepository(NV_Users)&nbsp;private&nbsp;<span data-darkreader-inline-color="">readonly</span>&nbsp;user:Repository&lt;NV_Users&gt;){}<br>}<br><br></code>
```

æ¥ç€åœ¨`auth.controller.ts`å»å†™å¯¹åº”çš„æ–¹æ³•ï¼Œå»è°ƒç”¨`auth.service.ts`ä¸­å¯¹åº”çš„æ–¹æ³•ã€‚ä¸‹é¢æ˜¯`auth.controller.ts`æ–‡ä»¶ä»£ç 

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Controller,&nbsp;Post,&nbsp;Body&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AuthService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.service'</span>;<br>import&nbsp;{&nbsp;CreateAuthDto&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./dto/create-auth.dto'</span>;<br><br>@Controller(<span data-darkreader-inline-color="">'auth'</span>)<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthController&nbsp;{<br>&nbsp;&nbsp;constructor(private&nbsp;<span data-darkreader-inline-color="">readonly</span>&nbsp;authService:&nbsp;AuthService)&nbsp;{&nbsp;}<br><br><br>&nbsp;&nbsp;//&nbsp;æ³¨å†Œ<br>&nbsp;&nbsp;@Post(<span data-darkreader-inline-color="">"/signup"</span>)<br>&nbsp;&nbsp;signup(@Body()&nbsp;signupData:&nbsp;CreateAuthDto)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;this.authService.signup(signupData)<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;//&nbsp;ç™»å½•<br>&nbsp;&nbsp;@Post(<span data-darkreader-inline-color="">"/login"</span>)<br>&nbsp;&nbsp;login(@Body()&nbsp;loginData:&nbsp;CreateAuthDto)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;this.authService.login(signupData)<br>&nbsp;&nbsp;}<br>}<br><br></code>
```

å†™äº†è¿™ä¹ˆå¤šï¼Œå’±ä»¬å…ˆè·‘èµ·æ¥(`pnpm run start:dev`)çœ‹çœ‹`nv_users`è¿™å¼ è¡¨æœ‰æ²¡æœ‰åˆ›å»ºï¼Œæˆ‘è¿™é‡Œæ¨èå¤§å®¶å»è£…ä¸€ä¸ªvscodeæ’ä»¶

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

è£…äº†ä¹‹åvscodeå·¦è¾¹ä¼šå¤šä¸€ä¸ªè¿™ä¸ªä¸œè¥¿

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)å¦‚æœæœ‰`Navicat`è¿™ä¸ªè½¯ä»¶ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹æˆ‘ä»¬åˆ›å»ºçš„è¡¨ï¼š

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)è¿™é‡Œä¹Ÿæ˜¯åˆ›å»ºå¥½äº†`Navicat`ä¸­é•¿è¿™æ ·ï¼Œä¹Ÿæ˜¯éå¸¸çš„åƒã€‚

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

ç„¶åæˆ‘ä»¬å…ˆç®€å•å†™ä¸‹`auth.service.ts`ä¸­çš„ä»£ç 

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Injectable&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;CreateAuthDto&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./dto/create-auth.dto'</span>;<br>import&nbsp;{&nbsp;NV_Users&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./entities/auth.entity'</span>;<br>import&nbsp;{&nbsp;Repository&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'typeorm'</span>;<br>import&nbsp;{&nbsp;InjectRepository&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br><br><br>@Injectable()<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthService&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;constructor(@InjectRepository(NV_Users)&nbsp;private&nbsp;<span data-darkreader-inline-color="">readonly</span>&nbsp;user:&nbsp;Repository&lt;NV_Users&gt;)&nbsp;{&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;æ³¨å†Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;signup(signupData:&nbsp;CreateAuthDto)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(signupData);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">"æ³¨å†ŒæˆåŠŸ"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ç™»å½•<br>&nbsp;&nbsp;&nbsp;&nbsp;login(loginData:&nbsp;CreateAuthDto)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(loginData);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">"ç™»å½•æˆåŠŸ"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br></code>
```

æ¥ç€å°±æ˜¯æ¥æµ‹è¯•ä¸‹æ¥å£æœ‰æ²¡æœ‰é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨`apifox`è¿™ä¸ªè½¯ä»¶ï¼Œå½“ç„¶å…¶ä»–æ¥å£æµ‹è¯•è½¯ä»¶ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯”å¦‚postmanç­‰ç­‰ã€‚nestjsé»˜è®¤ç«¯å£æ˜¯3000ï¼Œå¯ä»¥åœ¨main.tså»ä¿®æ”¹ï¼Œæˆ‘è¿™é‡Œå°±ä½¿ç”¨é»˜è®¤çš„äº†,ç„¶åæ¥å£è·¯å¾„å°±æ˜¯`auth.controller.ts`ä¸­æ‹¼æ¥èµ·æ¥,æ¯”å¦‚æˆ‘è¿™é‡Œæ³¨å†Œæ¥å£å°±æ˜¯`/auth/signup`ï¼Œå…¶ä»–åŒç†ã€‚

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

æ¥å£æµ‹è¯•æ²¡é—®é¢˜ï¼Œæ¥ç€å°±æ˜¯å†™ä¸šåŠ¡ä»£ç äº†ï¼Œå†™ä¸šåŠ¡ä»£ç å‰éœ€è¦å®‰è£…å‡ ä¸ªåŒ…ï¼š

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">pnpm&nbsp;i&nbsp;bcryptjs&nbsp;//&nbsp;è¿™ä¸ªæ˜¯å¯¹ç”¨æˆ·å¯†ç è¿›è¡ŒåŠ å¯†çš„<br>pnpm&nbsp;i&nbsp;@nestjs/jwt&nbsp;//&nbsp;ç”¨äºç”Ÿæˆtoken<br></code>
```

å…¶ä¸­ä¹Ÿæ˜¯ç”¨åˆ°äº†å‡ ä¸ªæ–¹æ³•ï¼š`bcryptjs.hashSync()`æ–¹æ³•æ˜¯å¯¹ç”¨æˆ·å¯†ç è¿›è¡ŒåŠ å¯†ç”¨çš„ï¼Œ`hashSync()`æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç”¨æˆ·å¯†ç ï¼Œç¬¬äºŒä¸ªä¸ºå¯†ç ç›(ç®€å•ç†è§£ä¸ºåŠ å¯†çš„ç¨‹åº¦)ã€‚`bcryptjs.compareSync()`æ–¹æ³•æ˜¯å¯¹ç”¨æˆ·çš„å¯†ç å’ŒåŠ å¯†åçš„å¯†ç è¿›è¡Œæ¯”è¾ƒçš„ï¼Œå¦‚æœæ­£ç¡®è¿”å›trueï¼Œé”™è¯¯åˆ™è¿”å›fasle,ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç™»å½•æ—¶ç”¨æˆ·è¾“å…¥çš„å¯†ç ï¼Œç¬¬äºŒä¸ªä¸ºæŸ¥å‡ºæ¥çš„åŠ å¯†åçš„å¯†ç ã€‚è¿™é‡Œæä¸€ä¸‹ï¼ŒåŠ å¯†å¯†ç çš„æ–¹æ³•æ˜¯ä¸å¯é€†çš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è§£å¯†çš„åŠŸèƒ½ï¼Œè¿™æ ·åšä¹Ÿæ˜¯ä¿è¯ç”¨æˆ·çš„å®‰å…¨ã€‚`JwtService.sign()`æ–¹æ³•å³ç”Ÿæˆtokençš„æ–¹æ³•ï¼Œå‚æ•°å¯ä¼ å…¥æˆ‘ä»¬æƒ³ä¼ å…¥ç»™å‰ç«¯çš„ç”¨æˆ·å¯¹è±¡ï¼Œè¿™æ ·å‰ç«¯å¯ä»¥æŠŠtokenæ‹¿å»è§£å¯†ï¼Œæ‹¿åˆ°ç”¨æˆ·å¯¹è±¡ï¼Œåˆ‡è®°ä¸èƒ½å°†å¯†ç ä¼ å…¥ã€‚

æˆ‘ä»¬å…ˆæ–°å»ºä¸€ä¸ªå…³äºtokenç›¸å…³çš„é…ç½®æ–‡ä»¶`constants.ts`

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">export</span>&nbsp;const&nbsp;jwtConstants&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;secret:&nbsp;<span data-darkreader-inline-color="">"leeKey"</span>,&nbsp;//&nbsp;å¯†é’¥<br>&nbsp;&nbsp;&nbsp;&nbsp;expiresIn:&nbsp;<span data-darkreader-inline-color="">"60s"</span>&nbsp;//&nbsp;tokenæœ‰æ•ˆæ—¶é—´&nbsp;&nbsp;<br>}<br></code>
```

æ¥ç€åœ¨`auth.module.ts`ä¸­é…ç½®

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Module&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AuthService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.service'</span>;<br>import&nbsp;{&nbsp;AuthController&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.controller'</span>;<br>import&nbsp;{&nbsp;TypeOrmModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br>import&nbsp;{&nbsp;NV_Users&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./entities/auth.entity'</span>;<br>import&nbsp;{&nbsp;JwtModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/jwt'</span>;<br>import&nbsp;{&nbsp;jwtConstants&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"./constants"</span><br><br><br>@Module({<br>&nbsp;&nbsp;imports:&nbsp;[TypeOrmModule.forFeature([NV_Users]),&nbsp;JwtModule.register({<br>&nbsp;&nbsp;&nbsp;&nbsp;secret:&nbsp;jwtConstants.secret,<br>&nbsp;&nbsp;&nbsp;&nbsp;signOptions:&nbsp;{&nbsp;expiresIn:&nbsp;jwtConstants.expiresIn&nbsp;}<br>&nbsp;&nbsp;})],<br>&nbsp;&nbsp;controllers:&nbsp;[AuthController],<br>&nbsp;&nbsp;providers:&nbsp;[AuthService]<br>})<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthModule&nbsp;{&nbsp;}<br><br></code>
```

ç™»å½•æ³¨å†Œæˆ‘è¿™é‡Œå°±ä¸€æ¬¡æ€§å†™å®Œäº†ï¼Œä»£ç çœ‹ä¸‹é¢ğŸ‘‡

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;BadRequestException,&nbsp;Injectable&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;CreateAuthDto&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./dto/create-auth.dto'</span>;<br>import&nbsp;{&nbsp;NV_Users&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./entities/auth.entity'</span>;<br>import&nbsp;{&nbsp;Repository&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'typeorm'</span>;<br>import&nbsp;{&nbsp;InjectRepository&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br>import&nbsp;*&nbsp;as&nbsp;bcryptjs&nbsp;from&nbsp;<span data-darkreader-inline-color="">"bcryptjs"</span><br>import&nbsp;{&nbsp;JwtService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/jwt"</span><br><br><br>@Injectable()<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthService&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;constructor(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@InjectRepository(NV_Users)&nbsp;private&nbsp;<span data-darkreader-inline-color="">readonly</span>&nbsp;user:&nbsp;Repository&lt;NV_Users&gt;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;<span data-darkreader-inline-color="">readonly</span>&nbsp;JwtService:&nbsp;JwtService<br>&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;{&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;æ³¨å†Œ<br>&nbsp;&nbsp;&nbsp;&nbsp;async&nbsp;signup(signupData:&nbsp;CreateAuthDto)&nbsp;{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;findUser&nbsp;=&nbsp;await&nbsp;this.user.findOne({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">where</span>:&nbsp;{&nbsp;username:&nbsp;signupData.username&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(findUser&nbsp;&amp;&amp;&nbsp;findUser.username&nbsp;===&nbsp;signupData.username)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">"ç”¨æˆ·å·²å­˜åœ¨"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;å¯¹å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signupData.password&nbsp;=&nbsp;bcryptjs.hashSync(signupData.password,&nbsp;10)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await&nbsp;this.user.save(signupData)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">"æ³¨å†ŒæˆåŠŸ"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ç™»å½•<br>&nbsp;&nbsp;&nbsp;&nbsp;async&nbsp;login(loginData:&nbsp;CreateAuthDto)&nbsp;{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;findUser&nbsp;=&nbsp;await&nbsp;this.user.findOne({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">where</span>:&nbsp;{&nbsp;username:&nbsp;loginData.username&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;æ²¡æœ‰æ‰¾åˆ°<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!findUser)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;new&nbsp;BadRequestException(<span data-darkreader-inline-color="">"ç”¨æˆ·ä¸å­˜åœ¨"</span>)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;æ‰¾åˆ°äº†å¯¹æ¯”å¯†ç <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;compareRes:&nbsp;boolean&nbsp;=&nbsp;bcryptjs.compareSync(loginData.password,&nbsp;findUser.password)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;å¯†ç ä¸æ­£ç¡®<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!compareRes)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;new&nbsp;BadRequestException(<span data-darkreader-inline-color="">"å¯†ç ä¸æ­£ç¡®"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;payload&nbsp;=&nbsp;{&nbsp;username:&nbsp;findUser.username&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_token:&nbsp;this.JwtService.sign(payload),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg:&nbsp;<span data-darkreader-inline-color="">"ç™»å½•æˆåŠŸ"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br></code>
```

æ¥ç€æˆ‘ä»¬æ³¨å†Œä¸¤ä¸ªç”¨æˆ·è¯•ä¸€è¯•

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜,æ¥ç€æµ‹è¯•ç™»å½•ï¼Œä¹Ÿæ˜¯æ­£ç¡®è¿”å›token

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

ä»¥ä¸Šæ˜¯å…³äºç™»å½•æ³¨å†ŒåŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹èº«ä»½éªŒè¯è¿™ä¸€å—çš„åŠŸèƒ½ï¼Œå¦‚ä½•å®Œæˆã€‚é¦–å…ˆæˆ‘ä»¬æ–°å»ºæ–‡ä»¶`/common/public.decorator.ts`,åˆ›å»ºè‡ªå®šä¹‰è£…é¥°å™¨

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;SetMetadata&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/common"</span>;<br><br><span data-darkreader-inline-color="">export</span>&nbsp;const&nbsp;IS_PUBLIC_KEY&nbsp;=&nbsp;<span data-darkreader-inline-color="">'isPublic'</span><br><span data-darkreader-inline-color="">export</span>&nbsp;const&nbsp;Public&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;SetMetadata(IS_PUBLIC_KEY,&nbsp;<span data-darkreader-inline-color="">true</span>);<br></code>
```

æ¥ç€æˆ‘ä»¬å®‰è£…è¿™å‡ ä¸ªåŒ…

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">pnpm&nbsp;install&nbsp;--save&nbsp;@nestjs/passport&nbsp;passport-jwt<br>pnpm&nbsp;install&nbsp;@types/passport-jwt&nbsp;--save-dev<br></code>
```

æ–°å»º`jwt-auth.grard.ts`æ–‡ä»¶ï¼Œç”¨äºå…¨å±€å®ˆå«ï¼Œå°†æœªæºå¸¦tokençš„æ¥å£è¿›è¡Œæ‹¦æˆªï¼Œä»£ç ğŸ‘‡

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;ExecutionContext,&nbsp;Injectable&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/common"</span>;<br>import&nbsp;{&nbsp;AuthGuard&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/passport"</span><br>import&nbsp;{&nbsp;Reflector&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/core"</span>;<br>import&nbsp;{&nbsp;Observable&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"rxjs"</span><br>import&nbsp;{&nbsp;IS_PUBLIC_KEY&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"src/common/public.decorator"</span>;<br><br><br>@Injectable()<br><br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;jwtAuth&nbsp;extends&nbsp;AuthGuard(<span data-darkreader-inline-color="">"jwt"</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;constructor(private&nbsp;reflector:&nbsp;Reflector)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super()<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;canActivate(context:&nbsp;ExecutionContext):&nbsp;boolean&nbsp;|&nbsp;Promise&lt;boolean&gt;&nbsp;|&nbsp;Observable&lt;boolean&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;isPublic&nbsp;=&nbsp;this.reflector.getAllAndOverride&lt;boolean&gt;(IS_PUBLIC_KEY,&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.getHandler(),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.getClass()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(isPublic,&nbsp;<span data-darkreader-inline-color="">"isPublic"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(isPublic)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">true</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;super.canActivate(context)<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></code>
```

æ–°å»º`jwt-auth.strategy.ts`,è¯¥æ–‡ä»¶ä¸ºéªŒè¯ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯éªŒè¯å‰ç«¯è¯·æ±‚å¤´ä¸­æºå¸¦çš„tokenï¼Œä»£ç ğŸ‘‡

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Injectable&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/common"</span>;<br>import&nbsp;{&nbsp;PassportStrategy&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"@nestjs/passport"</span>;<br>import&nbsp;{&nbsp;ExtractJwt,&nbsp;Strategy&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"passport-jwt"</span>;<br>import&nbsp;{&nbsp;jwtConstants&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"./constants"</span>;<br><br><br><span data-darkreader-inline-color="">export</span>&nbsp;interface&nbsp;JwtPayload&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;username:&nbsp;string<br>}<br><br><br>@Injectable()<br>//&nbsp;éªŒè¯è¯·æ±‚å¤´ä¸­çš„token<br><span data-darkreader-inline-color="">export</span>&nbsp;default&nbsp;class&nbsp;JwtAuthStrategy&nbsp;extends&nbsp;PassportStrategy(Strategy,&nbsp;<span data-darkreader-inline-color="">"jwt"</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span><span data-darkreader-inline-color="">constructor</span></span>()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jwtFromRequest:&nbsp;ExtractJwt.fromAuthHeaderAsBearerToken(),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignoreExpiration:&nbsp;<span data-darkreader-inline-color="">false</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;secretOrKey:&nbsp;jwtConstants.secret<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;async&nbsp;validate(payload:&nbsp;JwtPayload)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(payload.username);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;{&nbsp;username&nbsp;}&nbsp;=&nbsp;payload<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;username<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></code>
```

æ¥ç€åœ¨`auth.module.ts`çš„`providers`ä¸­é…ç½®`JwtAuthStrategy`,ä»£ç ğŸ‘‡

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Module&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AuthService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.service'</span>;<br>import&nbsp;{&nbsp;AuthController&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.controller'</span>;<br>import&nbsp;{&nbsp;TypeOrmModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br>import&nbsp;{&nbsp;NV_Users&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./entities/auth.entity'</span>;<br>import&nbsp;{&nbsp;JwtModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/jwt'</span>;<br>import&nbsp;{&nbsp;jwtConstants&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"./constants"</span><br>import&nbsp;{&nbsp;JwtAuthStrategy&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">"./jwt-auth.strategy"</span><br><br><br>@Module({<br>&nbsp;&nbsp;imports:&nbsp;[TypeOrmModule.forFeature([NV_Users]),&nbsp;JwtModule.register({<br>&nbsp;&nbsp;&nbsp;&nbsp;secret:&nbsp;jwtConstants.secret,<br>&nbsp;&nbsp;&nbsp;&nbsp;signOptions:&nbsp;{&nbsp;expiresIn:&nbsp;jwtConstants.expiresIn&nbsp;}<br>&nbsp;&nbsp;})],<br>&nbsp;&nbsp;controllers:&nbsp;[AuthController],<br>&nbsp;&nbsp;providers:&nbsp;[AuthService,&nbsp;JwtAuthStrategy]<br>})<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthModule&nbsp;{&nbsp;}<br><br></code>
```

æœ€ååœ¨`app.module.ts`å°†å…¶æ³¨å†Œä¸ºå…¨å±€å®ˆå«

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Module&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AppController&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./app.controller'</span>;<br>import&nbsp;{&nbsp;AppService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./app.service'</span>;<br>import&nbsp;{&nbsp;AuthModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth/auth.module'</span>;<br>import&nbsp;{&nbsp;TypeOrmModule&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/typeorm'</span>;<br>import&nbsp;{&nbsp;APP_GUARD&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/core'</span>;<br>import&nbsp;{&nbsp;JwtAuthGuard&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth/jwt-auth.grard'</span>;<br><br>@Module({<br>&nbsp;&nbsp;imports:&nbsp;[AuthModule,&nbsp;TypeOrmModule.forRoot({<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;<span data-darkreader-inline-color="">'mysql'</span>,&nbsp;//&nbsp;æ•°æ®åº“ç±»å‹<br>&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;<span data-darkreader-inline-color="">'localhost'</span>,&nbsp;//&nbsp;ä¸»æœºå<br>&nbsp;&nbsp;&nbsp;&nbsp;port:&nbsp;3306,&nbsp;//&nbsp;ç«¯å£<br>&nbsp;&nbsp;&nbsp;&nbsp;username:&nbsp;<span data-darkreader-inline-color="">'root'</span>,&nbsp;//&nbsp;ç”¨æˆ·å<br>&nbsp;&nbsp;&nbsp;&nbsp;password:&nbsp;<span data-darkreader-inline-color="">'123456'</span>,&nbsp;//&nbsp;å¯†ç <br>&nbsp;&nbsp;&nbsp;&nbsp;database:&nbsp;<span data-darkreader-inline-color="">'nestjs'</span>,&nbsp;//&nbsp;æ•°æ®åº“åç§°<br>&nbsp;&nbsp;&nbsp;&nbsp;synchronize:&nbsp;<span data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;retryDelay:&nbsp;500,&nbsp;//é‡è¯•è¿æ¥æ•°æ®åº“é—´éš”<br>&nbsp;&nbsp;&nbsp;&nbsp;retryAttempts:&nbsp;10,//é‡è¯•è¿æ¥æ•°æ®åº“çš„æ¬¡æ•°<br>&nbsp;&nbsp;&nbsp;&nbsp;autoLoadEntities:&nbsp;<span data-darkreader-inline-color="">true</span>,&nbsp;//å¦‚æœä¸º<span data-darkreader-inline-color="">true</span>,å°†è‡ªåŠ¨åŠ è½½å®ä½“&nbsp;forFeature()æ–¹æ³•æ³¨å†Œçš„æ¯ä¸ªå®ä½“éƒ½å°†è‡ªåŠ¨æ·»åŠ åˆ°é…ç½®å¯¹è±¡çš„å®ä½“æ•°ç»„ä¸­<br>&nbsp;&nbsp;}),],<br>&nbsp;&nbsp;controllers:&nbsp;[AppController],<br>&nbsp;&nbsp;//&nbsp;æ³¨å†Œä¸ºå…¨å±€å®ˆå«<br>&nbsp;&nbsp;providers:&nbsp;[AppService,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;provide:&nbsp;APP_GUARD,<br>&nbsp;&nbsp;&nbsp;&nbsp;useClass:&nbsp;JwtAuthGuard<br>&nbsp;&nbsp;}],<br>})<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AppModule&nbsp;{&nbsp;}<br><br></code>
```

ä»¥ä¸Šé…ç½®å®Œæˆåï¼Œå†æ¬¡è¯·æ±‚æ³¨å†Œæ¥å£,è¿”å›401ï¼Œè¡¨ç¤ºæˆ‘ä»¬æ²¡æœ‰æƒé™

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

ç„¶åæˆ‘ä»¬ç»™é€šç”¨æ¥å£(æ³¨å†Œå’Œç™»å½•æ¥å£)éƒ½åŠ ä¸Š@Publicè£…é¥°å™¨å

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">import&nbsp;{&nbsp;Controller,&nbsp;Post,&nbsp;Body&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'@nestjs/common'</span>;<br>import&nbsp;{&nbsp;AuthService&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./auth.service'</span>;<br>import&nbsp;{&nbsp;CreateAuthDto&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./dto/create-auth.dto'</span>;<br>import&nbsp;{&nbsp;Public&nbsp;}&nbsp;from&nbsp;<span data-darkreader-inline-color="">'src/common/public.decorator'</span>;<br><br>@Controller(<span data-darkreader-inline-color="">'auth'</span>)<br><span data-darkreader-inline-color="">export</span>&nbsp;class&nbsp;AuthController&nbsp;{<br>&nbsp;&nbsp;constructor(private&nbsp;<span data-darkreader-inline-color="">readonly</span>&nbsp;authService:&nbsp;AuthService)&nbsp;{&nbsp;}<br><br><br>&nbsp;&nbsp;//&nbsp;æ³¨å†Œ<br>&nbsp;&nbsp;@Public()<br>&nbsp;&nbsp;@Post(<span data-darkreader-inline-color="">"/signup"</span>)<br>&nbsp;&nbsp;//&nbsp;@Public()<br>&nbsp;&nbsp;signup(@Body()&nbsp;signupData:&nbsp;CreateAuthDto)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;this.authService.signup(signupData)<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;//&nbsp;ç™»å½•<br>&nbsp;&nbsp;@Public()<br>&nbsp;&nbsp;@Post(<span data-darkreader-inline-color="">"/login"</span>)<br>&nbsp;&nbsp;login(@Body()&nbsp;loginData:&nbsp;CreateAuthDto)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;this.authService.login(loginData)<br>&nbsp;&nbsp;}<br>}<br><br></code>
```

å†å»è¯·æ±‚ï¼Œå‘ç°æ²¡æœ‰é—®é¢˜

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

æºç åœ°å€<sup>[1]</sup>

ä»¥ä¸Šå°±æ˜¯å…³äºå…¨å±€èº«ä»½éªŒè¯çš„å†…å®¹äº†ï¼Œè¿™æ ·åšä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦ç»™ä½ é€šç”¨æ¥å£åŠ ä¸Š@Pulic()è£…é¥°å™¨å³å¯ï¼Œéšåæˆ‘ä»¬éœ€è¦éªŒè¯çš„æ¥å£å°±ä¸ç”¨ä¸€ä¸ªä¸€ä¸ªå»åŠ å®ˆå«äº†ã€‚ä»¥ä¸Šå°±æ˜¯æœ¬æ¬¡æ–‡ç« çš„å…¨éƒ¨å†…å®¹ï¼Œåˆ›ä½œä¸æ˜“ï¼Œå¦‚æœ‰å¸®åŠ©ï¼Œè®°å¾—ç‚¹èµæ”¶è—ï¼Œæ„Ÿè°¢æ‚¨çš„è§‚çœ‹ã€‚

> â
> 
> åŸæ–‡åœ°å€ï¼šhttps://juejin.cn/post/7268622342728695860
> 
> åŸæ–‡ä½œè€…: Leec
> 
> æœ¬æ–‡æ¥è‡ªæ˜é‡‘æ–‡ç« åˆ†äº«
> 
> â

## æœ€å

è§‰å¾—æœ¬æ–‡æœ‰ç”¨çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å¸®å¿™ç‚¹ä¸ªâ€œåœ¨çœ‹â€ï¼Œè®©æ›´å¤šçš„æœ‹å‹çœ‹åˆ°å’±ä»¬çš„æ–‡ç« ã€‚

### Reference

\[1\]

https://gitee.com/xu-jile/nest-auth.git: https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxu-jile%2Fnest-auth.git