关注公众号 前端界，回复“加群”

加入我们一起学习，天天进步

_本文的起因是有在代码仓库发包后，同事问我“为什么package.json 里的版本还是原来的，有没有更新？”，这个时候我意识到，我们完全没有必要在每次发布的时候还特意去关注这个仓库的版本号，只要在发布打tag的时候同步一下即可，于是有了本文的实践。_

## node.js 部分，我们得有一个更改仓库代码的脚本留给ci执行

我们首先需要在工程目录中的 `./script/..`目录下增加一个 `update-version.js`脚本

```
<br><span data-darkreader-inline-color="">//update-version.js</span><br><br><span data-darkreader-inline-color="">const</span>&nbsp;path&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'path'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;fs&nbsp;=&nbsp;<span data-darkreader-inline-color="">require</span>(<span data-darkreader-inline-color="">'fs'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;newVersion&nbsp;=&nbsp;process.argv[<span data-darkreader-inline-color="">2</span>].replace(<span data-darkreader-inline-color="">/^v/</span>,&nbsp;<span data-darkreader-inline-color="">''</span>);;&nbsp;<span data-darkreader-inline-color="">//&nbsp;获取命令行参数中的新版本号,并过滤v字头</span><br><br><span data-darkreader-inline-color="">if</span>&nbsp;(!newVersion)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">'请传入新版本号，版本号遵循semver规范&nbsp;.eg:&nbsp;1.0.0,&nbsp;1.0.1,&nbsp;1.1.0'</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;process.exit(<span data-darkreader-inline-color="">1</span>);<br><br>}<br><br><span data-darkreader-inline-color="">//&nbsp;获取当前命令行上下文路径</span><br><br><span data-darkreader-inline-color="">const</span>&nbsp;currentDirectory&nbsp;=&nbsp;process.cwd();<br><br><span data-darkreader-inline-color="">//&nbsp;获取&nbsp;package.json&nbsp;文件中的版本号</span><br><span data-darkreader-inline-color="">const</span>&nbsp;packageJsonPath&nbsp;=&nbsp;path.join(currentDirectory,&nbsp;<span data-darkreader-inline-color="">'package.json'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;packageJsonContent&nbsp;=&nbsp;fs.readFileSync(packageJsonPath,&nbsp;<span data-darkreader-inline-color="">'utf8'</span>);<br><span data-darkreader-inline-color="">const</span>&nbsp;packageJson&nbsp;=&nbsp;<span data-darkreader-inline-color="">JSON</span>.parse(packageJsonContent);<br><span data-darkreader-inline-color="">const</span>&nbsp;currentVersion&nbsp;=&nbsp;packageJson.version;<br><br><span data-darkreader-inline-color="">//&nbsp;更新&nbsp;package.json&nbsp;文件中的版本号</span><br><br>packageJson.version&nbsp;=&nbsp;newVersion;<br>fs.writeFileSync(packageJsonPath,&nbsp;<span data-darkreader-inline-color="">JSON</span>.stringify(packageJson,&nbsp;<span data-darkreader-inline-color="">null</span>,&nbsp;<span data-darkreader-inline-color="">2</span>));<br><span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">`版本号已从&nbsp;<span data-darkreader-inline-color="">${currentVersion}</span>&nbsp;更新为&nbsp;<span data-darkreader-inline-color="">${newVersion}</span>`</span>);<br><br>复制代码<br>
```

接下来在 package.json script 配置后可以直接使用 `npm run version <version>` 中触发变更版本号脚本。当然这个前提是想要让这个脚本保留给开发者命令行使用。

```
<br>{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">"name"</span>:&nbsp;<span data-darkreader-inline-color="">"version&nbsp;workflow"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">"version"</span>:&nbsp;<span data-darkreader-inline-color="">"1.0.0"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">"description"</span>:&nbsp;<span data-darkreader-inline-color="">"version&nbsp;update&nbsp;demo"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">"main"</span>:&nbsp;<span data-darkreader-inline-color="">"index.js"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">"scripts"</span>:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">"version"</span>:&nbsp;<span data-darkreader-inline-color="">"node&nbsp;./scripts/update-version.js"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//...</span><br><br>}<br><br>复制代码<br>
```

## CI :如何让发布包的行为直接和代码仓库中的版本号同步？

接下来算重头戏，如何让发布包的行为直接和代码仓库中的版本号同步？这里我们使用的是github 提供的github action<sup data-darkreader-inline-color="">[1]</sup>,具体操作和语法可以查看一下官方文档，本文就不过多展开。

我们需要在仓库根目录增加如下路径的文件 `.github/workflows/update-action.yml`

```
<br><span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Update</span>&nbsp;<span data-darkreader-inline-color="">Package</span>&nbsp;<span data-darkreader-inline-color="">Version</span><br><br><span data-darkreader-inline-color="">on:</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">release:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">types:</span>&nbsp;<span data-darkreader-inline-color="">[released]</span><br><br><span data-darkreader-inline-color="">jobs:</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">update:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">runs-on:</span>&nbsp;<span data-darkreader-inline-color="">ubuntu-latest</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">steps:</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Checkout</span>&nbsp;<span data-darkreader-inline-color="">code</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">uses:</span>&nbsp;<span data-darkreader-inline-color="">actions/checkout@v3</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Update</span>&nbsp;<span data-darkreader-inline-color="">package.json</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;./scripts/update-version.js&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_TOKEN:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Commit</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;user.name&nbsp;"Your&nbsp;github&nbsp;name"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;user.email&nbsp;"your&nbsp;github&nbsp;email"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;add&nbsp;.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;commit&nbsp;-m&nbsp;"Update&nbsp;version&nbsp;to&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}&nbsp;for&nbsp;release&nbsp;${{&nbsp;github.ref&nbsp;}}"<br></span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Push</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">uses:</span>&nbsp;<span data-darkreader-inline-color="">ad-m/github-push-action@master</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">with:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">github_token:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br><span data-darkreader-inline-color="">复制代码</span><br>
```

我们在 `release` hook 中的 `released` 状态下增加了一个 update job。它会做下面几件事情（在脚本步骤中有）

1.  【Checkout code】 切出新的代码分支;
    
2.  【 Update package.json】在新分支执行 update-version.js 传入`tag_name`更新我们的工程版本号;
    
3.  【Commit changes】以你定制的 git config user 信息创建一个新提交;
    
4.  【Push changes】推送变更回到主干;
    

ps：正确来说应该在发布执行动作前`prereleased`执行我们的 job 但是没用这个的原因如下：

> \*\*Note:\*\*<sup data-darkreader-inline-color="">[2]</sup>  The `prereleased` type will not trigger for pre-releases published from draft releases, but the `published` type will trigger. If you want a workflow to run when stable _and_ pre-releases publish, subscribe to `published` instead of `released` and `prereleased`.

当这个脚本推送后，执行发布后自动更新版本，不用在关注这个版本修改问题。你会得到下面的效果。

在你的仓库发布界面填写正确tag后发布![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

触发update job 更改完成![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

## 你可能遇到最多的坑

1.  action 执行失败
    

> `Process completed with exit code 129." Node.js 12 actions are deprecated. Please update the following actions to use Node.js 16: actions/checkout@v2. For more information, see https://github.blog/changelog/2022-09-22-github-actions-all-actions-will-begin-running-on-node16-instead-of-node12/.`

这是由于默认action job 执行环境的nodejs 版本与actions 包中执行脚本不匹配导致，所以一定要使用 checkout@v3 版本 `actions/checkout@v3`

2.  各种不熟悉 action 语法取值导致的问题
    

## 可以优化的地方

我们前面提交的这个流程发布还是有个问题，你永远有个更超前的 commit hash 在你发布的 tag 之后

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E) 所以这个action 还有需要继续优化的地方,那就是同步更新`tag hash`

```
<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Update</span>&nbsp;<span data-darkreader-inline-color="">Package</span>&nbsp;<span data-darkreader-inline-color="">Version</span><br><br><span data-darkreader-inline-color="">on:</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">release:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">types:</span>&nbsp;<span data-darkreader-inline-color="">[released]</span><br><br><span data-darkreader-inline-color="">jobs:</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">update:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">runs-on:</span>&nbsp;<span data-darkreader-inline-color="">ubuntu-latest</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">steps:</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Checkout</span>&nbsp;<span data-darkreader-inline-color="">code</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">uses:</span>&nbsp;<span data-darkreader-inline-color="">actions/checkout@v3</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Update</span>&nbsp;<span data-darkreader-inline-color="">package.json</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;./scripts/update-version.js&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_TOKEN:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Commit</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;user.name&nbsp;"Your&nbsp;github&nbsp;name"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;user.email&nbsp;"your&nbsp;github&nbsp;email"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;add&nbsp;.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;commit&nbsp;-m&nbsp;"Update&nbsp;version&nbsp;to&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}&nbsp;for&nbsp;release&nbsp;${{&nbsp;github.ref&nbsp;}}"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git_hash=$(git&nbsp;rev-parse&nbsp;--short&nbsp;HEAD)<br></span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Push</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">uses:</span>&nbsp;<span data-darkreader-inline-color="">ad-m/github-push-action@master</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">with:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">github_token:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Tag</span>&nbsp;<span data-darkreader-inline-color="">Push</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;tag&nbsp;-f&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}&nbsp;$git_hash<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;push&nbsp;--force&nbsp;origin&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_TOKEN:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br><span data-darkreader-inline-color="">复制代码</span><br>
```

这里相比之前的版本增加了 `Tag Push changes` 这个步骤，在最后获取这个版本更新产生的 `$git_hash`强制更新到发布的 tag 上。

我们看看效果![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

最后我们看版本发布管理中的 tag hash ![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E) 搞定!

## 可以再优化的地方

现在我们还有个问题，就是在执行 `Commit changes` 这个步骤时每次 `git config user.name "Your github name" git config user.email "your github email"` 这里是写死的，我们可以根据 GitHub Actions 中有一些预设的环境变量可以读取到当前用户的账号和邮箱信息。通过 `${{ env.GITHUB_ACTOR }}` 获取到当前执行的 Actions 的用户账号，通过 `${{ env.GITHUB_ACTOR }}@users.noreply.github.com` 获取到当前执行的 Actions 的用户邮箱（该邮箱为 noreply 邮箱，用于 GitHub 的通知，无法发送邮件）。注意，该邮箱不一定是用户本身的真实邮箱，可能是 GitHub 默认的邮箱。

> 如果需要获取当前 GitHub 账号的真实邮箱地址，可以通过 GitHub REST API 进行查询，具体可以参考官方文档：<sup data-darkreader-inline-color="">[3]</sup>

这样我们就需要在`Commit Changes`之前再加一个`Set Git user`步骤

```
<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Set</span>&nbsp;<span data-darkreader-inline-color="">Git</span>&nbsp;<span data-darkreader-inline-color="">user</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_ACTOR:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;github.actor&nbsp;}}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_EMAIL:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;github.actor&nbsp;}}@users.noreply.github.com<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;--global&nbsp;user.name&nbsp;"${{&nbsp;env.GITHUB_ACTOR&nbsp;}}"<br>&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;--global&nbsp;user.email&nbsp;"${{&nbsp;env.GITHUB_EMAIL&nbsp;}}"<br>复制代码</span><br>
```

这样我们最终的 Github action 脚本长这样

```
<br><span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Update</span>&nbsp;<span data-darkreader-inline-color="">Package</span>&nbsp;<span data-darkreader-inline-color="">Version</span><br><br><span data-darkreader-inline-color="">on:</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">release:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">types:</span>&nbsp;<span data-darkreader-inline-color="">[released]</span><br><br><span data-darkreader-inline-color="">jobs:</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">update:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">runs-on:</span>&nbsp;<span data-darkreader-inline-color="">ubuntu-latest</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">steps:</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Checkout</span>&nbsp;<span data-darkreader-inline-color="">code</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">uses:</span>&nbsp;<span data-darkreader-inline-color="">actions/checkout@v3</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Update</span>&nbsp;<span data-darkreader-inline-color="">package.json</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;./scripts/update-version.js&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_TOKEN:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Set</span>&nbsp;<span data-darkreader-inline-color="">Git</span>&nbsp;<span data-darkreader-inline-color="">user</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_ACTOR:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;github.actor&nbsp;}}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_EMAIL:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;github.actor&nbsp;}}@users.noreply.github.com<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;--global&nbsp;user.name&nbsp;"${{&nbsp;env.GITHUB_ACTOR&nbsp;}}"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;config&nbsp;--global&nbsp;user.email&nbsp;"${{&nbsp;env.GITHUB_EMAIL&nbsp;}}"<br></span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Commit</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;add&nbsp;.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;commit&nbsp;-m&nbsp;"Update&nbsp;version&nbsp;to&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}&nbsp;for&nbsp;release&nbsp;${{&nbsp;github.ref&nbsp;}}"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git_hash=$(git&nbsp;rev-parse&nbsp;--short&nbsp;HEAD)<br></span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Push</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">uses:</span>&nbsp;<span data-darkreader-inline-color="">ad-m/github-push-action@master</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">with:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">github_token:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">-</span>&nbsp;<span data-darkreader-inline-color="">name:</span>&nbsp;<span data-darkreader-inline-color="">Tag</span>&nbsp;<span data-darkreader-inline-color="">Push</span>&nbsp;<span data-darkreader-inline-color="">changes</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">run:</span>&nbsp;<span data-darkreader-inline-color="">|<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;tag&nbsp;-f&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}&nbsp;$git_hash<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;git&nbsp;push&nbsp;--force&nbsp;origin&nbsp;${{&nbsp;github.event.release.tag_name&nbsp;}}<br></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">env:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">GITHUB_TOKEN:</span>&nbsp;<span data-darkreader-inline-color="">${{</span>&nbsp;secrets.GITHUB_TOKEN&nbsp;}}<br><br><span data-darkreader-inline-color="">复制代码</span><br>
```

## 最后

如果我的文章对你有帮助欢迎点赞+收藏支持

关于本文  

## 作者：Jervis\_cen

https://juejin.cn/post/7220164534316433467

最后

加我微信，拉你进前端进阶、面试交流群，互相监督学习进步等！

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

### 推荐链接

1.  [TypeScript中 interface 和 type 的区别，你真的懂了吗](http://mp.weixin.qq.com/s?__biz=MzkyOTE5NzQ2Nw==&mid=2247485013&idx=1&sn=9324e663eb2d6ed02a2f167e12b56692&chksm=c20c7aa1f57bf3b7f7e00ecc07d753a201ea08da5ad083dc5f70adc8553ef731f9e295afe8a2&scene=21#wechat_redirect)？
    
2.  [2022年，前端er们都在看哪些网站？](http://mp.weixin.qq.com/s?__biz=MzkyOTE5NzQ2Nw==&mid=2247485101&idx=1&sn=09322752bb7e63dea5286f9a0c51164a&chksm=c20c7a59f57bf34f2142aef77367ec01e1cd2471637920f48f53552eafcca8b35f93625eaec9&scene=21#wechat_redirect)
    
3.  [前端开发者应该知道的 Centos/Docker/Nginx/Node/Jenkins 操作（大量干货来袭）](http://mp.weixin.qq.com/s?__biz=MzkyOTE5NzQ2Nw==&mid=2247484619&idx=1&sn=e1e7345d6ac2f0c92c963f02d51c7230&chksm=c20c783ff57bf129b2501684d18e3be745b1e9c8279b1b0a22d05c14e57e4272e550db4363ff&scene=21#wechat_redirect)
    

创作不易，加个点赞、在看 支持一下哦！