## 前言

## 展示加载态 & 错误态，可以使用 React 自身能力

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;error&nbsp;?&nbsp;&lt;div&gt;error&lt;<span data-darkreader-inline-color="">/div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;loading&nbsp;?&nbsp;&lt;div&gt;loading&lt;/</span>div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;data<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;Suspense&nbsp;&amp;&nbsp;ErrorBoundery&nbsp;不一定在当前组件使用</span><br><span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;会一直冒泡到最外层,&nbsp;如触发页面级&nbsp;loading,&nbsp;而无需额外通讯</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;Suspense&nbsp;fallback={&lt;div&gt;loading&lt;<span data-darkreader-inline-color="">/div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ErrorBoundery&nbsp;fallback={&lt;div&gt;error&lt;/</span>div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/ErrorBoundery&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>Suspense&gt;<br>}<br></code>
```

## 如何才能拿到 Promise 的加载态 & 错误态

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[error,&nbsp;setError]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[loading,&nbsp;setLoading]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[data,&nbsp;setData]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;useEffect(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setLoading(<span data-darkreader-inline-color="">true</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>).then(<span>(<span>data</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setLoading(<span data-darkreader-inline-color="">false</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setData(data)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).catch(<span>(<span>error</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setError(error);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;[]);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;error&nbsp;?&nbsp;&lt;div&gt;error&lt;<span data-darkreader-inline-color="">/div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;loading&nbsp;?&nbsp;&lt;div&gt;loading&lt;/</span>div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;data<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;react-use</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;error,&nbsp;loading,&nbsp;data&nbsp;}&nbsp;=&nbsp;useAsync(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetcher(xxx),&nbsp;[]);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;error&nbsp;?&nbsp;&lt;div&gt;error&lt;<span data-darkreader-inline-color="">/div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;loading&nbsp;?&nbsp;&lt;div&gt;loading&lt;/</span>div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;data<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">const</span>&nbsp;promise&nbsp;=&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>);<br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;Suspense&nbsp;fallback={&lt;div&gt;loading&lt;<span data-darkreader-inline-color="">/div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ErrorBoundery&nbsp;fallback={&lt;div&gt;error&lt;/</span>div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Await&nbsp;resolver={promise}&gt;&lt;<span data-darkreader-inline-color="">/Await&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>ErrorBoundery&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Suspense&gt;<br>}<br></span></code>
```

## 谁在这么用：ReactRouter

_https://reactrouter.com/en/main/components/await_

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

它消费 Promise 的方式并不是最优的，但这不是重点。

而是我们有了另外一个选择，**在 Props 中传递 Promise 而不是其返回的 data。**

## 优势

## 首屏网络请求不再是副作用

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;重新&nbsp;render&nbsp;会再次触发请求</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;resultP&nbsp;=&nbsp;useRef(fetcher(<span data-darkreader-inline-color="">'xxx'</span>));<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;重新&nbsp;render&nbsp;会再次触发请求</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[resultP,&nbsp;setResultP]&nbsp;=&nbsp;useState(fetcher(<span data-darkreader-inline-color="">'xxx'</span>));<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;造成没必要的重新&nbsp;render</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[resultP,&nbsp;setResultP]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;useEffect(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResultP(fetcher(<span data-darkreader-inline-color="">'xxx'</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;[]);<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;重发请求无法触发&nbsp;render</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;resultP&nbsp;=&nbsp;useRef(fetcher(<span data-darkreader-inline-color="">'xxx'</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;useEffect(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultP.current&nbsp;=&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;[]);<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;react-use&nbsp;多此一举的&nbsp;useRefState</span><br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[resultP,&nbsp;setResultP]&nbsp;=&nbsp;useState(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>));<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;resultP&nbsp;=&nbsp;useMemo(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>),&nbsp;[]);<br>}<br></code>
```

## 如何重发请求，状态里保存新的 Promise 就是了

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;请求函数想调用就调用,&nbsp;何必使用&nbsp;react-use&nbsp;要区分&nbsp;useAsync&nbsp;/&nbsp;useAsyncFn&nbsp;/&nbsp;useAsyncRetry</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[resultP,&nbsp;setResultP]&nbsp;=&nbsp;useState(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FilterForm&nbsp;onSubmit={<span>(<span>filterCondition</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResultP(fetcher(filterCondition))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}}&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Suspense&nbsp;fallback={&lt;div&gt;loading&lt;<span data-darkreader-inline-color="">/div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ErrorBoundery&nbsp;fallback={&lt;div&gt;error&lt;/</span>div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Await&nbsp;resolver={promise}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Table&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Await&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>ErrorBoundery&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Suspense&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>&gt;<br>}<br></code>
```

## 只是为了代码好看吗？还巧妙的解决了异步竞态问题

_https://juejin.cn/post/7225885023822463031_

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;多次修改筛选条件造成网络请求竞态</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[filterCondition,&nbsp;setFilterCondition]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[error,&nbsp;setError]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[loading,&nbsp;setLoading]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[data,&nbsp;setData]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;useEffect(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setLoading(<span data-darkreader-inline-color="">true</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fetcher(filterCondition).then(<span>(<span>data</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setLoading(<span data-darkreader-inline-color="">false</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setData(data)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).catch(<span>(<span>error</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setError(error);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;[filterCondition]);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FilterForm&nbsp;onSubmit={<span>(<span>filterCondition</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setFilterCondition(filterCondition)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}}&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{error&nbsp;?&nbsp;&lt;div&gt;error&lt;<span data-darkreader-inline-color="">/div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;loading&nbsp;?&nbsp;&lt;div&gt;loading&lt;/</span>div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;data}<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/&gt;<br>}<br></span></code>
```

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

## 局部加载还可以提升用户体验

_https://www.infoxicator.com/react-router-6-deferred-fetch_

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

## 将首屏请求提前到路由加载，而不会阻塞页面进入

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;react-router&nbsp;中的&nbsp;loader&nbsp;会阻塞页面进入</span><br>createBrowserRouter([<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;element:&nbsp;&lt;Teams&nbsp;/&gt;,<br>&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;<span data-darkreader-inline-color="">"teams"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;loader:&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>]);<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br>createBrowserRouter([<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;element:&nbsp;&lt;Teams&nbsp;/&gt;,<br>&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;<span data-darkreader-inline-color="">"teams"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;loader:&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;defer({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultP:&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>]);<br></code>
```

## 为什么 Promise 代表未来，React 社区推出新 api

_https://github.com/acdlite/rfcs/blob/first-class-promises/text/0000-first-class-support-for-promises.md?ref=blixt-dev#example-use-in-client-components-and-hooks_

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;⏸️&nbsp;react&nbsp;unstable-api</span><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;use&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'react'</span>;<br><br><span data-darkreader-inline-color="">const</span>&nbsp;ChildComponent&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[resultP,&nbsp;setResultP]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;data&nbsp;=&nbsp;use(resultP)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FilterForm&nbsp;onSubmit={<span>(<span>filterCondition</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResultP(fetcher(filterCondition))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}}&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Table&nbsp;data={data}&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;&gt;;<br>}<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Suspense&nbsp;fallback={&lt;div&gt;loading&lt;<span data-darkreader-inline-color="">/div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ErrorBoundery&nbsp;fallback={&lt;div&gt;error&lt;/</span>div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ChildComponent&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/ErrorBoundery&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>Suspense&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/&gt;<br>}<br></span></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;基于&nbsp;react-router&nbsp;&lt;Await&nbsp;/&gt;&nbsp;+&nbsp;useAsyncValue&nbsp;的实现</span><br><span data-darkreader-inline-color="">const</span>&nbsp;ChildComponent&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;data&nbsp;=&nbsp;useAsyncValue()<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Table&nbsp;data={data}&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;&gt;;<br>}<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[resultP,&nbsp;setResultP]&nbsp;=&nbsp;useState();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;FilterForm&nbsp;onSubmit={<span>(<span>filterCondition</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setResultP(fetcher(filterCondition))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}}&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Suspense&nbsp;fallback={&lt;div&gt;loading&lt;<span data-darkreader-inline-color="">/div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Await&nbsp;resolver={resultP}&nbsp;errorElement={&lt;div&gt;error&lt;/</span>div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ChildComponent&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Await&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>Suspense&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/&gt;<br>}<br></span></code>
```

## 使用

## 父子组件如何传递 Promise，和传普通状态一样

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;通过&nbsp;Props&nbsp;直接传入&nbsp;promise</span><br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;通过&nbsp;React&nbsp;Context&nbsp;传递&nbsp;promise</span><br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;通过状态库保存&nbsp;promise</span><br></code>
```

## 与 reduck 结合使用，比想象的更加简洁

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;fetcherModel&nbsp;=&nbsp;model(<span data-darkreader-inline-color="">'fetcher'</span>);<br><br><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">const</span>&nbsp;FilterForm&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[state,&nbsp;actions]&nbsp;=&nbsp;useModel(fetcherModel);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;Form&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Button&nbsp;onClick={<span><span>()</span>&nbsp;=&gt;</span>&nbsp;actions.setState(fetcher(<span data-darkreader-inline-color="">'xxx'</span>))}}&gt;&lt;<span data-darkreader-inline-color="">/Button&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>Form&gt;<br>}<br><br><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">const</span>&nbsp;ShowData&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[state]&nbsp;=&nbsp;useModel(fetcherModel);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;Suspense&nbsp;fallback={&lt;div&gt;loading&lt;<span data-darkreader-inline-color="">/div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ErrorBoundery&nbsp;fallback={&lt;div&gt;error&lt;/</span>div&gt;}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Await&nbsp;resolver={state}&gt;&lt;<span data-darkreader-inline-color="">/Await&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>ErrorBoundery&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Suspense&gt;<br>}<br></span></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;状态库将不再有副作用</span><br><span data-darkreader-inline-color="">const</span>&nbsp;fetcherModel&nbsp;=&nbsp;model(<span data-darkreader-inline-color="">'fetcher'</span>).define({<br>&nbsp;&nbsp;&nbsp;&nbsp;state:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultP:&nbsp;<span data-darkreader-inline-color="">null</span><br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;computed:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some(state)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;state.resultP?.then(<span>(<span>data</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;...&nbsp;<span data-darkreader-inline-color="">//数据处理</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;actions:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doSomeThing(state)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;state.resultP&nbsp;=&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;省去多余状态</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;load:&nbsp;handleEffect({&nbsp;result:&nbsp;<span data-darkreader-inline-color="">'items'</span>,&nbsp;pending:&nbsp;<span data-darkreader-inline-color="">false</span>,&nbsp;error:&nbsp;<span data-darkreader-inline-color="">false</span>&nbsp;}),<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;不再有副作用</span><br>&nbsp;&nbsp;&nbsp;&nbsp;effects:&nbsp;{}<br>})<br></code>
```

## 进阶

## 我的 React / ReactRouter 版本不够怎么办，自己实现

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;基于&nbsp;loadable&nbsp;实现&nbsp;&lt;Await&nbsp;/&gt;&nbsp;&amp;&nbsp;useAsyncValue();</span><br><span data-darkreader-inline-color="">//&nbsp;⏸️&nbsp;仅供参考，推荐下文中基于&nbsp;use()&nbsp;api&nbsp;的实现</span><br><span data-darkreader-inline-color="">import</span>&nbsp;loadable&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">"@loadable/component"</span>;<br><span data-darkreader-inline-color="">import</span>&nbsp;React,&nbsp;{&nbsp;ReactNode,&nbsp;createContext,&nbsp;useContext&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">"react"</span>;<br><br><span data-darkreader-inline-color="">const</span>&nbsp;AsyncDataContext&nbsp;=&nbsp;createContext&lt;unknown&gt;(<span data-darkreader-inline-color="">undefined</span>);<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;Await&nbsp;=&nbsp;loadable(<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;(props:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;resolver:&nbsp;<span data-darkreader-inline-color="">Promise</span>&lt;unknown&gt;;<br>&nbsp;&nbsp;&nbsp;&nbsp;children?:&nbsp;ReactNode&nbsp;|&nbsp;<span>(<span>(<span>data:&nbsp;<span data-darkreader-inline-color="">any</span></span>)&nbsp;=&gt;&nbsp;ReactNode</span>);<br>&nbsp;&nbsp;})&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;resolver&nbsp;}&nbsp;=&nbsp;props;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;data&nbsp;=&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;resolver;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span>(<span>props</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;children&nbsp;}&nbsp;=&nbsp;props;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">typeof</span>&nbsp;children&nbsp;===&nbsp;<span data-darkreader-inline-color="">"function"</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;children(data);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AsyncDataContext.Provider&nbsp;value={data}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{children}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/AsyncDataContext.Provider&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;cacheKey:&nbsp;({&nbsp;resolver&nbsp;})&nbsp;=&gt;&nbsp;resolver,<br>&nbsp;&nbsp;}<br>)&nbsp;as&nbsp;unknown&nbsp;as&nbsp;&lt;T&gt;(props:&nbsp;{<br>&nbsp;&nbsp;resolver:&nbsp;Promise&lt;T&gt;;<br>&nbsp;&nbsp;children?:&nbsp;ReactNode&nbsp;|&nbsp;((data:&nbsp;T)&nbsp;=&gt;&nbsp;ReactNode);<br>})&nbsp;=&gt;&nbsp;ReactNode;<br><br>export&nbsp;const&nbsp;useAsyncValue&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;return&nbsp;useContext(AsyncDataContext);<br>};<br></span></code>
```

## 实现 use() api

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span><span data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-color="">use</span>(<span>promise</span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;promise.value;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'rejected'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;promise.reason;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'pending'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;promise;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'pending'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;promise.then(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>result</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.value&nbsp;=&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>reason</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'rejected'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.reason&nbsp;=&nbsp;reason;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;promise;<br>&nbsp;&nbsp;}<br>}<br></code>
```

### 基于 use() api 实现

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;这个可以取代&nbsp;loadable&nbsp;的实现版本</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;Await&nbsp;=&nbsp;&lt;T&gt;(props:&nbsp;{<br>&nbsp;&nbsp;resolver:&nbsp;<span data-darkreader-inline-color="">Promise</span>&lt;T&gt;;<br>&nbsp;&nbsp;children?:&nbsp;ReactNode&nbsp;|&nbsp;<span data-darkreader-inline-color="">undefined</span>&nbsp;|&nbsp;<span>(<span>(<span>data?:&nbsp;T</span>)&nbsp;=&gt;&nbsp;ReactNode</span>);<br>})&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;resolver,&nbsp;children&nbsp;}&nbsp;=&nbsp;props;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;data&nbsp;=&nbsp;use(resolver);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">typeof</span>&nbsp;children&nbsp;===&nbsp;<span data-darkreader-inline-color="">'function'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;children(data);<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;children;<br>};<br></code>
```

## 例外，我就是要获取 loading 状态怎么办

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️&nbsp;react-use&nbsp;何必要区分&nbsp;useAsync&nbsp;/&nbsp;useAsyncFn&nbsp;/&nbsp;useAsyncRetry</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;error,&nbsp;loading,&nbsp;data&nbsp;}&nbsp;=&nbsp;useAsync(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetcher(xxx),&nbsp;[]);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;Loading&nbsp;loading={loading}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Table&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Loading&gt;<br>}<br></span></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">const</span>&nbsp;promise&nbsp;=&nbsp;fetcher(<span data-darkreader-inline-color="">'xxx'</span>);<br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;error,&nbsp;loading,&nbsp;data&nbsp;}&nbsp;=&nbsp;usePromise(promise);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;Loading&nbsp;loading={loading}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;Table&nbsp;/&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/Loading&gt;<br>}<br></span></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;实现&nbsp;usePromise()</span><br><span data-darkreader-inline-color="">type</span>&nbsp;PromiseCanUse&lt;T&gt;&nbsp;=&nbsp;<span data-darkreader-inline-color="">Promise</span>&lt;T&gt;&nbsp;&amp;&nbsp;{<br>&nbsp;&nbsp;status:&nbsp;<span data-darkreader-inline-color="">'pending'</span>&nbsp;|&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>&nbsp;|&nbsp;<span data-darkreader-inline-color="">'rejected'</span>;<br>&nbsp;&nbsp;reason:&nbsp;unknown;<br>&nbsp;&nbsp;value:&nbsp;T;<br>};<br><span><span data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-color="">usePromise</span>&lt;<span data-darkreader-inline-color="">T</span>&gt;(<span>promise?:&nbsp;PromiseCanUse&lt;T&gt;</span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[_,&nbsp;forceUpdate]&nbsp;=&nbsp;useState({});<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;ref&nbsp;=&nbsp;useRef&lt;PromiseCanUse&lt;T&gt;&gt;();<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!promise)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{&nbsp;loading:&nbsp;<span data-darkreader-inline-color="">false</span>,&nbsp;data:&nbsp;promise&nbsp;};<br>&nbsp;&nbsp;ref.current&nbsp;=&nbsp;promise;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!promise.status)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'pending'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;promise<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.then(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>result</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.value&nbsp;=&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>reason</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'rejected'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.reason&nbsp;=&nbsp;reason;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.finally(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setTimeout(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(ref.current&nbsp;===&nbsp;promise)&nbsp;{&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;最新的&nbsp;promise&nbsp;才会触发&nbsp;forceUpdate</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forceUpdate({});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;<span data-darkreader-inline-color="">0</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;loading:&nbsp;promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'pending'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;promise.value,<br>&nbsp;&nbsp;&nbsp;&nbsp;error:&nbsp;promise.reason,<br>&nbsp;&nbsp;};<br>}<br></code>
```

## 总结

传统网络请求创建 Promise 后，会立即使用 useEffect 消费掉 Promise 转换成 loading & data || error。

而现在，你应该在组件内或跨组件传递 Promise。

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

## ⭐️⭐️⭐️ 在你的项目中使用

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️&nbsp;一个文件导出&nbsp;usePromise()&nbsp;/&nbsp;use()&nbsp;/&nbsp;&lt;Await&nbsp;/&gt;</span><br><br><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;ReactNode,&nbsp;createContext,&nbsp;useContext,&nbsp;useRef,&nbsp;useState&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'react'</span>;<br><br><span data-darkreader-inline-color="">type</span>&nbsp;PromiseCanUse&lt;T&gt;&nbsp;=&nbsp;<span data-darkreader-inline-color="">Promise</span>&lt;T&gt;&nbsp;&amp;&nbsp;{<br>&nbsp;&nbsp;status?:&nbsp;<span data-darkreader-inline-color="">'pending'</span>&nbsp;|&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>&nbsp;|&nbsp;<span data-darkreader-inline-color="">'rejected'</span>;<br>&nbsp;&nbsp;reason?:&nbsp;unknown;<br>&nbsp;&nbsp;value?:&nbsp;T;<br>};<br><br><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;在当前组件使用&nbsp;loading/error<br>&nbsp;*/</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-color="">usePromise</span>&lt;<span data-darkreader-inline-color="">T</span>&gt;(<span>promise?:&nbsp;PromiseCanUse&lt;T&gt;</span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;[_,&nbsp;forceUpdate]&nbsp;=&nbsp;useState({});<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;ref&nbsp;=&nbsp;useRef&lt;PromiseCanUse&lt;T&gt;&gt;();<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!promise)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{&nbsp;loading:&nbsp;<span data-darkreader-inline-color="">false</span>,&nbsp;data:&nbsp;promise&nbsp;};<br>&nbsp;&nbsp;ref.current&nbsp;=&nbsp;promise;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!promise.status)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'pending'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;promise<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.then(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>result</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.value&nbsp;=&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>reason</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'rejected'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.reason&nbsp;=&nbsp;reason;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.finally(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setTimeout(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(ref.current&nbsp;===&nbsp;promise)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forceUpdate({});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;<span data-darkreader-inline-color="">0</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;loading:&nbsp;promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'pending'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;data:&nbsp;promise.value,<br>&nbsp;&nbsp;&nbsp;&nbsp;error:&nbsp;promise.reason,<br>&nbsp;&nbsp;};<br>}<br><br><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;在父级/祖父级组件中使用&nbsp;Suspense/ErrorBoundery&nbsp;接收&nbsp;loading/error<br>&nbsp;*/</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-color="">use</span>&lt;<span data-darkreader-inline-color="">T</span>&gt;(<span>promise?:&nbsp;PromiseCanUse&lt;T&gt;</span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!promise)&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;promise;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;promise.value;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'rejected'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;promise.reason;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(promise.status&nbsp;===&nbsp;<span data-darkreader-inline-color="">'pending'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;promise;<br>&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'pending'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;promise.then(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>result</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'fulfilled'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.value&nbsp;=&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span><span>reason</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.status&nbsp;=&nbsp;<span data-darkreader-inline-color="">'rejected'</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;promise.reason&nbsp;=&nbsp;reason;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;promise;<br>&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">const</span>&nbsp;AsyncDataContext&nbsp;=&nbsp;createContext&lt;unknown&gt;(<span data-darkreader-inline-color="">undefined</span>);<br><br><span data-darkreader-inline-color="">/**<br>&nbsp;*&nbsp;在当前组件或父级/祖父级组件中使用&nbsp;Suspense/ErrorBoundery&nbsp;接收&nbsp;loading/error<br>&nbsp;*/</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;Await&nbsp;=&nbsp;&lt;T,&gt;(props:&nbsp;{<br>&nbsp;&nbsp;resolver?:&nbsp;<span data-darkreader-inline-color="">Promise</span>&lt;T&gt;;<br>&nbsp;&nbsp;children?:&nbsp;ReactNode&nbsp;|&nbsp;<span data-darkreader-inline-color="">undefined</span>&nbsp;|&nbsp;<span>(<span>(<span>data?:&nbsp;T</span>)&nbsp;=&gt;&nbsp;ReactNode</span>);<br>})&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;resolver,&nbsp;children&nbsp;}&nbsp;=&nbsp;props;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;data&nbsp;=&nbsp;use(resolver);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">typeof</span>&nbsp;children&nbsp;===&nbsp;<span data-darkreader-inline-color="">'function'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;children(data);<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;AsyncDataContext.Provider&nbsp;value={data}&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{children}<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span data-darkreader-inline-color="">/AsyncDataContext.Provider&gt;<br>&nbsp;&nbsp;);<br>};<br><br>/</span>**<br>&nbsp;*&nbsp;在当前组件接收来自父级&nbsp;&lt;Await&nbsp;/&gt;&nbsp;组件的&nbsp;data<br>&nbsp;*&nbsp;<span data-darkreader-inline-color="">@deprecated</span>&nbsp;不推荐使用,&nbsp;会丢失&nbsp;ts&nbsp;类型<br>&nbsp;*<span data-darkreader-inline-color="">/<br>export&nbsp;const&nbsp;useAsyncValue&nbsp;=&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;return&nbsp;useContext(AsyncDataContext);<br>};<br></span></code>
```

## 实例演练

**实现按钮的权限控制**

使用场景

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;MyComponent&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;xPermission&nbsp;=&nbsp;usePermission(<span data-darkreader-inline-color="">'xButton'</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;div&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...someThing&nbsp;展示<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{xPermission&nbsp;?&nbsp;&lt;Button&nbsp;onClick={...}&gt;x&lt;<span data-darkreader-inline-color="">/Button&gt;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/</span>div&gt;<br>}<br></code>
```

实现

> 设 fetchPermission 为获取权限的网络请求

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;createContext,&nbsp;useContext,&nbsp;useMemo,&nbsp;use&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'react'</span>;<br><br><span data-darkreader-inline-color="">const</span>&nbsp;PermissionContext&nbsp;=&nbsp;createContext(<span data-darkreader-inline-color="">undefined</span>);<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;Provider&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;promise&nbsp;=&nbsp;useMemo(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetchPermission(),&nbsp;[]);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;PermissionContext.Provider&nbsp;value={promise}&gt;&lt;<span data-darkreader-inline-color="">/PermissionContext.Provider&gt;;<br>};<br><br>export&nbsp;const&nbsp;usePermission&nbsp;=&nbsp;(functionCode?:&nbsp;string)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;const&nbsp;promise&nbsp;=&nbsp;useContext(PermissionContext);<br>&nbsp;&nbsp;const&nbsp;permissions&nbsp;=&nbsp;use(promise);&nbsp;/</span><span data-darkreader-inline-color="">/&nbsp;loading&nbsp;会由上层最近的&nbsp;Suspense&nbsp;承接.<br>&nbsp;&nbsp;if&nbsp;(!functionCode)&nbsp;return&nbsp;true;<br>&nbsp;&nbsp;return&nbsp;permissions?.find(functionCode)<br>}<br></span></code>
```

如果你想用 set 来优化数组性能

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;createContext,&nbsp;useContext,&nbsp;useMemo&nbsp;}&nbsp;<span data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-color="">'react'</span>;<br><br><span data-darkreader-inline-color="">const</span>&nbsp;PermissionContext&nbsp;=&nbsp;createContext(<span data-darkreader-inline-color="">undefined</span>);<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;Provider&nbsp;=&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;promise&nbsp;=&nbsp;useMemo(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;fetchPermission().then(<span><span>permissions</span>&nbsp;=&gt;</span>&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;Set(permissions)),<br>&nbsp;&nbsp;&nbsp;&nbsp;[],<br>&nbsp;&nbsp;);<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;&lt;PermissionContext.Provider&nbsp;value={promise}&gt;&lt;<span data-darkreader-inline-color="">/PermissionContext.Provider&gt;;<br>};<br><br>export&nbsp;const&nbsp;usePermission&nbsp;=&nbsp;(functionCode?:&nbsp;string)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;const&nbsp;promise&nbsp;=&nbsp;useContext(PermissionContext);<br>&nbsp;&nbsp;const&nbsp;permissionSet&nbsp;=&nbsp;use(promise);<br>&nbsp;&nbsp;if&nbsp;(!functionCode)&nbsp;return&nbsp;true;<br>&nbsp;&nbsp;return&nbsp;permissionSet?.has(functionCode)<br>}<br></span></code>
```

一个 hook 实现，避免将逻辑散落在状态管理。

## 杂谈

## 你真的会使用 await 吗，你的行为可能正在劣化性能

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;❌️</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;fetcher(<span data-darkreader-inline-color="">'some1'</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">await</span>&nbsp;fetcher(<span data-darkreader-inline-color="">'some2'</span>)<br>}<br></code>
```

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">//&nbsp;✅️</span><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;<span data-darkreader-inline-color="">async</span>&nbsp;()&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">Promise</span>.all([fetcher(<span data-darkreader-inline-color="">'some1'</span>),&nbsp;fetcher(<span data-darkreader-inline-color="">'some2'</span>)])<br>}<br></code>
```

## 注意事项

use(promise) 能够在 loading 结束后正常渲染的前提是 loading 前后的 promise 需要是同一个值，而 use(Promise.all(xxx)) 会在每次 render 的时候创建一个新的 promise 就会一直触发 loading 态。

解决方案是把会生成新 Promise 的运算都放在一个 useMemo 中。

## 扩展阅读

_https://react.dev/learn/you-might-not-need-an-effect_