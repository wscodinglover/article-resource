## 写在前面

本文旨在保证"**抽丝剥茧代码属性图CPG**"系列文章的**完整性**，笔者认为**图数据库****Neo4j**也是该系列中不可或缺的一部分，本文起到一个**抛砖引玉**的作用，后续大概率会对CPG中的Neo4j做详细的讲解，大家敬请期待~

## 引言

为什么要写CPG中的**Neo4j**呢，在花大把时间肝完**CPG中的DFG（Data Flow Graph）**后，笔者闲下来再去回顾这些东西时，虽然写得很全面也很细节了， 但看起来还**不是那么的直观**，尤其是验证各条边的构建过程时，必须在特定代码场景下**debug**调试，然后从程序断点处寻找我们想要的DFG信息，想必大家在阅读过程中也是比较痛苦的。

基于上述原因，再加上CPG自身集成了图数据库**Neo4j**，其支持把翻译后的产物`TranslationResult`序列化到数据库，然后我们就可以通过**Neo4j Browser**直观地看到生成的图了，各节点间的关系，各节点间连接着什么边，节点都有哪些属性等等以**图**的形式呈现，一目了然，对读者极其友好。

所以嘞，笔者打算以后的文章中若涉及到**验证**或者是需要**看CPG的构建效果**时，直接给大家上图！

大家可以先看一张图，直观地感受一下**图形化展示**的效果（此图不是完整的图，是笔者本地测试的一张图，主要是让大家感受下neo4j带来的便利）。

![Image](https://mmbiz.qpic.cn/sz_mmbiz_png/cdc0h3QF6GbY78iaAGoSXocyiahOqCDB6xp7trJK4u2bXDrzgibflf1o7DGkqFdDpDbRJsJCfuTSVVY22N7nlzqRg/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

红色的边都是**DFG边**（neo4j browser提供的渲染，可自定义样式），另外，节点是什么类型，其有哪些属性都可以点击节点，直观地看到。

![Image](https://mmbiz.qpic.cn/sz_mmbiz_png/cdc0h3QF6GbY78iaAGoSXocyiahOqCDB6x1mgNiaQykeoFsMDVNLyu4v8b3U6llsMxou4DsMSBeZSUWrgOuicD7HeA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

## 一、Neo4j介绍

## 概述

Neo4j 是一款高性能的、开源的 NoSQL 图形数据库。其采用图形数据模型，将数据表示为**节点**、**关系**以及节点之间的**连接**，并且节点及关系都可以携带**属性**来扩充信息，非常适合那些需要揭示复杂数据间隐含关系的应用场景。其存储的内容如下：

-   Node  节点
    
-   Relationship  节点间的关系
    
-   Property  节点属性
    

## 特点

-   使用Cypher查询语言
    
-   支持完整的ACID事务特性（原子性，一致性，隔离性和持久性）
    
-   支持将查询的数据导出为JSON和XSL格式
    
-   提供REST API，可以被任何编程语言访问
    

## 二、Neo4j本地安装

-   下载地址：https://neo4j.com/deployment-center/#community
    
-   解压后进入bin文件夹下，执行如下命令：
    

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">neo4j.bat&nbsp;console<br></code>
```

如下效果即执行成功

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

-   浏览器访问**http://localhost:7474/browser/**
    

输入默认账号**neo4j**，默认密码**neo4j**，然后再**修改密码**后即可正常访问。

## 三、CPG-neo4j的调用方式

> tips:需先本地安装neo4j，并启动neo4j服务

## 1.gradle打包+命令行

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">//&nbsp;克隆cpg到本地<br>git&nbsp;<span data-darkreader-inline-color="">clone</span>&nbsp;https://github.com/Fraunhofer-AISEC/cpg.git<br>//&nbsp;进入cpg-neo4j目录<br><span data-darkreader-inline-color="">cd</span>&nbsp;cpg/cpg-neo4j<br>//gradle&nbsp;构建<br>gralde&nbsp;installDist<br></code>
```

构建完成后，会在`build/install/cpg-neo4j/bin`目录下生成打包好的可执行文件

-   cpg-neo4j
    
-   cpg-neo4j.bat
    

**命令行调用可执行程序：**

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">./build/install/cpg-neo4j/bin/cpg-neo4j  [--infer-nodes] [--load-includes] [--no-default-passes]<br>                    [--no-neo4j] [--no-purge-db] [--print-benchmark]<br>                    [--use-unity-build] [--benchmark-json=&lt;benchmarkJson&gt;]<br>                    [--custom-pass-list=&lt;customPasses&gt;]<br>                    [--export-json=&lt;exportJsonFile&gt;] [--host=&lt;host&gt;]<br>                    [--includes-file=&lt;includesFile&gt;]<br>                    [--password=&lt;neo4jPassword&gt;] [--port=&lt;port&gt;]<br>                    [--save-depth=&lt;depth&gt;] [--top-level=&lt;topLevel&gt;]<br>                    [--user=&lt;neo4jUsername&gt;] ([&lt;files&gt;...] | -S=&lt;String=String&gt;<br>                    [-S=&lt;String=String&gt;]... |<br>                    --json-compilation-database=&lt;jsonCompilationDatabase&gt; |<br>                    --list-passes)<br>      [&lt;files&gt;...]           The paths to analyze. If module support is<br>                               enabled, the paths will be looked at if they<br>                               contain modules<br>      --benchmark-json=&lt;benchmarkJson&gt;<br>                             Save benchmark results to json file<br>      --custom-pass-list=&lt;customPasses&gt;<br>                             Add custom list of passes (includes<br>                               --no-default-passes) which is passed as a<br>                               comma-separated list; give either pass name if<br>                               pass is in list, or its FQDN (e.g.<br>                               --custom-pass-list=DFGPass,CallResolver)<br>      --export-json=&lt;exportJsonFile&gt;<br>                             Export cpg as json<br>      --host=&lt;host&gt;          Set the host of the neo4j Database (default:<br>                               localhost).<br>      --includes-file=&lt;includesFile&gt;<br>                             Load includes from file<br>      --infer-nodes          Create inferred nodes for missing declarations<br>      --json-compilation-database=&lt;jsonCompilationDatabase&gt;<br>                             The path to an optional a JSON compilation database<br>      --list-passes          Prints the list available passes<br>      --load-includes        Enable TranslationConfiguration option loadIncludes<br>      --no-default-passes    Do not register default passes [used for debugging]<br>      --no-neo4j             Do not push cpg into neo4j [used for debugging]<br>      --no-purge-db          Do no purge neo4j database before pushing the cpg<br>      --password=&lt;neo4jPassword&gt;<br>                             Neo4j password (default: password<br>      --port=&lt;port&gt;          Set the port of the neo4j Database (default: 7687).<br>      --print-benchmark      Print benchmark result as markdown table<br>  -S, --softwareComponents=&lt;String=String&gt;<br>                             Maps the names of software components to their<br>                               respective files. The files are separated by<br>                               commas (No whitespace!).<br>                             Example: -S App1=./file1.c,./file2.c -S App2=.<br>                               /Main.java,./Class.java<br>      --save-depth=&lt;depth&gt;   Performance optimisation: Limit recursion depth<br>                               form neo4j OGM when leaving the AST. -1<br>                               (default) means no limit is used.<br>      --top-level=&lt;topLevel&gt; Set top level directory of project structure.<br>                               Default: Largest common path of all source files<br>      --use-unity-build      Enable unity build mode for C++ (requires<br>                               --load-includes)<br>      --user=&lt;neo4jUsername&gt; Neo4j user name (default: neo4j)<br></code>
```

我们需要注意以下参数：

-   \--host   neo4j服务器（默认**localhost**）
    
-   \--port  服务器端口（默认**7687**）
    
-   \--user  neo4j用户名（默认 **neo4j**）
    
-   \--password  neo4j密码（默认 **password**）
    
-   \--export-json  是否输出**json**格式的结果
    
-   \--no-neo4j  不将结果push至neo4j数据库
    

**使用示例**：（其余参数默认即可）

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&nbsp;.\cpg-neo4j&nbsp;D:\Example.java&nbsp;--password&nbsp;yourPassword<br></code>
```

有如下响应证明`TranslationResult`已成功push至neo4j

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

然后，就可以访问**http://localhost:7474/browser**查看CPG翻译后的代码属性图了

## 2.code调用

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">@Test</span><br><span data-darkreader-inline-color="">@Throws(InterruptedException::class)</span><br><span><span data-darkreader-inline-color="">fun</span>&nbsp;<span data-darkreader-inline-color="">myNeo4jTest</span><span>()</span></span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">val</span>&nbsp;cmd&nbsp;=&nbsp;CommandLine(Application::<span><span data-darkreader-inline-color="">class</span>.<span data-darkreader-inline-color="">java</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;cmd.parseArgs(<span data-darkreader-inline-color="">"Example.java"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">val</span>&nbsp;application&nbsp;=&nbsp;cmd.getCommand&lt;Application&gt;()<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">val</span>&nbsp;translationConfiguration&nbsp;=&nbsp;application.setupTranslationConfiguration()<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">val</span>&nbsp;translationResult&nbsp;=&nbsp;TranslationManager.builder().config(translationConfiguration).build().analyze().<span data-darkreader-inline-color="">get</span>()<br>&nbsp;&nbsp;&nbsp;&nbsp;application.pushToNeo4j(translationResult)<br>}<br></code>
```

当然，你也可以参考CPG的测试代码进行修改：`cpg-neo4j/src/test/kotlin/de/fraunhofer/aisec/cpg_vis_neo4j/Neo4JTest.kt`

## 推荐阅读

代码属性图CPG系列文章（白盒/静态代码分析方向）：超**万字**的详细讲解，文章**理论与实践相结合**，示例代码可**拿来即用**，**通俗易懂**，这样的文章你爱了吗！![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E) 

-   [抽丝剥茧代码属性图CPG-第一弹：CPG介绍](http://mp.weixin.qq.com/s?__biz=MzkxNzY3MjE1NA==&mid=2247483879&idx=1&sn=7ae5a6526787f114c28ea77645273081&chksm=c1bc5852f6cbd144ea341e039d47e93543fd6d7bd3e99fc80834458b385ca45fb151829a46da&scene=21#wechat_redirect)
    
-   [抽丝剥茧代码属性图CPG-第四弹：CPG中的DFG-3](http://mp.weixin.qq.com/s?__biz=MzkxNzY3MjE1NA==&mid=2247484169&idx=1&sn=ac94ca020fdd67da7b3bbb9879db1bc3&chksm=c1bc5abcf6cbd3aa16500c17fd111091718094f635e0a8ee9a52b48f73a07f6148d0ef963278&scene=21#wechat_redirect)
    
-   [SAST-短小精悍的Benchmark](http://mp.weixin.qq.com/s?__biz=MzkxNzY3MjE1NA==&mid=2247484111&idx=1&sn=9b7ec8374dc22623e0e5e6fa8f268248&chksm=c1bc5b7af6cbd26cb014505a75f6ba37425a7950e83b9ffe0aee414f6cd9c3baefd839d4cc7e&scene=21#wechat_redirect)
    
-   [](http://mp.weixin.qq.com/s?__biz=MzkxNzY3MjE1NA==&mid=2247484111&idx=1&sn=9b7ec8374dc22623e0e5e6fa8f268248&chksm=c1bc5b7af6cbd26cb014505a75f6ba37425a7950e83b9ffe0aee414f6cd9c3baefd839d4cc7e&scene=21#wechat_redirect)[GPT-4可自主利用1day漏洞了，0day还会远吗？渗透测试：我慌了！](http://mp.weixin.qq.com/s?__biz=MzkxNzY3MjE1NA==&mid=2247484262&idx=1&sn=1f42921be6b114339023643f86f15aa5&chksm=c1bc5ad3f6cbd3c508265e59e457ebabe01171d87bebbe16cc483ed992dd06eef376504ea4c2&scene=21#wechat_redirect)
    

## 技术交流群

-   社群**大佬云集**，可与各领域大咖面对面交流技术
    
-   定期做**优质技术分享**，提升自己的技术能力
    
-   自我提升，不仅限于**技术**，还有圈子
    
-   与笔者交个朋友
    

点击公众号底部菜单栏“****点击进群****”，扫码**加笔者好友**（备注"****进群****"）

## 聊点两毛钱的

能够看到这篇文章，就是我们的缘分，****坚持输出优质内容****是笔者一直在做的事情。若文章对你有帮助，感谢点个免费的 ******点赞********![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)**、******在看****![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)**，大家的鼓励是我最大的动力![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

******关注******我，交个朋友~