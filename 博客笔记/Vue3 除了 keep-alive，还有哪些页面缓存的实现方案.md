引言  

有这么一个需求：列表页进入详情页后，切换回列表页，需要对列表页进行缓存，如果从首页进入列表页，就要重新加载列表页。

对于这个需求，我的第一个想法就是使用keep-alive来缓存列表页，列表和详情页切换时，列表页会被缓存；从首页进入列表页时，就重置列表页数据并重新获取新数据来达到列表页重新加载的效果。

但是，这个方案有个很不好的地方就是：如果列表页足够复杂，有下拉刷新、下拉加载、有弹窗、有轮播等，在清除缓存时，就需要重置很多数据和状态，而且还可能要手动去销毁和重新加载某些组件，这样做既增加了复杂度，也容易出bug。

接下来说说我的想到的新实现方案（代码基于Vue3）。

## keep-alive 缓存和清除

> keep-alive 缓存原理：进入页面时，页面组件渲染完成，keep-alive 会缓存页面组件的实例；离开页面后，组件实例由于已经缓存就不会进行销毁；当再次进入页面时，就会将缓存的组件实例拿出来渲染，因为组件实例保存着原来页面的数据和Dom的状态，那么直接渲染组件实例就能得到原来的页面。

keep-alive 最大的难题就是缓存的清理，如果能有简单的缓存清理方法，那么keep-alive 组件用起来就很爽。

但是，keep-alive 组件没有提供清除缓存的API，那有没有其他清除缓存的办法呢？答案是有的。我们先看看 keep-alive 组件的props：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">include&nbsp;-&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">RegExp</span>&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">Array</span>。只有名称匹配的组件会被缓存。<br>exclude&nbsp;-&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">RegExp</span>&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">Array</span>。任何名称匹配的组件都不会被缓存。<br>max&nbsp;-&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">number</span>&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>。最多可以缓存多少组件实例。<br><br></code>
```

从include描述来看，我发现include是可以用来清除缓存，做法是：将组件名称添加到include里，组件会被缓存；移除组件名称，组件缓存会被清除。根据这个原理，用hook简单封装一下代码：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;ref,&nbsp;nextTick&nbsp;}&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'vue'</span><br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;caches&nbsp;=&nbsp;ref&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>[]&gt;([])<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">default</span>&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">useRouteCache</span>&nbsp;(<span data-darkreader-inline-outline=""></span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;添加缓存的路由组件</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">addCache</span>&nbsp;(<span data-darkreader-inline-outline="">componentName:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>&nbsp;[]</span>)&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">Array</span>.isArray(componentName))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;componentName.forEach(addCache)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(!componentName&nbsp;||&nbsp;caches.value.includes(componentName))&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;caches.value.push(componentName)<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;移除缓存的路由组件</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">removeCache</span>&nbsp;(<span data-darkreader-inline-outline="">componentName:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span></span>)&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;index&nbsp;=&nbsp;caches.value.indexOf(componentName)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(index&nbsp;&gt;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">-1</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span>&nbsp;caches.value.splice(index,&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">1</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;移除缓存的路由组件的实例</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">async</span>&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">removeCacheEntry</span>&nbsp;(<span data-darkreader-inline-outline="">componentName:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span></span>)&nbsp;</span>{&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(removeCache(componentName))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">await</span>&nbsp;nextTick()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addCache(componentName)<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;caches,<br>&nbsp;&nbsp;&nbsp;&nbsp;addCache,<br>&nbsp;&nbsp;&nbsp;&nbsp;removeCache,<br>&nbsp;&nbsp;&nbsp;&nbsp;removeCacheEntry<br>&nbsp;&nbsp;}<br>}<br><br></code>
```

hook的用法如下：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&lt;router-view v-slot="{ Component }"&gt;<br>  &lt;keep-alive :include="caches"&gt;<br>    &lt;component :is="Component" /&gt;<br>  &lt;/keep-alive&gt;<br>&lt;/router-view&gt;<br><br>&lt;script setup lang="ts"&gt;<br>import useRouteCache from './hooks/useRouteCache'<br>const { caches, addCache } = useRouteCache()<br><br>&lt;!-- 将列表页组件名称添加到需要缓存名单中 --&gt;<br>addCache(['List'])<br>&lt;/script&gt;<br><br></code>
```

清除列表页缓存如下：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;useRouteCache&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@/hooks/useRouteCache'</span><br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;removeCacheEntry&nbsp;}&nbsp;=&nbsp;useRouteCache()<br>removeCacheEntry(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'List'</span>)<br><br></code>
```

> 此处removeCacheEntry方法清除的是列表组件的实例，'List' 值仍然在 组件的include里，下次重新进入列表页会重新加载列表组件，并且之后会继续列表组件进行缓存。

### 列表页清除缓存的时机

#### 进入列表页后清除缓存

在列表页路由组件的beforeRouteEnter勾子中判断是否是从其他页面（Home）进入的，是则清除缓存，不是则使用缓存。

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">defineOptions({<br>&nbsp;&nbsp;name:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'List1'</span>,<br>&nbsp;&nbsp;beforeRouteEnter&nbsp;(to:&nbsp;RouteRecordNormalized,&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>:&nbsp;RouteRecordNormalized)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>.name&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'Home'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;removeCacheEntry&nbsp;}&nbsp;=&nbsp;useRouteCache()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;removeCacheEntry(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'List1'</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>})<br><br></code>
```

这种缓存方式有个不太友好的地方：当从首页进入列表页，列表页和详情页来回切换，列表页是缓存的；但是在首页和列表页间用浏览器的前进后退来切换时，我们更多的是希望列表页能保留缓存，就像在多页面中浏览器前进后退会缓存原页面一样的效果。但实际上，列表页重新刷新了，这就需要使用另一种解决办法，**点击链接时清除缓存清除缓存**。

#### 点击链接跳转前清除缓存

在首页点击跳转列表页前，在点击事件的时候去清除列表页缓存，这样的话在首页和列表页用浏览器的前进后退来回切换，列表页都是缓存状态，只要当重新点击跳转链接的时候，才重新加载列表页，满足预期。

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">// 首页 Home.vue<br><br>&lt;li&gt;<br>  &lt;router-link to="/list" @click="removeCacheBeforeEnter"&gt;列表页&lt;/router-link&gt;<br>&lt;/li&gt;<br><br><br>&lt;script setup lang="ts"&gt;<br>import useRouteCache from '@/hooks/useRouteCache'<br><br>defineOptions({<br>  name: 'Home'<br>})<br><br>const { removeCacheEntry } = useRouteCache()<br><br>// 进入页面前，先清除缓存实例<br>function removeCacheBeforeEnter () {<br>  removeCacheEntry('List')<br>}<br>&lt;/script&gt;<br><br></code>
```

## 状态管理实现缓存

通过状态管理库存储页面的状态和数据也能实现页面缓存。此处状态管理使用的是pinia。

首先使用pinia创建列表页store：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;defineStore&nbsp;}&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'pinia'</span><br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">interface</span>&nbsp;Item&nbsp;{<br>&nbsp;&nbsp;id?:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">number</span>,<br>&nbsp;&nbsp;content?:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span><br>}<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;useListStore&nbsp;=&nbsp;defineStore(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'list'</span>,&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;推荐使用&nbsp;完整类型推断的箭头函数</span><br>&nbsp;&nbsp;state:&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="">()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isRefresh:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pageSize:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">30</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;currentPage:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">1</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list:&nbsp;[]&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">as</span>&nbsp;Item[],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curRow:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">null</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">as</span>&nbsp;Item&nbsp;|&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">null</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;},<br>&nbsp;&nbsp;actions:&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;setList&nbsp;(data:&nbsp;Item&nbsp;[])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">this</span>.list&nbsp;=&nbsp;data<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;setCurRow&nbsp;(data:&nbsp;Item)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">this</span>.curRow&nbsp;=&nbsp;data<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;setIsRefresh&nbsp;(data:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">boolean</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">this</span>.isRefresh&nbsp;=&nbsp;data<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>})<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">default</span>&nbsp;useListStore<br><br></code>
```

然后在列表页中使用store：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&lt;div&gt;<br>  &lt;el-page-header @back="goBack"&gt;<br>    &lt;template #content&gt;状态管理实现列表页缓存&lt;/template&gt;<br>  &lt;/el-page-header&gt;<br>  &lt;el-table v-loading="loading" :data="tableData" border style="width: 100%; margin-top: 30px;"&gt;<br>    &lt;el-table-column prop="id" label="id" /&gt;<br>    &lt;el-table-column prop="content" label="内容"/&gt;<br>    &lt;el-table-column label="操作"&gt;<br>      &lt;template v-slot="{ row }"&gt;<br>        &lt;el-link type="primary" @click="gotoDetail(row)"&gt;进入详情&lt;/el-link&gt;<br>        &lt;el-tag type="success" v-if="row.id === listStore.curRow?.id"&gt;刚点击&lt;/el-tag&gt;<br>      &lt;/template&gt;<br>    &lt;/el-table-column&gt;<br>  &lt;/el-table&gt;<br>  &lt;el-pagination<br>    v-model:currentPage="listStore.currentPage"<br>    :page-size="listStore.pageSize"<br>    layout="total, prev, pager, next"<br>    :total="listStore.list.length"<br>  /&gt;<br>&lt;/div&gt;<br>  <br>&lt;script setup lang="ts"&gt;<br>import useListStore from '@/store/listStore'<br>const listStore = useListStore()<br><br>...<br>&lt;/script&gt;<br><br></code>
```

通过beforeRouteEnter钩子判断是否从首页进来，是则通过 `listStore.$reset()` 来重置数据，否则使用缓存的数据状态；之后根据 `listStore.isRefresh` 标示判断是否重新获取列表数据。

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">defineOptions({<br>&nbsp;&nbsp;beforeRouteEnter&nbsp;(to:&nbsp;RouteLocationNormalized,&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>:&nbsp;RouteLocationNormalized)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>.name&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'Home'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;listStore&nbsp;=&nbsp;useListStore()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listStore.$reset()<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>})<br><br>onBeforeMount(<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="">()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(!listStore.useCache)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;loading.value&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span><br>&nbsp;&nbsp;&nbsp;&nbsp;setTimeout(<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="">()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listStore.setList(getData())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loading.value&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">false</span><br>&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">1000</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;listStore.useCache&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span><br>&nbsp;&nbsp;}<br>})<br><br></code>
```

### 缺点

通过状态管理去做缓存的话，需要将状态数据都存在stroe里，状态多起来的话，会有点繁琐，而且状态写在store里肯定没有写在列表组件里来的直观；状态管理由于只做列表页数据的缓存，对于一些非受控组件来说，组件内部状态改变是缓存不了的，这就导致页面渲染后跟原来有差别，需要额外代码操作。

## 页面弹窗实现缓存

将详情页做成全屏弹窗，那么从列表页进入详情页，就只是简单地打开详情页弹窗，将列表页覆盖，从而达到列表页 “缓存”的效果，而非真正的缓存。

这里还有一个问题，打开详情页之后，如果点后退，会返回到首页，实际上我们希望是返回列表页，这就需要给详情弹窗加个历史记录，如列表页地址为 '/list'，打开详情页变为 '/list?id=1'。

弹窗组件实现：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">// PopupPage.vue<br><br>&lt;template&gt;<br>  &lt;div class="popup-page" :class="[!dialogVisible &amp;&amp; 'hidden']"&gt;<br>    &lt;slot v-if="dialogVisible"&gt;&lt;/slot&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script setup lang="ts"&gt;<br>import { useLockscreen } from 'element-plus'<br>import { computed, defineProps, defineEmits } from 'vue'<br>import useHistoryPopup from './useHistoryPopup'<br><br>const props = defineProps({<br>  modelValue: {<br>    type: Boolean,<br>    default: false<br>  },<br>  // 路由记录<br>  history: {<br>    type: Object<br>  },<br>  // 配置了history后，初次渲染时，如果有url上有history参数，则自动打开弹窗<br>  auto: {<br>    type: Boolean,<br>    default: true<br>  },<br>  size: {<br>    type: String,<br>    default: '50%'<br>  },<br>  full: {<br>    type: Boolean,<br>    default: false<br>  }<br>})<br>const emit = defineEmits(<br>  ['update:modelValue', 'autoOpen', 'autoClose']<br>)<br><br>const dialogVisible = computed&lt;boolean&gt;({ // 控制弹窗显示<br>  get () {<br>    return props.modelValue<br>  },<br>  set (val) {<br>    emit('update:modelValue', val)<br>  }<br>})<br><br>useLockscreen(dialogVisible)<br><br>useHistoryPopup({<br>  history: computed(() =&gt; props.history),<br>  auto: props.auto,<br>  dialogVisible: dialogVisible,<br>  onAutoOpen: () =&gt; emit('autoOpen'),<br>  onAutoClose: () =&gt; emit('autoClose')<br>})<br>&lt;/script&gt;<br><br>&lt;style lang='less'&gt;<br>.popup-page {<br>  position: fixed;<br>  left: 0;<br>  right: 0;<br>  top: 0;<br>  bottom: 0;<br>  z-index: 100;<br>  overflow: auto;<br>  padding: 10px;<br>  background: #fff;<br>  <br>  &amp;.hidden {<br>    display: none;<br>  }<br>}<br>&lt;/style&gt;<br><br></code>
```

弹窗组件调用：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&lt;popup-page <br>  v-model="visible" <br>  full<br>  :history="{ id: id }"&gt;<br>  &lt;Detail&gt;&lt;/Detail&gt;<br>&lt;/popup-page&gt;<br><br></code>
```

> hook：useHistoryPopup 参考文章：https://juejin.cn/post/7139941749174042660

### 缺点

弹窗实现页面缓存，局限比较大，只能在列表页和详情页中才有效，离开列表页之后，缓存就会失效，比较合适一些简单缓存的场景。

## 父子路由实现缓存

该方案原理其实就是页面弹窗，列表页为父路由，详情页为子路由，从列表页跳转到详情页时，显示详情页字路由，且详情页全屏显示，覆盖住列表页。

声明父子路由：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">{<br>&nbsp;&nbsp;path:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'/list'</span>,<br>&nbsp;&nbsp;name:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'list'</span>,<br>&nbsp;&nbsp;component:&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="">()</span>&nbsp;=&gt;</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'./views/List.vue'</span>),<br>&nbsp;&nbsp;children:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'/detail'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'detail'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;component:&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="">()</span>&nbsp;=&gt;</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'./views/Detail.vue'</span>),<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;]<br>}<br><br></code>
```

列表页代码：

```
<span data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">//&nbsp;列表页<br><span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">template</span>&gt;</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-table</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">v-loading</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"loading"</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">:data</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"tableData"</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">border</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">style</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"width:&nbsp;100%;&nbsp;margin-top:&nbsp;30px;"</span>&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-table-column</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">prop</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"id"</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">label</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"id"</span>&nbsp;/&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-table-column</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">prop</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"content"</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">label</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"内容"</span>/&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-table-column</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">label</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"操作"</span>&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">template</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">v-slot</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"{&nbsp;row&nbsp;}"</span>&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-link</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">type</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"primary"</span>&nbsp;@<span data-darkreader-inline-outline="" data-darkreader-inline-color="">click</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"gotoDetail(row)"</span>&gt;</span>进入详情<span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-link</span>&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-tag</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">type</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"success"</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">v-if</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"row.id&nbsp;===&nbsp;curRow?.id"</span>&gt;</span>刚点击<span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-tag</span>&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">template</span>&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-table-column</span>&gt;</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-table</span>&gt;</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">el-pagination</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">v-model:currentPage</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"currentPage"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">:page-size</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"pageSize"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">layout</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"total,&nbsp;prev,&nbsp;pager,&nbsp;next"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">:total</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"list.length"</span><br>&nbsp;&nbsp;/&gt;</span><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">&lt;!--&nbsp;详情页&nbsp;--&gt;</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">router-view</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">class</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"popyp-page"</span>&gt;</span><span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">router-view</span>&gt;</span><br><span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">template</span>&gt;</span><br><br><span data-darkreader-inline-outline="">&lt;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">style</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">lang</span>=<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'less'</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">scoped</span>&gt;</span><span data-darkreader-inline-outline=""><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">.popyp-page</span>&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">position</span>:&nbsp;fixed;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">top</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">0</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">bottom</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">0</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">left</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">0</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">right</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">0</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">z-index</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">100</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">background</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">#fff</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">overflow</span>:&nbsp;auto;<br>}<br></span><span data-darkreader-inline-outline="">&lt;/<span data-darkreader-inline-outline="" data-darkreader-inline-color="">style</span>&gt;</span><br><br></code>
```

## 结尾

地址：

demo：https://xiaocheng555.github.io/page-cache/#/

代码：https://github.com/xiaocheng555/page-cache

作者：香芋好好吃

https://juejin.cn/post/7153140300817367054

___

》声明：文章著作权归作者所有，如有侵权，请联系小编删除。