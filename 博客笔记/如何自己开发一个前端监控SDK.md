   原文链接：https://juejin.cn/post/7276814487054450725

最近在负责团队前端监控系统搭建的任务。因为我们公司有统一的日志存储平台、日志清洗平台和基于 Grafana 搭建的可视化看板，就剩日志的采集和上报需要自己实现了，所以决定封装一个前端监控 SDK 来完成日志的采集和上报。

## 架构设计

因为想着以后有机会可以把自己封装的 SDK 推广给其他团队使用，所以 SDK 在架构设计上就需要有更多的可拓展性。我的想法是把 SDK 根据职责拆解成几个模块，然后有一个核心模块来管理所有的模块，各团队往不同的模块里添加插件由此实现自身定制化的需求。

我们知道一个前端监控 SDK 它需要完成的任务有：日志采集 =>日志整理 =>日志上报。所以根据这个工作流，我把整个 SDK 分成四个模块：

![Image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1uZwgQcuXibcbP9Lq1hFORlZRuJicw5BAIlgtKGRcgswlreIybWe2j2SI67Q03PLt1Kt8OyicRWH2b94A/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

架构设计.jpeg

-   Plugin：负责原始数据的采集。Plugin 内部采用插件化的方式去实现，不同的插件采集不同的数据。比如如果我们想采集网络请求相关的数据，那个可以封装一个专门采集网络请求的插件。
    
-   Builder：负责把原始数据封装成我们想要的数据结构。
    
-   Reporter：负责把数据上报到日志平台。因为考虑到一份数据可能会上报到不同的日志平台，所以 Reporter 我也是采用插件化的方式去实现，不同的插件上报到不同的日志平台。
    
-   Manager：负责和各模块之间进行通信，以及封装一些公共的方法。
    

综上，整个 SDK 的工作流程如下：

![Image](https://mmbiz.qpic.cn/sz_mmbiz_jpg/IlE1Y2rl1uZwgQcuXibcbP9Lq1hFORlZRDiaJqnjzuy5Mjibvoa4FRDMM2Na0M65Y4lb3aHvh9aziaVyyNVyAWRWZg/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

监控SDK (1).jpg

0.  Manager 建立和各个模块之间的联系。
    
1.  Plugin 中的某个插件采集到相应的数据，并把数据发送给 Manager。
    
2.  Manager 接收到来自 Plugin 的数据，并把数据转发给 Builder。
    
3.  Builder 接收到数据以后按照预设的数据处理方法对数据进行处理，处理完后再把数据发送给 Manager 。
    
4.  Manager 接收到来自 Builder 的数据，并把数据转发给 Reporter 。
    
5.  Reporter 中的每个插件接收到数据以后，会把数据上报到对应的日志平台。
    

在整个SDK运作的过程中，每个模块专注于自己的职责，全程只和 Manager 通信，不受其他模块的影响。

另外，在模块接收或者发送数据的时候都会对外暴露相应的生命周期，这样开发者就可以拿到不同阶段的数据，并对数据进行自定义处理以及决定是否要中断流程。

## 模块通信

模块通信我采用的是发布-订阅模式，并定义了3个事件：assign （注册）、receive （接收数据）、next （发送数据）。

Manager 会订阅 next 事件，而其他模块会订阅 assign 事件和 receive 事件。最开始的时候，其他模块通过 assign 事件接收到 Manager 的实例，由此其他模块就可以使用 Manager 上定义的发布-订阅相关的方法。当数据在某个模块处理完毕后，这个模块会发布 next 事件把数据传给 Manager ，Manager 接收到数据后再发布 receive 事件把数据传给下一个模块。

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">class</span>&nbsp;Manager&lt;O&nbsp;<span data-darkreader-inline-color="">extends</span>&nbsp;ManagerConfigType&gt;&nbsp;<span data-darkreader-inline-color="">extends</span>&nbsp;EventBus&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">constructor</span>(<span>config?:&nbsp;O</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">super</span>()<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.assignPlugins(config.plugins&nbsp;||&nbsp;[])<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.assignBuilder(config.builder&nbsp;||&nbsp;{})<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.assignReporter(config.reporters&nbsp;||&nbsp;[])<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.on(<span data-darkreader-inline-color="">'manager:next'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.next.bind(<span data-darkreader-inline-color="">this</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.on(<span data-darkreader-inline-color="">'manager:next'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.next.bind(<span data-darkreader-inline-color="">this</span>))<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;assignPlugins(plugins:&nbsp;<span data-darkreader-inline-color="">any</span>[])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;plugins.forEach(<span><span>plugin</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.on(<span data-darkreader-inline-color="">'plugin:assign'</span>,&nbsp;plugin.init.bind(plugin))<br>&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.emit(<span data-darkreader-inline-color="">'plugin:assign'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>)<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;assignBuilder(builder:&nbsp;<span data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.on(<span data-darkreader-inline-color="">'builder:assign'</span>,&nbsp;builder.init.bind(builder))<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.emit(<span data-darkreader-inline-color="">'builder:assign'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>)<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;assignReporter(reporters:&nbsp;<span data-darkreader-inline-color="">any</span>[])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;reporters.forEach(<span><span>reporter</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.on(<span data-darkreader-inline-color="">'reporter:assign'</span>,&nbsp;reporter.init.bind(reporter))<br>&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.emit(<span data-darkreader-inline-color="">'reporter:assign'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>)<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;从上一级模块接收数据，然后发给下一级模块</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;next(args:&nbsp;{&nbsp;<span data-darkreader-inline-color="">from</span>:&nbsp;<span data-darkreader-inline-color="">'plugin'</span>&nbsp;|&nbsp;<span data-darkreader-inline-color="">'builder'</span>&nbsp;|&nbsp;<span data-darkreader-inline-color="">'reporter'</span>,&nbsp;data:&nbsp;<span data-darkreader-inline-color="">any</span>})&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;<span data-darkreader-inline-color="">from</span>,&nbsp;data&nbsp;}&nbsp;=&nbsp;args<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">from</span>&nbsp;===&nbsp;<span data-darkreader-inline-color="">'plugin'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.emit(<span data-darkreader-inline-color="">'builder:receive'</span>,&nbsp;data)<br>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">from</span>&nbsp;===&nbsp;<span data-darkreader-inline-color="">'builder'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.emit(<span data-darkreader-inline-color="">'reporter:receive'</span>,&nbsp;data)<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">class</span>&nbsp;PluginA&lt;O&nbsp;<span data-darkreader-inline-color="">extends</span>&nbsp;PluginAConfigType&gt;&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;init(manager:&nbsp;<span data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager&nbsp;=&nbsp;manager<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;handleError(msg)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager.emit(<span data-darkreader-inline-color="">'manager:next'</span>,&nbsp;{&nbsp;<span data-darkreader-inline-color="">from</span>:&nbsp;<span data-darkreader-inline-color="">'plugin'</span>,&nbsp;data:&nbsp;msg&nbsp;})<br>&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">class</span>&nbsp;Builder&lt;O&nbsp;<span data-darkreader-inline-color="">extends</span>&nbsp;BuilderConfigType&gt;&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;init(manager:&nbsp;<span data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager&nbsp;=&nbsp;manager<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager.on(<span data-darkreader-inline-color="">'builder:receive'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.receive.bind(<span data-darkreader-inline-color="">this</span>))<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;receive(data:&nbsp;<span data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;处理数据</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;newData&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.process(data)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager.emit(<span data-darkreader-inline-color="">'manager:next'</span>,&nbsp;{&nbsp;<span data-darkreader-inline-color="">from</span>:&nbsp;<span data-darkreader-inline-color="">'builder'</span>,&nbsp;data:&nbsp;newData&nbsp;})<br>&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">class</span>&nbsp;ReporterA&lt;O&nbsp;<span data-darkreader-inline-color="">extends</span>&nbsp;ReporterAConfigType&gt;&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;init(manager:&nbsp;<span data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager&nbsp;=&nbsp;manager<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>._manager.on(<span data-darkreader-inline-color="">'reporter:receive'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.receive.bind(<span data-darkreader-inline-color="">this</span>))<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;receive(args:&nbsp;<span data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.report(args)<br>&nbsp;&nbsp;}<br>}<br></code>
```

## 接口请求捕获

在大多数情况下，前端通过HTTP的方式和服务端进行交互。不管是自己封装请求方法，还是直接使用类似于 axios 的 HTTP 请求库，都是需要基于 XHR 和 Fetch 去实现的。所以我们需要重写 XHR 和 Fetch 暴露出来的 Hook 并进行代理，由此获得请求相关的信息。

## XMLHttpRequest

`XMLHttpRequest.open()` 方法用来初始化一个新创建的请求，在这个方法里我们可以拿到请求的 URL 和请求方法。

`XMLHttpRequest.send()` 方法用来发送HTTP请求，在这个方法里我们可以拿到请求参数。

另外，在 `XMLHttpRequest.onreadystatechange` 事件里，我们可以监听到请求状态的变化。当 `xhr.readyState === XMLHttpRequest.DONE` 时表示请求操作已经完成，这时候我们就可以记录请求的状态码和请求结束的时间。

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;overideXHRMethod()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;xhrproto&nbsp;=&nbsp;XMLHttpRequest.prototype;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;originalOpen&nbsp;=&nbsp;xhrproto.open<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;originalSend&nbsp;=&nbsp;xhrproto.send<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;xhrproto.send&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;(<span><span data-darkreader-inline-color="">this</span>,&nbsp;...args:&nbsp;<span data-darkreader-inline-color="">any</span></span>):&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;xhr&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...msg,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request:&nbsp;args[<span data-darkreader-inline-color="">0</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;originalSend.apply(xhr,&nbsp;args);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;xhrproto.open&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;(<span><span data-darkreader-inline-color="">this</span>,&nbsp;...args:&nbsp;<span data-darkreader-inline-color="">any</span></span>):&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;xhr&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...msg,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url:&nbsp;args[<span data-darkreader-inline-color="">1</span>],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;method:&nbsp;(args[<span data-darkreader-inline-color="">0</span>]&nbsp;||&nbsp;<span data-darkreader-inline-color="">''</span>).toUpperCase(),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;statusCode:&nbsp;<span data-darkreader-inline-color="">0</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;startTimestamp:&nbsp;<span data-darkreader-inline-color="">Date</span>.now()&nbsp;<span data-darkreader-inline-color="">//&nbsp;请求开始时间</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;onreadystatechangeHandler&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;(<span></span>):&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(xhr.readyState&nbsp;===&nbsp;XMLHttpRequest.DONE)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.statusCode&nbsp;=&nbsp;xhr.status<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.endTimestamp&nbsp;=&nbsp;<span data-darkreader-inline-color="">Date</span>.now()&nbsp;<span data-darkreader-inline-color="">//&nbsp;请求结束时间</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.responseHeaders&nbsp;=&nbsp;xhr.getAllResponseHeaders()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;([<span data-darkreader-inline-color="">''</span>,&nbsp;<span data-darkreader-inline-color="">'json'</span>,&nbsp;<span data-darkreader-inline-color="">'text'</span>].indexOf(xhr.responseType)&nbsp;!==&nbsp;<span data-darkreader-inline-color="">-1</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg.response&nbsp;=&nbsp;<span data-darkreader-inline-color="">typeof</span>&nbsp;xhr.response&nbsp;===&nbsp;<span data-darkreader-inline-color="">'object'</span>&nbsp;?&nbsp;<span data-darkreader-inline-color="">JSON</span>.stringify(xhr.response)&nbsp;:&nbsp;xhr.response<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">catch</span>&nbsp;(e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">/*&nbsp;do&nbsp;nothing&nbsp;*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">'onreadystatechange'</span>&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;xhr&nbsp;&amp;&amp;&nbsp;<span data-darkreader-inline-color="">typeof</span>&nbsp;xhr.onreadystatechange&nbsp;===&nbsp;<span data-darkreader-inline-color="">'function'</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;original&nbsp;=&nbsp;xhr.onreadystatechange<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xhr.onreadystatechange&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;(<span>...readyStateArgs:&nbsp;<span data-darkreader-inline-color="">any</span></span>):&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onreadystatechangeHandler();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;original.apply(xhr,&nbsp;readyStateArgs);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span data-darkreader-inline-color="">else</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xhr.addEventListener(<span data-darkreader-inline-color="">'readystatechange'</span>,&nbsp;onreadystatechangeHandler);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;originalOpen.apply(xhr,&nbsp;args);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br></code>
```

如果想获取响应头可以使用方法 `XMLHttpRequest.getAllResponseHeaders()` 和 `XMLHttpRequest.getResponseHeader()` 。不过这两个方法并不能拿到所有的响应头信息，对于跨域的请求只能拿到以下几个字段：

-   `Cache-Control`
    
-   `Content-Language`
    
-   `Content-Length`
    
-   `Content-Type`
    
-   `Expires`
    
-   `Last-Modified`
    
-   `Pragma`
    

如果想拿到其他字段，需要在响应头 `Access-Control-Expose-Headers` 里指定哪些字段是可以公开的。

## Fetch

`window.fetch()` 方法用来发起获取资源的请求，它的第一个参数为请求的 URL，第二个参数为 Request 对象。它返回一个 promise，这个 promise 会在请求响应后被 resolve，并传回 Response 对象。

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&nbsp;<span data-darkreader-inline-color="">public</span>&nbsp;overideFetchMethod()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;originalFetch&nbsp;=&nbsp;<span data-darkreader-inline-color="">window</span>.fetch<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!originalFetch)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">window</span>.fetch&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>(<span>...args</span>)&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;method&nbsp;=&nbsp;<span data-darkreader-inline-color="">String</span>(args[<span data-darkreader-inline-color="">1</span>]?.method&nbsp;||&nbsp;<span data-darkreader-inline-color="">'get'</span>).toUpperCase()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;url&nbsp;=&nbsp;<span data-darkreader-inline-color="">String</span>(args[<span data-darkreader-inline-color="">0</span>])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;originalFetch.apply(<span data-darkreader-inline-color="">window</span>,&nbsp;args).catch(<span>(<span>err:&nbsp;<span data-darkreader-inline-color="">Error</span></span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;msg:&nbsp;ReportMsgType&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;method:&nbsp;method<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">throw</span>&nbsp;err<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br></code>
```

因为公司的项目里很少用到由 Fetch 发起的请求，所以这里写的比较简单。

## JS错误捕获

对于那些可预见的 JS 错误，通常我们通过 `try/catch` 去捕获。其他的 JS 错误，我们可以通过全局监听 error 事件来捕获。另外值得一提的是，对于 Promise 中的错误，如果我们有用 reject 去处理错误那么会触发 rejectionhandled 事件，否则会触发 unhandledrejection 事件。

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;handleError(event:&nbsp;ErrorEvent&nbsp;|&nbsp;PromiseRejectionEvent)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;error&nbsp;=&nbsp;<span data-darkreader-inline-color="">'error'</span>&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;event&nbsp;?&nbsp;event.error&nbsp;:&nbsp;event.reason<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;msg:&nbsp;ReportMsgType&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span data-darkreader-inline-color="">'browserError'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catchBy:&nbsp;<span data-darkreader-inline-color="">'PluginBrowser'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;initMonitor()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">window</span>.addEventListener(<span data-darkreader-inline-color="">'error'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.handleError.bind(<span data-darkreader-inline-color="">this</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">window</span>.addEventListener(<span data-darkreader-inline-color="">'unhandledrejection'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.handleError.bind(<span data-darkreader-inline-color="">this</span>))<br>&nbsp;&nbsp;}<br></code>
```

## 资源加载错误捕获

常见的前端资源加载包括图片的渲染和外部文件的引用，我们可以通过监听 img、link 和 script 标签的 error 事件来捕获这些资源的加载错误。

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">const</span>&nbsp;resourceTagName:&nbsp;<span data-darkreader-inline-color="">string</span>[]&nbsp;=&nbsp;[<span data-darkreader-inline-color="">'img'</span>,&nbsp;<span data-darkreader-inline-color="">'script'</span>,&nbsp;<span data-darkreader-inline-color="">'link'</span>]<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">class</span>&nbsp;PluginResource&lt;O&nbsp;<span data-darkreader-inline-color="">extends</span>&nbsp;ResourceConfigType&gt;&nbsp;{<br>&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;handleError(event:&nbsp;Event)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;target&nbsp;=&nbsp;event.target&nbsp;<span data-darkreader-inline-color="">as</span>&nbsp;HTMLScriptElement&nbsp;|&nbsp;HTMLLinkElement<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!target)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;tagName&nbsp;=&nbsp;(target.tagName&nbsp;||&nbsp;<span data-darkreader-inline-color="">''</span>).toLowerCase()<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;isResource&nbsp;=&nbsp;resourceTagName.includes(tagName)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!isResource)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;msg:&nbsp;ReportMsgType&nbsp;=&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;<span data-darkreader-inline-color="">'ResourceLoadError'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catchBy:&nbsp;<span data-darkreader-inline-color="">'PluginResource'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url:&nbsp;<span data-darkreader-inline-color="">'src'</span>&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;target&nbsp;?&nbsp;target.src&nbsp;:&nbsp;target.href,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tagName:&nbsp;tagName<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;initMonitor()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">window</span>.addEventListener(<span data-darkreader-inline-color="">'error'</span>,&nbsp;<span data-darkreader-inline-color="">this</span>.handleError.bind(<span data-darkreader-inline-color="">this</span>),&nbsp;<span data-darkreader-inline-color="">true</span>)<br>&nbsp;&nbsp;}<br>}<br></code>
```

## 最后

目前整个 SDK 还处于很初级的阶段，能完成常见错误类型的捕获和上报，后续随着需求的增加 SDK 需要实现更多的功能，希望后续再更新一波~

****因为微信公众号修改规则，如果不标星或点在看，你可能会收不到我公众号文章的推送，请大家将本公众号星标，看完文章后记得点下赞或者在看，谢谢各位！****

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)