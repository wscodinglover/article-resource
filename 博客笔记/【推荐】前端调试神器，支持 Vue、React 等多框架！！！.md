**背景及相关信息**

不知道你是否遇到过产品或者测试给你一个页面让你改一点东西，你却找不到页面源代码在哪里的场景？对于一些大型项目，文件数量多、文件层级深、代码行数多，查找一个页面上组件对应的源代码位置，往往需要花费大量时间。

为了解决这个问题，我开发了 `code-inspector-plugin` 插件，只需要点击页面上的元素，就能够自动打开 vscode 定位到源代码。已经在快手内部30+项目中接入了使用，取得了不错的反响。效果如下图所示：

![Image](https://mmbiz.qpic.cn/sz_mmbiz_gif/iagNW4Zy9CyZjuibqs47Oerb0MWibH1XpWOuMiaKjIziadA2nibP2gJpPnLUHFicjqwJHhthkYT0ZGFGia6vhRvST6kkqA/640?wx_fmt=gif&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

点击下述的 demo，也可以快速在线体验效果：

-   vue online demo<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[1]</sup>
    
-   react online demo<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[2]</sup>
    
-   preact online demo<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[3]</sup>
    
-   solid online demo<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[4]</sup>
    
-   接入：想要使用的小伙伴，可以参考code-inspector-plugin接入文档<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[5]</sup>接入使用
    
-   github 源码：觉得插件好用的可以辛苦动下小手帮作者 github 点个 star：code-inspector<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[6]</sup>
    

## **code-inspector-plugin 的优点**

其实 `code-inspector-plugin` 是之前我看到过一篇 react 点击页面元素定位源代码的文章，受到启发后实现的。但是相比而言， `code-inspector-plugin` 在支持场景的丰富性以及接入的便捷程度上，都得到了巨大的提升，具备以下优势：

-   支持的打包器更加广泛：支持 `webpack/vite/rspack` 以及 `umi` 等一切基于上述三个打包器实现的打包工具
    
-   支持的框架及场景更加广泛：支持 `vue2/vue3/react/preact/solid` 框架以及 `next/nuxt` 等SSR场景(以及一切以 `vue2/vue3/react/preact/solid` 框架为基础封装的 SSR 场景)，支持在微前端中使用。
    
-   支持多种系统及 IDE：支持 Mac、Windows 和 Linux 系统，支持 vscode、webstorm、atom、hbuilderX、IDEA、phpsotrm 等多种 IDE，也支持自定义 IDE 的支持
    
-   接入更加简便，对代码无侵入：无论是在什么项目中，只需要在 `webpack/vite/rspack` 的配置中添加 `code-inspector-plugin` 插件即可，不需要修改任何源代码或者其他的配置
    
-   自动识别环境：插件内部会针对 `webpack/vite/rspack` 开发环境下的一些内置信息，自动识别环境，仅在开发环境下生效，不会影响生产环境
    

## code-inspector-plugin 实现原理

下面我们重点解析一下 `code-inspector-plugin` 的实现原理，插件的整体功能可以简单拆解为以下几部分：

-   参与源码编译：打包工具(webpack/vite/rspack)编译时，`code-inspector-plugin` 插件会参与编译过程，对于 `vue/jsx` 语法会进行 ast 解析，获取到 dom 部分的源代码所在的 `文件路径、行、列` 信息，并将这些信息作为 dom 上的 `attribute` 额外添加进去。
    
-   运行时交互代码：编译完成后，插件会向网页中注入监听按键定位源代码的交互逻辑，当用户点击定位 dom 时，能够获取 dom 的 `attribute` 上的 `文件路径、行、列` 信息，将信息发送一个 http 请求给后台
    
-   启动一个 node server 服务：在后台启动一个 node server 服务，用于接收上一步发送过来的 http 请求
    
-   识别并打开 IDE：node server 收到请求后，根据请求带过来的 `文件路径、行、列` 信息，使用 node 的 `spawn` 或者 `exec` 子进程打开 IDE，并将鼠标定位到 IDE 对应的位置
    

### 编译 vue/jsx 源代码

要参与源代码的编译过程，对于 `vite` 项目，我们可以通过 vite 插件的 `transform` 函数入口中实现；对于 `webpack/rspack` 项目，可以实现一个 `loader` 实现。不同的打包工具只是对应的入口不同，而对于 `vue/jsx` 语法的编译和解析过程都是公用的。

#### 编译 vue 语法

对于 vue 语法的编译，我们可以使用 vue 内置的包 `@vue/compiler-dom` 实现，以及通过 `magic-string` 包来向 ast 注入额外的信息，简化的代码如下：

```
<span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/mOW261WJzibtvLd4SDvxsMK5mAmMjt6dnZbODicB0ibkZPeibmB9BzlK3Fcgqa3WQFqPvoicCTtqHsogtz5PgmGRMQDLGbSzAw2Pj/640?wx_fmt=svg&amp;from=appmsg" data-fail="0" data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;parse,&nbsp;transform&nbsp;}&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@vue/compiler-dom'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;MagicString&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'magic-string'</span>;<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;content&nbsp;是由&nbsp;vite&nbsp;transform&nbsp;函数或者&nbsp;webpack/rspack&nbsp;loader&nbsp;传过来的源代码</span><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;s&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">new</span>&nbsp;MagicString(content);<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;vue/react&nbsp;部分内置元素添加&nbsp;attrs&nbsp;可能报错，不处理</span><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;escapeTags&nbsp;=&nbsp;[<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'style'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'script'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'template'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'transition'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'keepalive'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'keep-alive'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'component'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'slot'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'teleport'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'transition-group'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'transitiongroup'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'suspense'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"fragment"</span><br>];<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(fileType&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'vue'</span>)&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;vue&nbsp;template&nbsp;处理</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;ast&nbsp;=&nbsp;parse(content,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;comments:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;});<br><br>&nbsp;&nbsp;transform(ast,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;nodeTransforms:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">(<span data-darkreader-inline-outline="">(<span data-darkreader-inline-outline="">node:&nbsp;TemplateChildNode</span>)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;node.type&nbsp;===&nbsp;1&nbsp;说明是元素(排除掉&nbsp;text、comment&nbsp;等)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-outline=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!node.loc.source.includes(<span data-darkreader-inline-outline="">'data-insp-path'</span>)&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.<span data-darkreader-inline-outline="" data-darkreader-inline-color="">type</span>&nbsp;===&nbsp;1&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;escapeTags.indexOf(<span data-darkreader-inline-outline="">node.tag.toLowerCase(<span data-darkreader-inline-outline=""></span>)</span>)&nbsp;===&nbsp;-1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;向&nbsp;dom&nbsp;上添加一个带有&nbsp;filepath/row/column&nbsp;的属性</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;insertPosition&nbsp;=<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.loc.start.offset&nbsp;+&nbsp;node.tag.length&nbsp;+&nbsp;1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;line,&nbsp;column&nbsp;}&nbsp;=&nbsp;node.loc.start;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;filePath&nbsp;也是&nbsp;vite&nbsp;transform&nbsp;函数或者&nbsp;webpack/rspack&nbsp;loader&nbsp;传过来的</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;addition&nbsp;=&nbsp;`&nbsp;data-insp-path="${filePath}:${line}:${column}:${<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.tag<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}"${node.props.length&nbsp;?&nbsp;'&nbsp;'&nbsp;:&nbsp;''}`;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.prependLeft(<span data-darkreader-inline-outline="">insertPosition,&nbsp;addition</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>)&nbsp;<span data-darkreader-inline-outline="">as</span>&nbsp;<span data-darkreader-inline-outline="">NodeTransform</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;],<br>&nbsp;&nbsp;});<br><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="">return</span>&nbsp;<span data-darkreader-inline-outline="">s</span>.<span data-darkreader-inline-outline="">toString</span><span data-darkreader-inline-outline="">()</span>;<br>}<br></span></code>
```

#### 编译 tsx 代码

对于 tsx 语法的编译和解析使用 `babel` 实现，并且需要引入一些 babel 相关的包，完成对于 ts、vueJsx 等场景的兼容，简化的代码如下：

```
<span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/mOW261WJzibtvLd4SDvxsMK5mAmMjt6dnZbODicB0ibkZPeibmB9BzlK3Fcgqa3WQFqPvoicCTtqHsogtz5PgmGRMQDLGbSzAw2Pj/640?wx_fmt=svg&amp;from=appmsg" data-fail="0" data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;MagicString&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'magic-string'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">type</span>&nbsp;{&nbsp;TemplateChildNode,&nbsp;NodeTransform&nbsp;}&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@vue/compiler-dom'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;vueJsxPlugin&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@vue/babel-plugin-jsx'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;{&nbsp;parse&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">as</span>&nbsp;babelParse,&nbsp;traverse&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">as</span>&nbsp;babelTraverse&nbsp;}&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@babel/core'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;tsPlugin&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@babel/plugin-transform-typescript'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;importMetaPlugin&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@babel/plugin-syntax-import-meta'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;proposalDecorators&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'@babel/plugin-proposal-decorators'</span>;<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;content&nbsp;是由&nbsp;vite&nbsp;transform&nbsp;函数或者&nbsp;webpack/rspack&nbsp;loader&nbsp;传过来的源代码</span><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;s&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">new</span>&nbsp;MagicString(content);<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;vue/react&nbsp;部分内置元素添加&nbsp;attrs&nbsp;可能报错，不处理</span><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;escapeTags&nbsp;=&nbsp;[<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'style'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'script'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'template'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'transition'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'keepalive'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'keep-alive'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'component'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'slot'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'teleport'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'transition-group'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'transitiongroup'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'suspense'</span>,<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">"fragment"</span><br>];<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(fileType&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'jsx'</span>)&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;jsx&nbsp;处理</span><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;ast&nbsp;=&nbsp;babelParse(content,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;babelrc:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">false</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;comments:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;configFile:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">false</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;plugins:&nbsp;[<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;importMetaPlugin,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[vueJsxPlugin,&nbsp;{}],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[tsPlugin,&nbsp;{&nbsp;isTSX:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span>,&nbsp;allowExtensions:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span>&nbsp;}],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[proposalDecorators,&nbsp;{&nbsp;legacy:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">true</span>&nbsp;}],<br>&nbsp;&nbsp;&nbsp;&nbsp;],<br>&nbsp;&nbsp;});<br><br>&nbsp;&nbsp;babelTraverse(ast,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;enter({&nbsp;node&nbsp;}:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">any</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.type&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'JSXElement'</span>&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;escapeTags.indexOf(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(node?.openingElement?.name?.name&nbsp;||&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">''</span>).toLowerCase()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">-1</span>&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node?.openingElement?.name?.name<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.openingElement.attributes.some(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="">(<span data-darkreader-inline-outline="">attr:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">any</span></span>)&nbsp;=&gt;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attr.type&nbsp;!==&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'JSXSpreadAttribute'</span>&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attr.name.name&nbsp;===&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'data-insp-path'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;向&nbsp;dom&nbsp;上添加一个带有&nbsp;filepath/row/column&nbsp;的属性</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;insertPosition&nbsp;=<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.openingElement.end&nbsp;-<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(node.openingElement.selfClosing&nbsp;?&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">2</span>&nbsp;:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">1</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;line,&nbsp;column&nbsp;}&nbsp;=&nbsp;node.loc.start;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;filePath&nbsp;也是&nbsp;vite&nbsp;transform&nbsp;函数或者&nbsp;webpack/rspack&nbsp;loader&nbsp;传过来的</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;addition&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">`&nbsp;data-insp-path="<span data-darkreader-inline-outline="" data-darkreader-inline-color="">${filePath}</span>:<span data-darkreader-inline-outline="" data-darkreader-inline-color="">${line}</span>:<span data-darkreader-inline-outline="" data-darkreader-inline-color="">${column&nbsp;+&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">1</span>}</span>:<span data-darkreader-inline-outline="" data-darkreader-inline-color="">${<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.openingElement.name.name<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>"<span data-darkreader-inline-outline="" data-darkreader-inline-color="">${node.openingElement.attributes.length&nbsp;?&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'&nbsp;'</span>&nbsp;:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">''</span>}</span>`</span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.prependLeft(insertPosition,&nbsp;addition);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;});<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">return</span>&nbsp;s.toString();<br>}<br></code>
```

上面 `vue/jsx` 编译完成后，其实相当于在源代码基础上为每个 dom 注入了一个 `data-insp-path` 属性，最终元素到页面上，对应的 dom 就会添加一个这样的属性，如下图所示：

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

### 运行时交互注入

`code-inspector-plugin` 插件的交互功能主要包含监听两部分：

-   监听组合键按住时，鼠标在 dom 上移动时会出现 DOM 遮罩层信息
    
-   点击遮罩层会获取 DOM `attribute` 上的源代码信息，向后台发送一个请求
    

这部分功能的实现上难度不大，就是基础的 `html+js+css`，为了保证 js 逻辑和 css 样式不会影响到宿主页面，我采用了 web component 组件的方式来封装了这部分逻辑(基于 lit 实现的 web component)。具体的实现细节将不多讲了，源码位于 packages/core/src/client/index.ts<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[7]</sup> 文件中。

为了简化用户的使用，不需要用户手动向页面中添加交互逻辑的组件，我通过 `webpack/vite/rspack` 插件，在 development 环境下将 web component 组件注入到页面中。

### 本地的 Node Server 服务

Node Server 同样是插件在 `webpack/vite/rspack` 开始编译的时候启动的，用于监听用户发送 http 请求。

我们设置了一个默认的端口 `6666`，为了防止端口冲突，我们需要使用 `portFinder` 继续向下寻找一个可用的接口去启动服务：

```
<span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/mOW261WJzibtvLd4SDvxsMK5mAmMjt6dnZbODicB0ibkZPeibmB9BzlK3Fcgqa3WQFqPvoicCTtqHsogtz5PgmGRMQDLGbSzAw2Pj/640?wx_fmt=svg&amp;from=appmsg" data-fail="0" data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;http&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'http'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;portFinder&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'portfinder'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;path&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'path'</span>;<br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">import</span>&nbsp;launchEditor&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">from</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'./launch-editor'</span>;<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;DefaultPort&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">6666</span>;<br><br><span data-darkreader-inline-outline="" data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">startServer</span>(<span data-darkreader-inline-outline="">callback:&nbsp;(port:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">number</span>)&nbsp;=&gt;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">any</span>,&nbsp;editor?:&nbsp;Editor</span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;server&nbsp;=&nbsp;http.createServer(<span data-darkreader-inline-outline="">(<span data-darkreader-inline-outline="">req:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">any</span>,&nbsp;res:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">any</span></span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;收到请求唤醒vscode</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;params&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">new</span>&nbsp;URLSearchParams(req.url.slice(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">1</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;file&nbsp;=&nbsp;params.get(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'file'</span>)&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">as</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;line&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">Number</span>(params.get(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'line'</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">const</span>&nbsp;column&nbsp;=&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">Number</span>(params.get(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'column'</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;res.writeHead(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">200</span>,&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'Access-Control-Allow-Origin'</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'*'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'Access-Control-Allow-Methods'</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'*'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'Access-Control-Allow-Headers'</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'*'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'Access-Control-Allow-Private-Network'</span>:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'true'</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;res.end(<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'ok'</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;launchEditor(file,&nbsp;line,&nbsp;column,&nbsp;editor);<br>&nbsp;&nbsp;});<br><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;寻找可用接口</span><br>&nbsp;&nbsp;portFinder.getPort({&nbsp;port:&nbsp;DefaultPort&nbsp;},&nbsp;<span data-darkreader-inline-outline="">(<span data-darkreader-inline-outline="">err:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">Error</span>,&nbsp;port:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">number</span></span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">if</span>&nbsp;(err)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">throw</span>&nbsp;err;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;server.listen(port,&nbsp;<span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="">()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback(port);<br>&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;});<br>}<br></code>
```

### 识别并打开 IDE

Node Server 接收到了请求后，需要打开用户的 IDE 并定位到源代码，这一步是如何实现的呢？

市面上大多数的 IDE，多支持通过 `{IDE路径} -g {path}:{line}:{column}` 的终端命令，打开 IDE 并将鼠标光标定位到指定的位置，部分 IDE 还支持在全局安装命令行工具简化使用。以 vscode 为例，有两种方式：

1.  在终端通过 vscode 应用路径直接打开应用
    
2.  通过安装 vscode 提供的命令行工具，在终端通过 `code` 指令唤醒，launching-from-the-command-line<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[8]</sup>
    

这里我们采用了第二种方式，通过 node 的 `spwan` 或者 `exec` 启动一个子进程，执行 `code -g 文件路径:行:列` 就能打开 vscode 并定位到对应的文件路径、行、列位置，简化代码如下：

```
<span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/mOW261WJzibtvLd4SDvxsMK5mAmMjt6dnZbODicB0ibkZPeibmB9BzlK3Fcgqa3WQFqPvoicCTtqHsogtz5PgmGRMQDLGbSzAw2Pj/640?wx_fmt=svg&amp;from=appmsg" data-fail="0" data-darkreader-inline-outline="" data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-outline="" data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">function</span>&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">launchEditor</span>(<span data-darkreader-inline-outline=""><br>&nbsp;&nbsp;fileName:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">string</span>,<br>&nbsp;&nbsp;lineNumber:&nbsp;unknown,<br>&nbsp;&nbsp;colNumber:&nbsp;unknown,<br>&nbsp;&nbsp;_editor?:&nbsp;Editor<br></span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;others&nbsp;code....</span><br><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">let</span>&nbsp;[editor,&nbsp;...args]&nbsp;=&nbsp;guessEditor(_editor);<br><br>&nbsp;&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">//&nbsp;others&nbsp;code....</span><br><br>&nbsp;&nbsp;_childProcess&nbsp;=&nbsp;child_process.spawn(editor,&nbsp;args,&nbsp;{&nbsp;stdio:&nbsp;<span data-darkreader-inline-outline="" data-darkreader-inline-color="">'inherit'</span>&nbsp;});<br>}<br></code>
```

除了如何打开 IDE 的问题，另一个要解决的问题是，如果用户设备上安装了多种 IDE，我们要打开哪个 IDE？

这个功能我们是基于 react-devtools<sup data-darkreader-inline-outline="" data-darkreader-inline-color="">[9]</sup> 的源码实现了，它会去匹配用户当前设备上正在运行的进程，在 IDE 列表中匹配打开。在此基础上我们优化并丰富了这部分的功能，支持了以下特性：

-   优化了 IDE 的匹配顺序：因为对于 web 项目，大多数开发者使用的 IDE 是 vscode 或者 webstorm，所以我们会优先匹配这两个 IDE
    
-   支持用户指定 IDE：支持用户通过在 `.env.local` 文件中指定声明要打开的 IDE，除了内置支持识别的 IDE 外，用户也可以用 IDE 可执行路径方式指定（意味着支持所有 IDE）
    

**代码架构设计**  

上面的实现原理中，我们讲述了 `code-inspector-plugin` 插件的核心内容，除了这部分之外，还想分享下我们在代码可维护性和用户使用体验方面所做的努力。

### **分包提升可维护性**

上述核心内容的实现，绝大部分是与 `vite/webpack/rspack` 等打包器无关的，打包器插件只是作为代码编译和交互代码注入的入口承载。所以我们采用 monorepo 架构，将核心代码都提取到了 `core` 中，monorepo 的包如下：

```
📦packages<br> ┣ 📂code-inspector-plugin --------------------------   入口包<br> ┣ 📂core ----------------------------------------  核心代码处理<br> ┣ 📂vite-plugin ---------------------------------  vite 插件<br> ┗ 📂webpack-plugin ---------------------------   webpack 插件<br>
```

其中，`vite-plugin` 和 `webpack-plugin` 分别作为 vite 和 webpack 的入口。（rspack 由于在插件系统的设计上完全支持了 webpack，所以可以直接使用 webpack-plugin 作为 rspack 的入口，如果后面二者出现差异，会考虑再分一个 `rspack-plugin` 的包）。

同时为了降低用户在多种打包器中的接入心智，我们使用 `code-inspector-plugin` 将 `vite/webpack/rspack` 等不同项目的插件进行了整合作为唯一入口，用户只需要通过 `bundler` 参数指定项目的打包器即可，其他配置完全一致。

**降低用户接入本**

在降低用户成本方面，我们主要做了两件事情：

1.  为了让用户不需要修改任何的源代码，我们对于页面交互的代码，直接通过插件注入，不需要用户手动引入任何的组件，对用户代码无任何侵入。
    
2.  对于 webpack 和 rspack 的项目，像启动 node 服务这种逻辑是在插件中实现的，而参与源代码的编译需要在 `loader` 中实现。虽然让用户同时接入一个 `plugin` 和一个 `loader` 成本也没有那么高，但是为了最大程度降低用户接入成本，我们插件会在 webpack/rspack 编译前，自动将 `loader` 添加到 `module.rules` 中，用户只需要接入一个 `plugin` 即可，免去了 `loader` 的接入成本。
    

原文地址：https://juejin.cn/post/7326002010084311079

作者：快手基础平台前端 o翔哥o

## ❤️ 看完两件事

如果你觉得这篇内容对你挺有启发，我想邀请你帮我两个小忙：

1.  点个「**在看**」，让更多的人也能看到这篇内容（喜欢不点在看，都是耍流氓 -\_-）
    
2.  关注公众号「**Vue社区**」，每周重点攻克一个前端面试重难点，
    
    公众号后台回复「**电子书**」即可免费获取 27本 精选的前端电子书！
    

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

点个在看支持我吧，转发就更好了