```
<section><mp-common-profile data-pluginname="mpprofile" data-id="MzAxMTMyOTk3MA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/e93fo6YQKNmP3YCibFqeuFenfGuV6cesicX6UicG1VZwLlibogEJmbSRNoSwx8JxuQ06WKJXgz5xyv20jicbGTUbwxw/300?wx_fmt=png&amp;wxfrom=19" data-nickname="React" data-alias="react_native" data-signature="互联网从业者，专注于 React系列精彩内容推荐。关注大前端、Node技术全栈、Flutter、WebAssembly、鸿蒙（harmonyOS）、小程序等互联网科技领域最前沿技术，定期分享个人创业经验。" data-from="0" data-is_biz_ban="0" data-origin_num="50" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile></section><p data-style="outline: 0px; color: rgb(0, 0, 0); font-size: 16px; white-space: normal; font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; text-align: center; visibility: visible;" data-darkreader-inline-outline="" data-darkreader-inline-color=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">点击上方&nbsp;</span><span data-darkreader-inline-outline=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">React</span></span><span data-darkreader-inline-outline="" data-darkreader-inline-color="">，关注公众号</span><span data-darkreader-inline-outline="" data-darkreader-inline-color=""></span></p><p data-style="outline: 0px; color: rgb(34, 34, 34); font-size: 16px; white-space: normal; font-family: system-ui, -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; letter-spacing: 0.544px; text-align: center; word-spacing: 0.8px; visibility: visible;" data-darkreader-inline-outline="" data-darkreader-inline-color=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">回复</span><span data-style="outline: 0px; color: rgb(0, 0, 0); caret-color: rgb(51, 51, 51); font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif; font-size: 14px; letter-spacing: 0.544px; word-spacing: 2px; visibility: visible;" data-darkreader-inline-outline="" data-darkreader-inline-color=""><span data-darkreader-inline-outline="" data-darkreader-inline-color="">加群</span></span><span data-darkreader-inline-outline="" data-darkreader-inline-color="">，加入技术交流群交流</span></p>
```

## 什么是 EventBus

EventBus 事件总线是发布订阅设计模式的应用。多个模块 `module1`，`module2`，`module3`都订阅了事件 `EventA` ，然后我们在 `module4` 中通过事件总线发布事件 `EventA` ，事件总线会通知所有订阅者`module1`，`module2`，`module3`，它们收到消息会执行对应函数逻辑，注意这里通知的时候还可以传递 `extraArgs` 参数。

看一下 `EventBus` 的原理图可能更好理解

![Image](https://mmbiz.qpic.cn/mmbiz_png/MDPRplBm9ZWgSTcsT0P0mfqteufh59GzhPMNV3diaCvuqT3NGQh4huZswrjJib41qJ1yex0k1eTTAcS7MiaHbicqww/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

image.png

## 面试：手写实现一个EventBus

答这道题可以考虑用循序渐进的方式，先实现一个基础版本的 `EventBus` ，然后不断升级完善。

### 基础版本实现

实现核心思路点：

1.  创建一个 `eventMap` 集合用来存储事件，`key` 为 事件名称，`value` 位事件数组列表
    
2.  订阅功能：实现一个`subscribe`订阅函数
    
3.  发布功能：实现一个`emit`发布函数
    

基础版代码实现：

```
<span><span data-darkreader-inline-color="">class</span>&nbsp;<span data-darkreader-inline-color="">EventBus</span></span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">constructor</span>(){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;用来存储发布订阅事件的集合</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap&nbsp;=&nbsp;{}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;</span>eventName&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件函数}</span>&nbsp;</span>funCallback&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subscribe(eventName,funCallback){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;判断是否订阅过</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,eventName)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Reflect</span>.set(<span data-darkreader-inline-color="">this</span>.eventMap,eventName,[])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName].push(funCallback);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;发布事件<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;</span>eventName&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@returns&nbsp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;emit(eventName){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,eventName)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`从未订阅过此事件<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;callbackList&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(callbackList.length&nbsp;===&nbsp;<span>0</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`事件<span>${eventName}</span>无函数可执行`</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">this</span>.eventMap[eventName].length){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>&nbsp;(<span data-darkreader-inline-color="">const</span>&nbsp;fun&nbsp;<span data-darkreader-inline-color="">of</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun.call(<span data-darkreader-inline-color="">this</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">const</span>&nbsp;eventBus&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;EventBus();<br><br><span data-darkreader-inline-color="">const</span>&nbsp;fun1&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>(<span></span>)</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">'11111'</span>);<br>}<br><br><span data-darkreader-inline-color="">const</span>&nbsp;fun2&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>(<span></span>)</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span>222222</span>);<br>}<br>eventBus.subscribe(<span data-darkreader-inline-color="">'testName'</span>,fun1);<br>eventBus.subscribe(<span data-darkreader-inline-color="">'testName'</span>,fun2);<br>eventBus.subscribe(<span data-darkreader-inline-color="">'testName2'</span>,fun2)<br>eventBus.emit(<span data-darkreader-inline-color="">'testName'</span>);<br>
```

### 升级一（发布函数调用增加参数,增加最大订阅数量限制）

基于基础版本，升级一新增的功能

1.  发布函数时，需要传递一些额外参数，怎么实现？
    
2.  可以限制每个监听函数的最大数量，怎么实现？
    

> 这个版本都是实现所有的 `eventName`有一个相同的最大订阅数量，那如果每一个事件的最大订阅数量不一样，怎么搞，速录 是不是可以使用 `Reflect` 对对象定一个一个元数据，提供个思路感兴趣小伙伴自己实现下。

代码实现

```
<span><span data-darkreader-inline-color="">class</span>&nbsp;<span data-darkreader-inline-color="">UpgradeEventBus</span></span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">constructor</span>(maxListeners){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;用来存储发布订阅事件的集合</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap&nbsp;=&nbsp;{}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners&nbsp;=&nbsp;maxListeners&nbsp;||&nbsp;<span data-darkreader-inline-color="">Infinity</span>;&nbsp;<span data-darkreader-inline-color="">//&nbsp;基于基础版本的变化</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;</span>eventName&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件函数}</span>&nbsp;</span>funCallback&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subscribe(eventName,funCallback){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;判断是否订阅过</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,eventName)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Reflect</span>.set(<span data-darkreader-inline-color="">this</span>.eventMap,eventName,[])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName].push(funCallback);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;发布事件<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;</span>eventName&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件执行额外参数}</span>&nbsp;<span data-darkreader-inline-color="">args</span></span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<span>@returns&nbsp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;emit(eventName,...args){&nbsp;<span data-darkreader-inline-color="">//&nbsp;基于基础版本的变化(增加了第二个参数)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,eventName)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`从未订阅过此事件<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;callbackList&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">this</span>.maxListeners&nbsp;!==&nbsp;<span data-darkreader-inline-color="">Infinity</span>&nbsp;&amp;&amp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName].length&nbsp;&gt;=&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`该事件<span>${eventName}</span>超过了最大监听数`</span>);&nbsp;<span data-darkreader-inline-color="">//&nbsp;基于基础版本的变化</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(callbackList.length&nbsp;===&nbsp;<span>0</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`事件<span>${eventName}</span>无函数可执行`</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">this</span>.eventMap[eventName].length){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>&nbsp;(<span data-darkreader-inline-color="">const</span>&nbsp;fun&nbsp;<span data-darkreader-inline-color="">of</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun.call(<span data-darkreader-inline-color="">this</span>,...args)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">const</span>&nbsp;eventBus&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;UpgradeEventBus(<span>20</span>);<br><br><span data-darkreader-inline-color="">const</span>&nbsp;fun1&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>(<span></span>)</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">'打印额外参数'</span>,...arguments);&nbsp;<span data-darkreader-inline-color="">//&nbsp;打印额外参数&nbsp;额外参数二娃</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">'11111'</span>);<br>}<br><br><span data-darkreader-inline-color="">const</span>&nbsp;fun2&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>(<span></span>)</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span>222222</span>);<br>}<br>eventBus.subscribe(<span data-darkreader-inline-color="">'testName'</span>,fun1);<br>eventBus.subscribe(<span data-darkreader-inline-color="">'testName'</span>,fun2);<br>eventBus.subscribe(<span data-darkreader-inline-color="">'testName2'</span>,fun2)<br>eventBus.emit(<span data-darkreader-inline-color="">'testName'</span>,<span data-darkreader-inline-color="">'额外参数二娃'</span>);<br>
```

### 升级二 (增加取消订阅/清空事件/订阅一次功能)

#### 清空事件功能

清空事件功能实现，比较简单，一种是`clear`,根据事件名称来清空；另一种是清空整个事件。只需要增加两个函数即可

```
<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;*&nbsp;清空某个事件名称下所有回调函数<br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;<span data-darkreader-inline-color="">eventName</span></span><br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@returns</span><br>&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;clear(eventName)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!eventName)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`需提供要被清除的事件名称<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;delete&nbsp;this.eventMap[eventName];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Reflect</span>.deleteProperty(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName);<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;*&nbsp;清空事件监听函数<br>&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;clearAll()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;}<br>
```

#### 取消订阅功能

原有的存储结构不能满足取消订阅功能，原有结构 `{key:value(value是数组结构)}`，需要变更为 `{key:{id1:value1,id2:value2,id3:value3}}` , 这样取消订阅可以根据每一个函数对应的 `id` 去取消(因根据 `id` 取消，要保证 id 的唯一性)，本文代码实现时，保证 `id` 唯一性，通过自增的方式实现，声明了一个 `callbackId` 。 这里的结构变化可能看一下原理图更清晰

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

image.png

具体修改和代码实现如下

```
<span><span data-darkreader-inline-color="">class</span>&nbsp;<span data-darkreader-inline-color="">UpgradeEventBus2</span>&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">constructor</span>(maxListeners)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;用来存储发布订阅事件的集合</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners&nbsp;=&nbsp;maxListeners&nbsp;||&nbsp;<span data-darkreader-inline-color="">Infinity</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.callbackId&nbsp;=&nbsp;<span>0</span>;<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;*<br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;<span data-darkreader-inline-color="">eventName</span></span><br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件函数}</span>&nbsp;<span data-darkreader-inline-color="">funCallback</span></span><br>&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;subscribe(eventName,&nbsp;funCallback)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;判断是否订阅过</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Reflect</span>.set(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName,&nbsp;{});<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;判断是否超过了最大监听数</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners&nbsp;!==&nbsp;<span data-darkreader-inline-color="">Infinity</span>&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Object</span>.keys(<span data-darkreader-inline-color="">this</span>.eventMap[eventName]).length&nbsp;&gt;=&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners<br>&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`该事件<span>${eventName}</span>超过了最大监听数`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;以下原始订阅部分要做修改，因为存储结构从普通对象调整</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;修改前代码</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;this.eventMap[eventName].push(funCallback);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;修改后代码</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;thisCallbackId&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.callbackId&nbsp;++;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName][thisCallbackId]&nbsp;=&nbsp;funCallback;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;用于取消订阅的函数</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;unSubscribe&nbsp;=&nbsp;<span><span>()</span>=&gt;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;根据&nbsp;callbackId&nbsp;取消订阅对应的&nbsp;funCallback</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName][thisCallbackId];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;如果一个事件下的&nbsp;funCallback&nbsp;为空，清掉&nbsp;eventName</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">Object</span>.keys(<span data-darkreader-inline-color="">this</span>.eventMap[eventName]).length&nbsp;===&nbsp;<span>0</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unSubscribe<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;*&nbsp;发布事件<br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;<span data-darkreader-inline-color="">eventName</span></span><br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件执行额外参数}</span>&nbsp;<span data-darkreader-inline-color="">args</span></span><br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@returns</span><br>&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;emit(eventName,&nbsp;...args)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`从未订阅过此事件<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;callbackList&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;因eventMap&nbsp;结构变化后，一下发布调用函数部分会有变化</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;改动前</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;if&nbsp;(callbackList.length&nbsp;===&nbsp;0)&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;console.warn(`该事件${eventName}下无可执行的订阅者`);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;return;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;}</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;if&nbsp;(this.eventMap[eventName].length)&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;for&nbsp;(const&nbsp;fun&nbsp;of&nbsp;this.eventMap[eventName])&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun.call(this,&nbsp;...args);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;改动后</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">Object</span>.keys(callbackList).length&nbsp;===&nbsp;<span>0</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`该事件<span>${eventName}</span>下无可执行的订阅者`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>&nbsp;(<span data-darkreader-inline-color="">const</span>&nbsp;callback&nbsp;<span data-darkreader-inline-color="">of</span>&nbsp;<span data-darkreader-inline-color="">Object</span>.values(callbackList))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback()<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;*&nbsp;清空某个事件名称下所有回调函数<br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@param&nbsp;<span data-darkreader-inline-color="">{事件名称}</span>&nbsp;<span data-darkreader-inline-color="">eventName</span></span><br>&nbsp;&nbsp;&nbsp;*&nbsp;<span>@returns</span><br>&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;clear(eventName)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!eventName)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`需提供要被清除的事件名称<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;delete&nbsp;this.eventMap[eventName];</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Reflect</span>.deleteProperty(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName);<br>&nbsp;&nbsp;}<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">/**<br>&nbsp;&nbsp;&nbsp;*&nbsp;清空事件监听函数<br>&nbsp;&nbsp;&nbsp;*/</span><br>&nbsp;&nbsp;clearAll()&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">const</span>&nbsp;eventBus&nbsp;=&nbsp;<span data-darkreader-inline-color="">new</span>&nbsp;UpgradeEventBus2(<span>20</span>);<br><br><span data-darkreader-inline-color="">const</span>&nbsp;fun1&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;(<span></span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">"打印额外参数"</span>,&nbsp;...arguments);&nbsp;<span data-darkreader-inline-color="">//&nbsp;打印额外参数&nbsp;额外参数二娃</span><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span data-darkreader-inline-color="">"11111"</span>);<br>};<br><br><span data-darkreader-inline-color="">const</span>&nbsp;fun2&nbsp;=&nbsp;<span><span data-darkreader-inline-color="">function</span>&nbsp;(<span></span>)&nbsp;</span>{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.log(<span>222222</span>);<br>};<br>eventBus.subscribe(<span data-darkreader-inline-color="">"testName"</span>,&nbsp;fun1);<br><span data-darkreader-inline-color="">const</span>&nbsp;{&nbsp;unSubscribe&nbsp;}&nbsp;=&nbsp;eventBus.subscribe(<span data-darkreader-inline-color="">"testName"</span>,&nbsp;fun2);<br>unSubscribe();<span data-darkreader-inline-color="">//&nbsp;取消订阅fun2</span><br>eventBus.emit(<span data-darkreader-inline-color="">"testName"</span>,&nbsp;<span data-darkreader-inline-color="">"额外参数二娃"</span>);<br>
```

#### 只订阅一次功能

只可订阅一次功能的实现思路，不改变原有的 `subscribe` 函数，新提供一个`subscribeOne`函数, `callbackId` 中增加一个 `one` 前缀，订阅后仍然存储到 `eventMap`结构中。那怎么做到只订阅一次呢？在 `emit`发布里面做文章，发布时判断如果是`one`前缀的 `id`，说明只执行一次就可以，然后从 `eventMap`中删除掉

具体代码实现如下:

-   增加了 `subscribeOne` 函数
    
-   修改了 `emit` 函数
    

```
subscribeOne(evenName,callback){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!<span data-darkreader-inline-color="">this</span>.eventSet[evenName]){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventSet[evenName]&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;theCallbackId&nbsp;=&nbsp;<span data-darkreader-inline-color="">'one'</span>&nbsp;+&nbsp;<span data-darkreader-inline-color="">this</span>.callbackId++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventSet[evenName][theCallbackId]&nbsp;=&nbsp;callback;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;取消订阅(这种订阅取消，只能通过)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;unSubscribe&nbsp;=&nbsp;<span><span>()</span>=&gt;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;根据callbackId去取消订阅对应的callback</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventSet[eventName][theCallbackId]&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;如果一个事件下的callback为空，直接清掉eventName</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">Object</span>.keys(<span data-darkreader-inline-color="">this</span>.eventSet[evenName]).length&nbsp;===&nbsp;<span>0</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventSet[eventName]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;unSubscribe<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;emit(eventName,&nbsp;...args)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!<span data-darkreader-inline-color="">Reflect</span>.has(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`从未订阅过此事件<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;callbackList&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;因eventMap&nbsp;结构变化后，一下发布调用函数部分会有变化</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;改动前</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;if&nbsp;(callbackList.length&nbsp;===&nbsp;0)&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;console.warn(`该事件${eventName}下无可执行的订阅者`);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;return;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;}</span><br>&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;if&nbsp;(this.eventMap[eventName].length)&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;for&nbsp;(const&nbsp;fun&nbsp;of&nbsp;this.eventMap[eventName])&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fun.call(this,&nbsp;...args);</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;改动后</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(<span data-darkreader-inline-color="">Object</span>.keys(callbackList).length&nbsp;===&nbsp;<span>0</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`该事件<span>${eventName}</span>下无可执行的订阅者`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;改动前</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;for&nbsp;(const&nbsp;callback&nbsp;of&nbsp;Object.values(callbackList))&nbsp;{</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback()</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;====&gt;&nbsp;改动后</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>&nbsp;(<span data-darkreader-inline-color="">const</span>&nbsp;[id,&nbsp;callback]&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;<span data-darkreader-inline-color="">Object</span>.entries(callbackList))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">//&nbsp;如果是只执行一次的订阅者&nbsp;判断只订阅一次的回调函数要删除</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(id.startsWith(<span data-darkreader-inline-color="">'one'</span>)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;callbackList[id];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br>
```

将这段代码补充到前面第 `2`点就 `js`版本的 `EventBus` 就比较完善了。

### 升级三 (改造为 TypeScript 版本)

`TypeScript` 就不多说了，直接将上面的 `js` 代码转换为 `ts`，直接上代码。

```
<span data-darkreader-inline-color="">type</span>&nbsp;EventCallback&nbsp;=&nbsp;<span>(<span>...args:&nbsp;<span data-darkreader-inline-color="">any</span>[]</span>)&nbsp;=&gt;</span>&nbsp;<span data-darkreader-inline-color="">void</span>;<br><br><span data-darkreader-inline-color="">interface</span>&nbsp;UnsubscribeFunction&nbsp;{<br>&nbsp;&nbsp;():&nbsp;<span data-darkreader-inline-color="">void</span>;<br>}<br><br><span data-darkreader-inline-color="">class</span>&nbsp;UpgradeEventBus2&nbsp;{<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;eventMap:&nbsp;Record&lt;<span data-darkreader-inline-color="">string</span>,&nbsp;Record&lt;<span data-darkreader-inline-color="">string</span>,&nbsp;EventCallback&gt;&gt;&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;maxListeners:&nbsp;<span data-darkreader-inline-color="">number</span>;<br>&nbsp;&nbsp;<span data-darkreader-inline-color="">private</span>&nbsp;callbackId:&nbsp;<span data-darkreader-inline-color="">number</span>&nbsp;=&nbsp;<span>0</span>;<br><br>&nbsp;&nbsp;<span data-darkreader-inline-color="">constructor</span>(<span>maxListeners:&nbsp;<span data-darkreader-inline-color="">number</span>&nbsp;=&nbsp;<span data-darkreader-inline-color="">Infinity</span></span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners&nbsp;=&nbsp;maxListeners;<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;subscribe(eventName:&nbsp;<span data-darkreader-inline-color="">string</span>,&nbsp;funCallback:&nbsp;EventCallback):&nbsp;UnsubscribeFunction&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!<span data-darkreader-inline-color="">this</span>.eventMap[eventName])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName]&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners&nbsp;!==&nbsp;<span data-darkreader-inline-color="">Infinity</span>&nbsp;&amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Object</span>.keys(<span data-darkreader-inline-color="">this</span>.eventMap[eventName]).length&nbsp;&gt;=&nbsp;<span data-darkreader-inline-color="">this</span>.maxListeners<br>&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`该事件&nbsp;<span>${eventName}</span>&nbsp;超过了最大监听数`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;thisCallbackId&nbsp;=&nbsp;<span data-darkreader-inline-color="">String</span>(<span data-darkreader-inline-color="">this</span>.callbackId++);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName][thisCallbackId]&nbsp;=&nbsp;funCallback;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName][thisCallbackId];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">Object</span>.keys(<span data-darkreader-inline-color="">this</span>.eventMap[eventName]).length&nbsp;===&nbsp;<span>0</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;emit(eventName:&nbsp;<span data-darkreader-inline-color="">string</span>,&nbsp;...args:&nbsp;<span data-darkreader-inline-color="">any</span>[]):&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;callbackList&nbsp;=&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!callbackList)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`从未订阅过此事件&nbsp;<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>&nbsp;(<span data-darkreader-inline-color="">const</span>&nbsp;[id,&nbsp;callback]&nbsp;of&nbsp;<span data-darkreader-inline-color="">Object</span>.entries(callbackList))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback(...args);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(id.startsWith(<span data-darkreader-inline-color="">'one'</span>))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;callbackList[id];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;clear(eventName:&nbsp;<span data-darkreader-inline-color="">string</span>):&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!eventName)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`需提供要被清除的事件名称&nbsp;<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;Reflect.deleteProperty(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName);<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;clearAll():&nbsp;<span data-darkreader-inline-color="">void</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;subscribeOne(eventName:&nbsp;<span data-darkreader-inline-color="">string</span>,&nbsp;callback:&nbsp;EventCallback):&nbsp;UnsubscribeFunction&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!<span data-darkreader-inline-color="">this</span>.eventMap[eventName])&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName]&nbsp;=&nbsp;{};<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">const</span>&nbsp;theCallbackId&nbsp;=&nbsp;<span data-darkreader-inline-color="">'one'</span>&nbsp;+&nbsp;<span data-darkreader-inline-color="">String</span>(<span data-darkreader-inline-color="">this</span>.callbackId++);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName][theCallbackId]&nbsp;=&nbsp;callback;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span><span>()</span>&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName][theCallbackId];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(<span data-darkreader-inline-color="">Object</span>.keys(<span data-darkreader-inline-color="">this</span>.eventMap[eventName]).length&nbsp;===&nbsp;<span>0</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">delete</span>&nbsp;<span data-darkreader-inline-color="">this</span>.eventMap[eventName];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;}<br>}<br><br><span data-darkreader-inline-color="">export</span>&nbsp;<span data-darkreader-inline-color="">default</span>&nbsp;UpgradeEventBus2;<br>
```

### 升级四 (EventBus 支持链式调用设计模式)

如果想让你的 `EventBus`支持链式调用(`职责链设计模式`)，那么取消订阅的功能就不能放到订阅函数中返回了，否则无法做到完全支持链式调用，这里我就不全部改造了，链式调用可以在每个方法调用后返回当前对象的**引用**。

举一个函数的例子:

```
&nbsp;clear(eventName:&nbsp;string):&nbsp;UpgradeEventBus2&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>&nbsp;(!eventName)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">console</span>.warn(<span data-darkreader-inline-color="">`需提供要被清除的事件名称&nbsp;<span>${eventName}</span>`</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">this</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">Reflect</span>.deleteProperty(<span data-darkreader-inline-color="">this</span>.eventMap,&nbsp;eventName);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<span data-darkreader-inline-color="">this</span>;&nbsp;<span data-darkreader-inline-color="">//&nbsp;Return&nbsp;the&nbsp;current&nbsp;instance&nbsp;for&nbsp;chaining</span><br>&nbsp;&nbsp;}<br>
```

## 发布订阅应用场景

> 目前篇幅已经很长了，我把应用场景实战代码讲解部分单独再开一篇文章,先了解一下可以有这些场景，感兴趣的同学可以先自己实现学习下。

1.`Mobx` 实现`Mobx` 的实现中，依赖搜集  被观察者变时触发所有依赖全部执行一遍，都是依赖发布订阅，这里后面会单独出一篇文章讲解。

> 这里突然产生一点需=想法，所有的知识之间都是相通的，是在看Mobx实现过程。

2.  表单保存校验功能
    
3.  当组件层级较深时，数据通信
    
4.  `Node.js` 中 `EventEmitter` 模块
    

欢迎关注「React」

号内回复

 "精选" ，将为您推送 历史精选文章"react" ，将为您推送 React.js 相关的学习资料 "学习指南" ，将为您推送 React-Native学习指南 "vue" ，将为您推送vue.js 相关文章 "小程序" ，将为您推送小程序相关文章 "微信小商店"，将为您推送小程序相关文章 "加群" ，添加群主好友拉你进群

加我私人微信，拉你进 React进阶、面试交流群，互相监督学习进步等！

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

“在看和转发”就是最大的支持