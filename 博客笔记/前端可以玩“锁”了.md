â€œé”â€ç»å¸¸ä½¿ç”¨åœ¨å¤šè¿›ç¨‹çš„è¯­è¨€ç†å’Œæ•°æ®åº“äº‹åŠ¡çš„æ¶æ„å½“ä¸­ï¼Œç°åœ¨ Web API å½“ä¸­ä¹Ÿæä¾›äº†â€œé”â€- **ã€ŒWeb Locks APIã€**ã€‚

## é¢†åŸŸ

åœ¨æµè§ˆå™¨å¤šæ ‡ç­¾é¡µæˆ– worker ä¸­è¿è¡Œçš„è„šæœ¬ä¸­è·å–é”ï¼Œæ‰§è¡Œå·¥ä½œæ—¶ä¿æŒé”ï¼Œæœ€åé‡Šæ”¾é”ã€‚

> â
> 
> é”çš„èŒƒå›´ä»…é™äºåŒä¸€æºå†…
> 
> â

## è¯·æ±‚é”

åŒä¸€æºä¸‹ï¼Œå½“æŒæœ‰é”æ—¶ï¼Œå…¶ä»–ç›¸åŒé”çš„è¯·æ±‚å°†æ’é˜Ÿï¼Œä»…å½“é”è¢«é‡Šæ”¾æ—¶ç¬¬ä¸€ä¸ªæ’é˜Ÿçš„è¯·æ±‚æ‰ä¼šè¢«æˆäºˆé”ã€‚

> â
> 
> å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•åé”ä¼šè‡ªåŠ¨é‡Šæ”¾
> 
> â

```
<span></span><code>navigator.locks.request(<span>'mylock'</span>,&nbsp;{},&nbsp;<span>async</span>&nbsp;(lock)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;<span>console</span>.log(lock);<br>});<br></code>
```

åœ¨è¿™é‡Œæˆ‘ä»¬èƒ½çœ‹åˆ° request æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆå¯é€‰ï¼‰ï¼Œå¯ä»¥åœ¨è¯·æ±‚é”æ—¶ä¼ é€’ä¸€äº›é€‰é¡¹ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨åè¾¹ä¼šä»‹ç»åˆ°ã€‚

## ç›‘æ§é”

åˆ¤æ–­é”ç®¡ç†å™¨çš„çŠ¶æ€ï¼Œæœ‰åˆ©äºè°ƒè¯•ï¼›è¿”å›ç»“æœæ˜¯ä¸€ä¸ªé”ç®¡ç†å™¨çŠ¶æ€çš„å¿«ç…§ï¼Œæ ‡è¯†äº†æŒæœ‰é”å’Œè¯·æ±‚ä¸­çš„é”çš„æœ‰å…³æ•°æ®ï¼Œåƒåç§°ã€client\_idå’Œæ¨¡å¼ã€‚

```
<span></span><code>navigator.locks.query().then(<span>(<span>locks</span>)&nbsp;=&gt;</span>&nbsp;{<br>&nbsp;&nbsp;<span>console</span>.log(locks);<br>});<br></code>
```

## å®ç°

æ¥ä¸‹æ¥å°†ä½¿ç”¨è¯·æ±‚é”çš„å¯é€‰å‚æ•°å®ç°ä»¥ä¸‹å†…å®¹ï¼š

## ä»å¼‚æ­¥ä»»åŠ¡è¿”å›å€¼

request() æ–¹æ³•æœ¬èº«è¿”å›ä¸€ä¸ª Promiseï¼Œä¸€æ—¦é”è¢«é‡Šæ”¾ï¼Œè¯¥ Promise å°±ä¼š resolveã€‚

```
<span></span><code><span>const</span>&nbsp;result&nbsp;=&nbsp;<span>await</span>&nbsp;navigator.locks.request(<span>'ccmama'</span>},&nbsp;<span>async</span>&nbsp;(lock)&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;<span>//&nbsp;ä»»åŠ¡</span><br>&nbsp;&nbsp;<span>return</span>&nbsp;data;<br>});<br><span>//&nbsp;æ‹¿åˆ°å†…éƒ¨å›è°ƒå‡½æ•°è¿”å›çš„&nbsp;data</span><br><span>console</span>.log(result);<br></code>
```

## å…±äº«é”å’Œç‹¬å é”æ¨¡å¼

é…ç½®é¡¹ mode é»˜è®¤æ˜¯ 'exclusive'ï¼Œå¯é€‰é¡¹è¿˜æœ‰ 'shared'ã€‚

> â
> 
> é”åªèƒ½æœ‰ä¸€ä¸ªæŒæœ‰è€…ï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶æˆæƒå¤šä¸ªå…±äº«ã€‚
> 
> åœ¨è¯»å†™æ¨¡å¼ä¸­ç»å¸¸ä½¿ç”¨ 'shared' æ¨¡å¼è¿›è¡Œè¯»å–ï¼Œ'exclusive' æ¨¡å¼ç”¨äºå†™å…¥ã€‚
> 
> â

```
<span></span><code>navigator.locks.request('ccmama', {<br>  mode: 'shared',<br>}, async (lock) =&gt; {<br>  // ä»»åŠ¡<br>});<br></code>
```

> â
> 
> ğŸ“¢
> 
> æŒæœ‰ 'exclusive' é”ï¼ŒåŒå 'exclusive' é”æ’é˜Ÿç­‰å€™
> 
> æŒæœ‰ 'exclusive' é”ï¼ŒåŒå 'shared' é”æ’é˜Ÿç­‰å€™
> 
> æŒæœ‰ 'shared' é”ï¼ŒåŒå 'shared' é”ä¹Ÿå¯è®¿é—®åŒä¸€èµ„æº
> 
> æŒæœ‰ 'shared' é”ï¼ŒåŒå 'exclusive' é”æ’é˜Ÿç­‰å€™
> 
> â

## æ¡ä»¶è·å–

é…ç½®é¡¹ ifAvailable é»˜è®¤ falseï¼Œå½“è®¾ç½® true æ—¶é”è¯·æ±‚ä»…åœ¨ä¸éœ€è¦æ’é˜Ÿæ—¶æ‰ä¼šè¢«æˆäºˆï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä»»åŠ¡æ²¡æœ‰å…¶ä»–ç­‰å¾…çš„æƒ…å†µä¸‹é”è¯·æ±‚æ‰ä¼šè¢«æˆäºˆï¼Œå¦åˆ™è¿”å› nullã€‚

```
<span></span><code>navigator.locks.request(<span>'ccmama'</span>,&nbsp;{&nbsp;<span>ifAvailable</span>:&nbsp;<span>true</span>&nbsp;},&nbsp;<span>async</span>&nbsp;lock&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;<span>if</span>&nbsp;(!lock)&nbsp;<span>return</span>;<br>&nbsp;&nbsp;<span>//&nbsp;ä»»åŠ¡</span><br>});<br></code>
```

> â
> 
> æ³¨æ„ï¼šåŒåé”
> 
> â

## é˜²æ­¢æ­»é”çš„åº”æ€¥é€šé“

é…ç½®é¡¹ steal é»˜è®¤ falseï¼Œå½“è®¾ç½®ä¸º true æ—¶ä»»ä½•æŒæœ‰çš„åŒåé”å°†è¢«é‡Šæ”¾ï¼Œå¹¶ä¸”è¯·æ±‚å°†è¢«æˆæƒï¼ŒæŠ¢å ä»»ä½•æ’é˜Ÿä¸­çš„é”è¯·æ±‚ã€‚

```
<span></span><code>navigator.locks.request(<span>'ccmama'</span>,&nbsp;{&nbsp;<span>steal</span>:&nbsp;<span>true</span>&nbsp;},&nbsp;<span>async</span>&nbsp;lock&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;<span>//&nbsp;ä»»åŠ¡</span><br>});<br></code>
```

> â
> 
> âš ï¸
> 
> ä½¿ç”¨è¦å°å¿ƒã€‚ä¹‹å‰åœ¨é”å†…è¿è¡Œçš„ä»£ç ä¼šç»§ç»­è¿è¡Œï¼Œå¹¶ä¸”å¯èƒ½ä¸ç°åœ¨æŒæœ‰é”çš„ä»£ç å‘ç”Ÿå†²çªã€‚
> 
> â

## ä¸­æ­¢é”å®šè¯·æ±‚

é…ç½®é¡¹ signal æ˜¯ AbortSignal ç±»å‹ï¼›å¦‚æœæŒ‡å®šå¹¶ä¸” AbortController è¢«ä¸­æ­¢ï¼Œåˆ™é”è¯·æ±‚å°†è¢«ä¸¢å¼ƒã€‚

```
<span></span><code><span>try</span>&nbsp;{<br>&nbsp;&nbsp;<span>const</span>&nbsp;controller&nbsp;=&nbsp;<span>new</span>&nbsp;AbortController();<br>&nbsp;&nbsp;setTimeout(<span><span>()</span>&nbsp;=&gt;</span>&nbsp;controller.abort(),&nbsp;<span>400</span>);<br>&nbsp;&nbsp;navigator.locks.request(<span>'ccmama'</span>,&nbsp;{&nbsp;<span>signal</span>:&nbsp;controller.signal&nbsp;},&nbsp;<span>async</span>&nbsp;lock&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;<span>//&nbsp;ä»»åŠ¡</span><br>&nbsp;&nbsp;});<br>}&nbsp;<span>catch</span>(ex)&nbsp;{}<br><br><span>//&nbsp;æˆ–</span><br><br><span>try</span>&nbsp;{<br>&nbsp;&nbsp;navigator.locks.request(<span>'ccmama'</span>,&nbsp;{&nbsp;<span>signal</span>:&nbsp;AbortSignal.timeout(<span>1000</span>)&nbsp;},&nbsp;<span>async</span>&nbsp;lock&nbsp;=&gt;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span>//&nbsp;ä»»åŠ¡</span><br>&nbsp;&nbsp;});<br>}&nbsp;<span>catch</span>(ex)&nbsp;{}<br></code>
```

> â
> 
> âš ï¸
> 
> è¶…æ—¶æ—¶ä¼šæŠ¥å‡ºä¸€ä¸ªå¼‚å¸¸é”™è¯¯ï¼Œéœ€è¦ä½¿ç”¨ try catch æ•è·
> 
> â

## å‚è€ƒæ–‡ç« 

-   MDN Web\_Locks\_APIæ–‡æ¡£
    
-   Web\_Lock ç§äººæ•´ç†æ–‡æ¡£
    
-   å…³äºstealçš„è®¨è®º
    
-   Web Locks API: è·¨ Tab èµ„æºåŒæ­¥
    
-   è¯»å†™é”
    

## å¯èƒ½ç†è§£å¹¶ä¸ä¸€å®šåˆ°ä½ï¼Œæ¬¢è¿äº¤æµã€‚