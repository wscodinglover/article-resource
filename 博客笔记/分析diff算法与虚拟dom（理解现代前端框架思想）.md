React 和 Vue 作为目前国内主力的前端开发框架，想必大家在日常的开发当中也是非常熟悉了。不可否认的它们的存在大大地提高了我们的开发效率以及使得我们的代码可维护性得到提高，但是使用它们的 “巧妙” 的之后，对技术有着追求的你，是不是应该了解一下这些框架背后的一些思想呢？如果还没有，没关系，我们一起来！  

本文全部代码小的已经上传 github🐶

## 虚拟 DOM

直观来说，虚拟 DOM 其实就是用数据结构表示真实的 DOM 结构。使用它的原因是，频繁的操作 DOM 会使得网站的性能下降，为了保证性能，我们需要使得 DOM 的操作尽量精简，我们可以通过操作虚拟 DOM 的方法，去比较新旧节点的差异然后精确的获取最小的，最为必要的 DOM 集合，最终挂载到真实的 DOM 上。因为操作数据结构，远比我们直接修改 DOM 节点来的快，我们真实的 DOM 操作在最好的情况下，其实只需要在最后来那么一下，不是吗

### 如何表示 DOM 结构

![Image](https://mmbiz.qpic.cn/mmbiz_png/5Xv0xlEBe9icXr1fP8s62z1icmQxkfmK6Uc92SOSThcz9biaCpTdtQuk8ibz9VBKgDJiaZJ97eEtkNT1or6ZV4E6Oog/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1) ![Image](https://mmbiz.qpic.cn/mmbiz_png/5Xv0xlEBe9icXr1fP8s62z1icmQxkfmK6UXjWcyiciaMfgMdPN8nypmcrOGbic2TSuvTsLtCEYS4Ro3IPA5rhI9wvJg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

这是一段列表的 DOM 结构，我们分析一下，其中需要包含的信息有

**1\. 标签类型 ul，li...**

**2\. 标签属性 class,style...**

**3\. 孩子节点 ul->li li->text ...**

无论再复杂的结构，也都是类似的，那么我们在找到 DOM 结构的共性之后，我们应该怎么表示呢

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

通过这张图我们可以发现，我们可以用对象 JS 对象轻易地就将它表示出来，几个属性也是非常好理解

-   tagName 对应真实的标签类型
    
-   attrs 表示节点上的所有属性
    
-   child 表示该节点的孩子节点
    

那这样我们是不是可以给这个虚拟 DOM 设定一个类 like this

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor=""><span data-darkreader-inline-color="">function</span>&nbsp;newElement(tag,attr,child){&nbsp;//创建对象函数<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;new&nbsp;Element(tag,attr,child)<br>}<br>复制代码<br></code>
```

**测试一下**

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

ok 没问题是不是，那现在虚拟 DOM 其实就已经被创建出来了，那么有了虚拟 DOM 之后怎么挂载到真实 DOM 上呢

### 生成真实 DOM 节点

首先我们会需要一个根据对象属性来设置标签属性的方法

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

然后我们在类的内部添加创建节点的 render 方法

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

到这里我们就可以通过使用 render 方法创建真实的 DOM 节点了，在方法内部，我们通过调用 SetVdToDom 方法对属性进行设置，然后对子节点进行类型判断，递归到最后剩下的文本节点。

最后我们通过一个 renderDom 方法将 dom 渲染到浏览器看看

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">//vdmock.js&nbsp;部分<br>const&nbsp;VdObj1&nbsp;=&nbsp;newElement(<span data-darkreader-inline-color="">'ul'</span>,{id:&nbsp;<span data-darkreader-inline-color="">'list'</span>},[<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-1'</span>,style:<span data-darkreader-inline-color="">'color:red'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'lavie'</span>]),<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-2'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'virtual&nbsp;dom'</span>]),<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-3'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'React'</span>]),&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-4'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'Vue'</span>])&nbsp;<br>])<br>const&nbsp;RealDom&nbsp;=&nbsp;VdObj1.render()<br>const&nbsp;renderDom&nbsp;=&nbsp;<span data-darkreader-inline-color="">function</span>(element,target){<br>&nbsp;&nbsp;&nbsp;&nbsp;target.appendChild(element)<br>}<br><span data-darkreader-inline-color="">export</span>&nbsp;default&nbsp;<span data-darkreader-inline-color="">function</span>&nbsp;<span><span data-darkreader-inline-color="">start</span></span>(){<br>&nbsp;&nbsp;&nbsp;renderDom(RealDom,document.body)<br>}<br><br>//&nbsp;index.html<br>&lt;!DOCTYPE&nbsp;html&gt;<br>&lt;html&nbsp;lang=<span data-darkreader-inline-color="">"en"</span>&gt;<br>&lt;head&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;charset=<span data-darkreader-inline-color="">"UTF-8"</span>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;script&nbsp;<span data-darkreader-inline-color="">type</span>=<span data-darkreader-inline-color="">"module"</span>&nbsp;src=<span data-darkreader-inline-color="">"./vdmock.js"</span>&nbsp;&nbsp;&gt;&lt;/script&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;Document&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&nbsp;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;script&nbsp;<span data-darkreader-inline-color="">type</span>=<span data-darkreader-inline-color="">"module"</span>&nbsp;&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;start&nbsp;from&nbsp;<span data-darkreader-inline-color="">'./vdmock.js'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start()<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/script&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>复制代码<br></code>
```

结果如下：

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

## 虚拟 DOM diff

通过上面方法，我们可以很简单的生成虚拟 DOM 并且将它渲染到浏览器上面，那么我们在用户进行操作之后，如何计算出前后虚拟 DOM 之间的差异呢？下面就来介绍一下 diff 算法

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

我们通过给 diff 传入新旧的两个节点通过内部的 getDiff 递归对比节点并存储变化然后返回，下面我们来实现一下 getDiff

### 获取最小差异数组

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">const&nbsp;REMOVE&nbsp;=&nbsp;<span data-darkreader-inline-color="">'remove'</span><br>const&nbsp;MODIFY_TEXT&nbsp;=&nbsp;&nbsp;<span data-darkreader-inline-color="">'modify_text'</span><br>const&nbsp;CHANGE_ATTRS&nbsp;=&nbsp;<span data-darkreader-inline-color="">'change_attrs'</span><br>const&nbsp;TAKEPLACE&nbsp;=&nbsp;<span data-darkreader-inline-color="">'replace'</span><br><span data-darkreader-inline-color="">let</span>&nbsp;initIndex&nbsp;=&nbsp;0<br>const&nbsp;getDiff&nbsp;=&nbsp;(oldNode,newNode,index,difference)=&gt;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;diffResult&nbsp;=&nbsp;[]<br>&nbsp;&nbsp;&nbsp;&nbsp;//新节点不存在的话说明节点已经被删除<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!newNode){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diffResult.push({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;REMOVE<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})&nbsp;//如果是文本节点直接替换就行<br>&nbsp;&nbsp;&nbsp;&nbsp;}<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>(typeof&nbsp;newNode&nbsp;===&nbsp;<span data-darkreader-inline-color="">'string'</span>&nbsp;&amp;&amp;&nbsp;typeof&nbsp;oldNode&nbsp;===&nbsp;<span data-darkreader-inline-color="">'string'</span>){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(oldNode&nbsp;!==&nbsp;newNode){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diffResult.push({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value:&nbsp;newNode,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;MODIFY_TEXT<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;//如果节点类型相同则则继续比较属性是否相同<br>&nbsp;&nbsp;&nbsp;&nbsp;}<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>(oldNode.tagName&nbsp;===&nbsp;newNode.tagName){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;storeAttrs&nbsp;=&nbsp;{}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>(<span data-darkreader-inline-color="">let</span>&nbsp;&nbsp;key&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;oldNode.attrs){&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(oldNode.attrs[key]&nbsp;!==&nbsp;newNode.attrs[key]){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storeAttrs[key]&nbsp;=&nbsp;newNode.attrs[key]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>&nbsp;(<span data-darkreader-inline-color="">let</span>&nbsp;key&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;newNode.attrs){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!oldNode.attrs.hasOwnProperty(key)){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storeAttrs[key]&nbsp;=&nbsp;newNode[key]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//判断是否有不同<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(Object.keys(storeAttrs).length&gt;0){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diffResult.push({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value:&nbsp;storeAttrs,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;CHANGE_ATTRS<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;//遍历子节点<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldNode.child.forEach((child,index)=&gt;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//深度遍历所以要保留index<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getDiff(child,newNode.child[index],++initIndex,difference)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//如果类型不相同，那么无需对比直接替换掉就行<br>&nbsp;&nbsp;&nbsp;&nbsp;}<span data-darkreader-inline-color="">else</span>&nbsp;<span data-darkreader-inline-color="">if</span>(oldNode.tagName&nbsp;!==&nbsp;newNode.tagName){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diffResult.push({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;TAKEPLACE,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newNode<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;//最后将结果返回<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(!oldNode){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;diffResult.push({<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">type</span>:&nbsp;TAKEPLACE,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newNode<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(diffResult.length){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;difference[index]&nbsp;=&nbsp;diffResult<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br><br>复制代码<br></code>
```

测试结果如下：

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

### 更新 dom

现在我们已经生成了两个虚拟 DOM, 并且将两个 DOM 之间的差异用对象的方式保存了下来，接下来，我们就要通过这些来将差异更新到真实的 DOM 上面去！！！

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**pace** 函数会自身进行递归，对当前节点的差异用 dofix 进行更新

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">const&nbsp;doFix&nbsp;=&nbsp;(node,difference)&nbsp;=&gt;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;difference.forEach(item=&gt;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(item.type){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">case</span>&nbsp;<span data-darkreader-inline-color="">'change_attrs'</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;attrs&nbsp;=&nbsp;item.value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">for</span>(&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;key&nbsp;<span data-darkreader-inline-color="">in</span>&nbsp;attrs&nbsp;){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(node.nodeType&nbsp;!==&nbsp;1)&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">return</span>&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;value&nbsp;=&nbsp;attrs[key]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">if</span>(value){<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetVdToDom(node,key,value)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span data-darkreader-inline-color="">else</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.removeAttribute(key)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">break</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">case</span>&nbsp;<span data-darkreader-inline-color="">'modify_text'</span>:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.textContent&nbsp;=&nbsp;item.value<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">break</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">case</span>&nbsp;<span data-darkreader-inline-color="">'replace'</span>:&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">let</span>&nbsp;newNode&nbsp;=&nbsp;(item.newNode&nbsp;instanceof&nbsp;Element)&nbsp;?&nbsp;item.newNode.render(item.newNode)&nbsp;:&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.createTextNode(item.newNode)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.parentNode.replaceChild(newNode,node)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">break</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">case</span>&nbsp;<span data-darkreader-inline-color="">'remove'</span>&nbsp;:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;node.parentNode.removeChild(node)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">break</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-darkreader-inline-color="">break</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>}<br><br>复制代码<br></code>
```

万事具备，那我们来测试一下！

```
<span data-darkreader-inline-bgcolor=""></span><code data-darkreader-inline-color="" data-darkreader-inline-bgimage="" data-darkreader-inline-bgcolor="">const&nbsp;VdObj1&nbsp;=&nbsp;newElement(<span data-darkreader-inline-color="">'ul'</span>,{id:&nbsp;<span data-darkreader-inline-color="">'list'</span>},[<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-1'</span>,style:<span data-darkreader-inline-color="">'color:red'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'lavie'</span>]),<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-2'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'virtual&nbsp;dom'</span>]),<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-3'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'React'</span>]),&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-4'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'Vue'</span>])&nbsp;,<br>])<br>const&nbsp;VdObj&nbsp;=&nbsp;newElement(<span data-darkreader-inline-color="">'ol'</span>,{id:&nbsp;<span data-darkreader-inline-color="">'list'</span>},[<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'h2'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-1'</span>,style:<span data-darkreader-inline-color="">'color:green'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'lavieee'</span>]),<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-2'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'virtual&nbsp;dom'</span>]),<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-3'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'React'</span>]),&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-4'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'Vue'</span>])&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-5'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'Dva'</span>])&nbsp;,<br>&nbsp;&nbsp;&nbsp;&nbsp;newElement(<span data-darkreader-inline-color="">'li'</span>,{class:&nbsp;<span data-darkreader-inline-color="">'list-5'</span>&nbsp;},&nbsp;[<span data-darkreader-inline-color="">'Dva'</span>])&nbsp;<br>&nbsp;<br>])<br>const&nbsp;RealDom&nbsp;=&nbsp;VdObj1.render()<br>const&nbsp;renderDom&nbsp;=&nbsp;<span data-darkreader-inline-color="">function</span>(element,target){<br>&nbsp;&nbsp;&nbsp;&nbsp;target.appendChild(element)<br>}<br><span data-darkreader-inline-color="">export</span>&nbsp;default&nbsp;<span data-darkreader-inline-color="">function</span>&nbsp;<span><span data-darkreader-inline-color="">start</span></span>(){<br>&nbsp;&nbsp;&nbsp;renderDom(RealDom,document.body)<br>&nbsp;&nbsp;&nbsp;const&nbsp;diffs&nbsp;=&nbsp;diff(VdObj1,VdObj)<br>&nbsp;&nbsp;&nbsp;fixPlace(RealDom,diffs)<br>}<br>复制代码<br></code>
```

**before**

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

**diff after**

![Image](data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E)

嘻嘻完美

通过这几个例子下来，其实虚拟 dom 的思想就已经可以实现了，我们在使用框架的过程中如果可以梳理清楚其中的核心概念，一定会走的更加踏实。