<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>批量写入100000个元素</title>
</head>

<body>
  <button onclick="add()">添加元素</button>
  <button onclick="remove()">删除元素</button>
  <div id="content"></div>
  <script>

    const tasks = Array.from({ length: 100000 }, (_, i) => {
      const div = document.createElement('div');
      div.innerText = i
      // 定义任务 0 添加  1 删除
      return [
        () => document.querySelector("#content").appendChild(div),
        () => div.remove()
      ]

    })

    function remove() {
      const scheduler = (runChunk) => {
        let count = 0
        // setTimeout(() => {
        //   runChunk(() => count++ < 10)
        // }, 300)

        requestIdleCallback((idle) => {
          runChunk(1, () => (idle.timeRemaining() > 0))
        })
      }


      performTask(tasks, scheduler)
    }

    function add() {
      const scheduler = (runChunk) => {
        let count = 0
        // setTimeout(() => {
        //   runChunk(() => count++ < 10)
        // }, 300)

        requestIdleCallback((idle) => {
          runChunk(0, () => (idle.timeRemaining() > 0))
        })
      }


      performTask(tasks, scheduler)
      // idlePerformTask(tasks)
    }

    // 分步执行
    function performTask(tasks, scheduler) {

      let taskId = 0
      function _run() {
        scheduler((action, isGoOn) => {

          // 条件：当前还有任务要执行 && 这一帧还有空闲时间可用
          while (taskId < tasks.length && isGoOn()) {
            tasks[taskId++][action]()
          }

          // 当前还有任务没有执行
          if (taskId < tasks.length) {
            _run()
          }
        })
      }

      _run()


    }

    //  定制scheduler
    function idlePerformTask(tasks) {
      performTask(tasks, (runChunk) => {
        let count = 0
        requestIdleCallback((idle) => {
          runChunk(() => (idle.timeRemaining() > 0 && count++ < 10))
        })
      })
    }

  </script>
</body>


</html>